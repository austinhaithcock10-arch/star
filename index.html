<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Five Nights At Epstein's</title>
    
<style>
html {
    width: 100%;
    height: 100%;
    overflow: hidden;
}

body {
    font-family: 'Arial', sans-serif;
    background: #000;
    overflow: hidden;
    color: #fff;
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    /* Á¶ÅÁî®ÊñáÊú¨ÈÄâÊã© */
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    /* Á¶ÅÁî®Ëß¶Êë∏Êó∂ÁöÑÈ´ò‰∫Æ */
    -webkit-tap-highlight-color: transparent;
    /* Á¶ÅÁî®ÊãñÊãΩ */
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
    user-drag: none;
}

/* Á¶ÅÁî®ÊâÄÊúâÂÖÉÁ¥†ÁöÑÈÄâÊã©ÂíåÊãñÊãΩ - ‰ΩøÁî®!importantÁ°Æ‰øù‰ºòÂÖàÁ∫ß */
* {
    user-select: none !important;
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
    -webkit-user-drag: none !important;
    -khtml-user-drag: none !important;
    -moz-user-drag: none !important;
    -o-user-drag: none !important;
    user-drag: none !important;
    -webkit-touch-callout: none !important;
}

/* ÁâπÂà´ÈíàÂØπÊñáÊú¨ÂÖÉÁ¥† */
div, span, p, h1, h2, h3, h4, h5, h6, button, a, label {
    user-select: none !important;
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
}

/* Á¶ÅÁî®ÂõæÁâáÊãñÊãΩ */
img {
    -webkit-user-drag: none !important;
    -khtml-user-drag: none !important;
    -moz-user-drag: none !important;
    -o-user-drag: none !important;
    user-drag: none !important;
    pointer-events: none;
}

/* Á°Æ‰øùÊåâÈíÆÂèØ‰ª•ÁÇπÂáª‰ΩÜ‰∏çËÉΩÈÄâÊã©ÊñáÊú¨ */
button {
    pointer-events: auto;
    cursor: pointer;
}

/* È¢ÑÂä†ËΩΩÂä®Áîª */
#preloader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    transition: opacity 0.5s ease-out;
}

#preloader.fade-out {
    opacity: 0;
    pointer-events: none;
}

.preloader-content {
    text-align: center;
    max-width: 500px;
    padding: 20px;
}

.preloader-logo {
    font-size: 3vw;
    font-weight: bold;
    color: #ff0000;
    text-shadow: 
        0 0 10px #ff0000,
        0 0 20px #ff0000,
        0 0 30px #ff0000,
        2px 2px 4px #000;
    margin-bottom: 40px;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.2em;
    line-height: 1.3;
    animation: glowPulse 2s ease-in-out infinite;
}

@keyframes glowPulse {
    0%, 100% {
        text-shadow: 
            0 0 10px #ff0000,
            0 0 20px #ff0000,
            0 0 30px #ff0000,
            2px 2px 4px #000;
    }
    50% {
        text-shadow: 
            0 0 20px #ff0000,
            0 0 30px #ff0000,
            0 0 40px #ff0000,
            0 0 50px #ff0000,
            2px 2px 4px #000;
    }
}

.preloader-spinner {
    position: relative;
    width: 80px;
    height: 80px;
    margin: 0 auto 30px;
}

.spinner-ring {
    position: absolute;
    width: 100%;
    height: 100%;
    border: 3px solid transparent;
    border-top-color: #ff0000;
    border-radius: 50%;
    animation: spin 1.5s linear infinite;
}

.spinner-ring:nth-child(2) {
    width: 70%;
    height: 70%;
    top: 15%;
    left: 15%;
    border-top-color: #cc0000;
    animation-duration: 1.2s;
    animation-direction: reverse;
}

.spinner-ring:nth-child(3) {
    width: 40%;
    height: 40%;
    top: 30%;
    left: 30%;
    border-top-color: #990000;
    animation-duration: 0.9s;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.preloader-text {
    font-size: 1.5vw;
    color: #fff;
    font-family: 'Courier New', monospace;
    margin-bottom: 20px;
    letter-spacing: 0.3em;
}

.loading-dots::after {
    content: '...';
    animation: loadingDots 1.5s steps(4, end) infinite;
}

@keyframes loadingDots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

.preloader-progress {
    width: 100%;
    height: 4px;
    background: #333;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ff0000, #cc0000);
    width: 0%;
    transition: width 0.3s ease;
    box-shadow: 0 0 10px #ff0000;
}

.preloader-percentage {
    font-size: 1.2vw;
    color: #888;
    font-family: 'Courier New', monospace;
}

/* ÈÄöÁî®ÈöêËóèÁ±ª */
.hidden {
    display: none !important;
}

/* Âä†ËΩΩÂä®Áîª */
.loading {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: #fff;
    font-family: 'Courier New', monospace;
    z-index: 1000;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

#game-container {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
}

/* Ê∏∏ÊàèÁîªÈù¢ */
#game-screen {
    width: 100%;
    height: 100%;
    position: relative;
    display: none;
    overflow: hidden;
    background: #000;
}

#game-screen.active {
    display: block;
}

#current-scene {
    position: absolute;
    height: 100%;
    width: 150%;
    object-fit: cover;
    left: 0;
    top: 0;
    transition: left 0.05s linear;
    display: block;
}

/* ÁÉ≠Âå∫ */
#hotspots {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.hotspot {
    position: absolute;
    cursor: pointer;
    pointer-events: auto;
    transition: opacity 0.2s;
}

.hotspot:hover {
    opacity: 0.8;
}

/* UI Ë¶ÜÁõñÂ±Ç */
#ui-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

/* Â∑¶‰∏äËßí UI */
#top-left-ui {
    position: absolute;
    top: 2vh;
    left: 2vw;
    color: white;
    text-shadow: 2px 2px 4px #000;
}

#time-display {
    font-size: 2.5vw;
    margin-bottom: 0.5vh;
}

#night-display {
    font-size: 1.5vw;
    color: #ccc;
}

/* Âè≥‰∏ãËßí UI */
#bottom-right-ui {
    position: absolute;
    bottom: 2vh;
    right: 2vw;
    color: white;
    text-shadow: 2px 2px 4px #000;
}

#oxygen-display {
    display: flex;
    align-items: center;
    gap: 0;
    font-size: 2vw;
    font-weight: bold;
}

#oxygen-display .vent-icon {
    margin-right: 1vw;
}

#power-value {
    margin: 0;
}

.percent-sign {
    margin-left: 0.1vw;
    margin-right: 0;
}

.oxygen-unit {
    margin-left: 1.2vw;
    display: inline-flex;
    align-items: baseline;
}

#oxygen-display sub {
    font-size: 1vw;
    vertical-align: sub;
    line-height: 0;
}

.vent-icon {
    width: 3vw;
    height: 3vw;
    object-fit: contain;
    transition: none; /* Á¶ÅÁî®ÈªòËÆ§ËøáÊ∏°Ôºå‰ΩøÁî®animation */
    animation: spin-fast 0.333s linear infinite; /* ÈªòËÆ§Âø´ÈÄüÊóãËΩ¨ÔºàÈÄöÈ£éÂè£ÂºÄÂêØÔºâ- 1Áßí3Âúà */
}

/* È£éÊâáÊóãËΩ¨Âä®Áîª - Âø´ÈÄüÔºàÈÄöÈ£éÂè£ÂºÄÂêØÔºâ */
@keyframes spin-fast {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* È£éÊâáÊóãËΩ¨Âä®Áîª - ÊÖ¢ÈÄüÔºàÂáèÈÄü‰∏≠Ôºâ */
@keyframes spin-slow {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* È£éÊâáÂÅúÊ≠¢Áä∂ÊÄÅ */
.vent-icon.stopped {
    animation: none;
}

/* È£éÊâáÂáèÈÄüÁä∂ÊÄÅ */
.vent-icon.slowing {
    animation: spin-slow 3s linear infinite;
}

/* È£éÊâáÂä†ÈÄüÁä∂ÊÄÅ */
.vent-icon.speeding-up {
    animation: spin-slow 3s linear infinite;
}
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* Ê∏∏ÊàèÊåâÈíÆ */
.game-button {
    position: absolute;
    width: 8vw;
    height: 8vh;
    background: rgba(255, 0, 0, 0.1);
    border: 2px solid rgba(255, 0, 0, 0.3);
    cursor: pointer;
    transition: all 0.3s;
    pointer-events: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.game-button:hover {
    background: rgba(255, 0, 0, 0.3);
    border-color: rgba(255, 0, 0, 0.8);
    box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
}

.game-button .button-hint {
    opacity: 0;
    color: white;
    font-size: 1.2vw;
    font-weight: bold;
    text-shadow: 2px 2px 4px #000;
    transition: opacity 0.3s;
    pointer-events: none;
}

.game-button:hover .button-hint {
    opacity: 1;
}

/* Â∑¶‰∏ãËßíÔºöÊéßÂà∂Èù¢ÊùøÊåâÈíÆ */
#control-panel-btn {
    bottom: 2vh;
    left: 2vw;
}

/* Âè≥‰æß‰∏≠Èó¥ÔºöÊëÑÂÉèÂ§¥ÊåâÈíÆ */
#camera-btn {
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    height: 15vh;
    width: 5vw;
}

/* ÊëÑÂÉèÂ§¥Èù¢Êùø - ‰ªéÂè≥ÂæÄÂ∑¶ÊªëÂÖ• + Áº©ÊîæÊïàÊûú */
#camera-panel {
    position: absolute;
    top: 5vh;
    right: 7vw;
    width: 70vw;
    height: calc(70vw * 0.75); /* ‰øùÊåÅ4:3ÂÆΩÈ´òÊØî */
    max-height: 80vh; /* ‰ΩÜ‰∏çË∂ÖËøá80vh */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-color: #000;
    z-index: 20;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-end;
    padding: 0;
    transform: translateX(calc(100% + 7vw)) scale(0.5);
    transform-origin: right center;
    transition: transform 0.4s ease-in-out;
    border: 3px solid #444;
    box-shadow: -5px 0 20px rgba(0, 0, 0, 0.7);
    opacity: 0;
    overflow: hidden; /* Èò≤Ê≠¢EPÂõæÁâáÊ∫¢Âá∫Âà∞ÊëÑÂÉèÂ§¥Èù¢ÊùøÂ§ñ */
}

#camera-panel.show {
    transform: translateX(0) scale(1);
    opacity: 1;
}

#camera-panel.closing {
    transform: translateX(calc(100% + 7vw)) scale(0.5);
    opacity: 0;
}

#camera-panel.transitioning {
    background-image: none !important;
}

/* ÂΩìÂâçÊëÑÂÉèÂ§¥Ê†áÁ≠æ */
#current-cam-label {
    position: absolute;
    top: 15px;
    left: 15px;
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    font-family: Arial, sans-serif;
    text-shadow: 2px 2px 4px #000;
    z-index: 1;
}

/* ËßíËâ≤ÂõæÂ±ÇÂÆπÂô® */
#character-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
}

#character-overlay img {
    position: absolute;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    opacity: 0;
    transition: opacity 0.3s;
}

#character-overlay img.visible {
    opacity: 1;
}

/* ÊëÑÂÉèÂ§¥ÂàáÊç¢ÈùôÊÄÅÂô™ÁÇπ */
#camera-static-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
    z-index: 2;
    opacity: 0;
    transition: opacity 0.2s;
    display: none;
}

#camera-static-video.active {
    display: block;
    opacity: 0.8;
}

/* ÊëÑÂÉèÂ§¥ÊïÖÈöúÊ†áËØÜ */
#camera-error-label {
    position: absolute;
    top: 15px;
    right: 25px;
    font-size: 48px;
    font-weight: bold;
    color: #f00;
    font-family: Arial, sans-serif;
    text-shadow: 2px 2px 4px #000;
    z-index: 3;
    display: none;
}

#camera-error-label.active {
    display: block;
    /* ÁßªÈô§Èó™ÁÉÅÂä®Áîª */
}

/* Âú∞ÂõæÂÆπÂô® - ÁßªÂà∞Â∑¶‰∏ãËßí */
#camera-grid {
    position: absolute;
    bottom: 15px;
    left: 15px;
    width: 28vw;
    max-width: 380px;
    z-index: 1;
}

.camera-hotspot {
    position: absolute;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
}

.camera-hotspot:hover {
    transform: scale(1.05);
}

/* ÈÄâ‰∏≠ÁöÑÊëÑÂÉèÂ§¥ÁªøËâ≤Èó™ÁÉÅÂä®Áîª */
.camera-selected {
    animation: greenPulse 1s ease-in-out infinite;
}

@keyframes greenPulse {
    0%, 100% {
        background: rgba(0, 255, 0, 0.6);
    }
    50% {
        background: rgba(0, 255, 0, 0.2);
    }
}

/* ELECTROCUTE ÊåâÈíÆÔºàÈúçÈáëÁîµÂáªÔºâ - Âè™Âú®cam6ÊòæÁ§∫ */
#shock-hawking-btn {
    position: absolute;
    bottom: 100px;
    right: 25px;
    width: 280px;
    padding: 20px 0;
    font-size: 24px;
    background: rgba(0, 0, 0, 0.7);
    border: 3px solid #fff;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s;
    font-family: Arial, sans-serif;
    font-weight: bold;
    letter-spacing: 4px;
    z-index: 1;
    text-align: center;
    display: none; /* ÈªòËÆ§ÈöêËóè */
    box-sizing: border-box;
}

#shock-hawking-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
}

#shock-hawking-btn:active {
    transform: scale(0.95);
}

/* PLAY SOUND ÊåâÈíÆ */
#play-sound-btn {
    position: absolute;
    bottom: 25px;
    right: 25px;
    width: 280px;
    padding: 20px 0;
    font-size: 24px;
    background: rgba(0, 0, 0, 0.7);
    border: 3px solid #fff;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s;
    font-family: Arial, sans-serif;
    font-weight: bold;
    letter-spacing: 4px;
    z-index: 1;
    text-align: center;
    box-sizing: border-box;
}

#play-sound-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
}

/* ÊëÑÂÉèÂ§¥ÂÖ≥Èó≠ÊåâÈíÆ - ÊâãÊú∫Á´ØÊòæÁ§∫ */
#close-camera {
    display: none;
}

/* ‰∏ªËèúÂçï */
#main-menu {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('assets/images/menubackground.png') center/cover;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: center;
    padding-left: 5%;
    z-index: 100;
}

/* ÊòüÊòüÂõæÊ†á - ÊîæÂú®‰∏≠Èó¥ÂÅè‰∏ä‰ΩçÁΩÆ */
#star-icon {
    position: absolute;
    top: 15vh;
    left: 50%;
    transform: translateX(-50%);
    width: 5vw;
    max-width: 80px;
    height: auto;
    z-index: 103;
    animation: star-glow 2s ease-in-out infinite;
}

/* Á¨¨‰∫åÈ¢óÊòüÊòü - Âú®Á¨¨‰∏ÄÈ¢ó‰∏ãÈù¢ */
#star-icon-2 {
    position: absolute;
    top: 22vh; /* ÊØîÁ¨¨‰∏ÄÈ¢ó‰Ωé7vh */
    left: 50%;
    transform: translateX(-50%);
    width: 5vw;
    max-width: 80px;
    height: auto;
    z-index: 103;
    animation: star-glow 2s ease-in-out infinite 0.5s; /* Âª∂Ëøü0.5sÔºå‰∫ßÁîü‰∫§ÊõøÈó™ÁÉÅÊïàÊûú */
}

@keyframes star-glow {
    0%, 100% {
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        transform: translateX(-50%) scale(1);
    }
    50% {
        filter: drop-shadow(0 0 20px rgba(255, 215, 0, 1));
        transform: translateX(-50%) scale(1.05);
    }
}

/* Golden ÈúçÈáëÈó™ÁÉÅÂä®Áîª */
@keyframes golden-flicker {
    0% {
        opacity: 0;
    }
    10% {
        opacity: 1;
    }
    20% {
        opacity: 0;
    }
    30% {
        opacity: 1;
    }
    40% {
        opacity: 0.5;
    }
    50% {
        opacity: 1;
    }
    60% {
        opacity: 0.8;
    }
    70% {
        opacity: 1;
    }
    80% {
        opacity: 0.6;
    }
    90% {
        opacity: 1;
    }
    100% {
        opacity: 0;
    }
}

/* ÈùôÊÄÅÈõ™Ëä±ÊïàÊûú - ‰ΩøÁî® canvas */
#static-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 101;
    opacity: 0.5; /* Â¢ûÂº∫ÈÄèÊòéÂ∫¶Ôºå‰ªé 0.25 ÊîπÊàê 0.5 */
    mix-blend-mode: screen; /* ÊîπÁî® screen Ê®°ÂºèÔºåÊõ¥ÊòéÊòæ */
}

#main-menu > h1,
#main-menu > button,
#main-menu > img {
    position: relative;
    z-index: 102;
}

#main-menu h1 {
    font-size: 5vw;
    margin-bottom: 5vh;
    text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.8);
    color: #fff;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    letter-spacing: 2px;
    line-height: 1.2;
}

#main-menu button {
    width: 20vw;
    min-width: 200px;
    padding: 1.5vh 2vw;
    margin: 1.5vh 0;
    font-size: 1.8vw;
    background: transparent;
    border: none;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    letter-spacing: 3px;
    white-space: nowrap;
}

#main-menu button::before {
    content: '> ';
    opacity: 0;
    transition: opacity 0.2s;
}

#main-menu button:hover::before,
#main-menu button:focus::before {
    opacity: 1;
}

#main-menu button:hover {
    transform: translateX(10px);
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
}

/* ÁâπÊÆäÂ§úÊôöÊåâÈíÆ */
#special-night-btn {
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
}

/* ÊÅêÊÄñËÑ∏Èó™ÁÉÅÊïàÊûú - ‰∏çÂÜçÈúÄË¶ÅÔºåÊîπÁî®ËÉåÊôØÂõæÂàáÊç¢ */
.copyright {
    position: absolute;
    bottom: 2vh;
    left: 2vw;
    font-size: 1.2vw;
    color: #888;
    font-family: 'Courier New', monospace;
    z-index: 102;
}

.reset-hint {
    position: absolute;
    bottom: 2vh;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.8vw;
    color: #888;
    font-family: 'Courier New', monospace;
    z-index: 102;
}

.version {
    position: absolute;
    bottom: 2vh;
    right: 8vw;
    font-size: 1.8vw;
    color: #ccc;
    font-family: 'Courier New', monospace;
    z-index: 102;
    font-weight: bold;
}

/* Ê∏∏ÊàèÁªìÊùü */
#game-over {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100000;
    overflow: hidden;
}

/* Èõ™Ëä±ËßÜÈ¢ëËÉåÊôØ */
#game-over-static {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 1;
    opacity: 0.8;
}

/* Ê∏∏ÊàèÁªìÊùüÂÜÖÂÆπÂ±Ç */
#game-over-content {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

#game-over h2 {
    font-size: 8vw;
    margin-bottom: 2vh;
    color: #ff0000;
    text-shadow: 
        0 0 10px #ff0000,
        0 0 20px #ff0000,
        0 0 30px #ff0000,
        3px 3px 6px #000;
    font-weight: bold;
    letter-spacing: 0.1em;
}

#game-over-subtitle {
    font-size: 1.8vw;
    margin-bottom: 4vh;
    color: #ff0000;
    font-style: italic;
    text-align: center;
    padding: 0 2vw;
    text-shadow: 
        0 0 5px #ff0000,
        0 0 10px #ff0000,
        2px 2px 4px #000;
    font-weight: bold;
}

#game-over button {
    width: 20vw;
    min-width: 200px;
    padding: 1.5vh 2vw;
    margin: 1vh 0;
    font-size: 1.5vw;
    background: #333;
    border: 2px solid #666;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s;
}

#game-over button:hover {
    background: #555;
    border-color: #fff;
}

/* Ê∏∏ÊàèÊïôÁ®ãÊèêÁ§∫ */
#tutorial-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

#tutorial-content {
    background: rgba(30, 30, 30, 0.95);
    border: 3px solid #666;
    padding: 4vh 5vw;
    max-width: 60vw;
    text-align: center;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
}

#tutorial-content h2 {
    font-size: 3vw;
    margin-bottom: 3vh;
    color: #fff;
    text-shadow: 2px 2px 4px #000;
    letter-spacing: 0.1em;
}

#tutorial-content p {
    font-size: 1.4vw;
    line-height: 1.8;
    color: #ddd;
    margin-bottom: 3vh;
    text-align: left;
}

#tutorial-got-it {
    width: 15vw;
    min-width: 150px;
    padding: 1.5vh 3vw;
    font-size: 1.8vw;
    background: #555;
    border: 2px solid #888;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
    letter-spacing: 0.2em;
}

#tutorial-got-it:hover {
    background: #777;
    border-color: #fff;
    transform: scale(1.05);
}

/* ÈöêËóèÁ±ª */
.hidden {
    display: none !important;
}


/* Èó™ÁÉÅÊïàÊûú */
@keyframes flicker {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.flicker {
    animation: flicker 0.1s infinite;
}

/* Ë≠¶ÂëäÈó™ÁÉÅÂä®Áîª */
@keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* Âä†ËΩΩÁÇπÂä®Áîª */
@keyframes loadingDots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

.loading-dots {
    animation: loadingDots 1s infinite;
}

/* ËøáÂú∫Âä®Áîª */
#cutscene {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    cursor: pointer;
    opacity: 0;
    transition: opacity 3s ease-in-out;
}

#cutscene.fade-in {
    opacity: 1;
}

#cutscene.fade-out {
    opacity: 0;
}

#cutscene img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.cutscene-hint {
    position: absolute;
    bottom: 5vh;
    left: 50%;
    transform: translateX(-50%);
    color: #fff;
    font-size: 1.5vw;
    font-family: 'Courier New', monospace;
    animation: pulse 1.5s infinite;
}

/* ÊØèÊôöÂºÄÂßãÂú∫ÊôØ */
#night-intro {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    opacity: 0;
    transition: opacity 1.5s ease-in-out;
}

#night-intro.fade-in {
    opacity: 1;
}

#night-intro.fade-out {
    opacity: 0;
}

#night-intro-text {
    font-size: 8vw;
    color: #fff;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    letter-spacing: 0.5vw;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    z-index: 1;
}

/* ÁîµÁúºÈó™ÁÉÅÂä®Áîª (Night 6) */
@keyframes lightning-flicker {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
}

@keyframes lightning-pulse {
    0%, 100% { 
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    50% { 
        transform: translate(-50%, -50%) scale(1.1);
        opacity: 0.9;
    }
}

@keyframes lightning-bolt {
    0%, 100% { 
        opacity: 0;
        transform: translate(-50%, -50%) rotate(var(--rotation)) scaleY(0.5);
    }
    10%, 20% { 
        opacity: 1;
        transform: translate(-50%, -50%) rotate(var(--rotation)) scaleY(1);
    }
    30% { 
        opacity: 0;
        transform: translate(-50%, -50%) rotate(var(--rotation)) scaleY(0.8);
    }
}

.lightning-eye-effect {
    animation: lightning-flicker 0.1s infinite;
}

/* Mobile Portrait */
@media (max-width: 768px) and (orientation: portrait) {
    /* Preloader mobile styles */
    .preloader-logo {
        font-size: 6vw;
    }
    
    .preloader-text {
        font-size: 3.5vw;
    }
    
    .preloader-percentage {
        font-size: 3vw;
    }
    
    /* Increase touch target sizes */
    .control-panel-button,
    .camera-button {
        min-width: 60px !important;
        min-height: 60px !important;
    }
    
    /* Adjust UI text sizes for mobile */
    #top-left-ui {
        top: 1vh;
        left: 2vw;
    }
    
    #time-display {
        font-size: 4vw;
    }
    
    #night-display {
        font-size: 3vw;
    }
    
    #bottom-right-ui {
        bottom: 1vh;
        right: 2vw;
    }
    
    #oxygen-display {
        font-size: 4vw;
    }
    
    .vent-icon {
        width: 5vw;
        height: 5vw;
    }
    
    /* Camera panel adjustments */
    #camera-panel {
        width: 90vw;
        height: 70vh;
        right: 5vw;
        top: 10vh;
    }
    
    #current-cam-label {
        font-size: 18px;
        top: 10px;
        left: 10px;
    }
    
    #camera-error-label {
        font-size: 36px;
        top: 10px;
        right: 15px;
    }
    
    #camera-grid {
        width: 40vw;
        max-width: none;
        bottom: 10px;
        left: 10px;
    }
    
    #play-sound-btn {
        width: 180px;
        padding: 10px 0;
        font-size: 14px;
        bottom: 15px;
        right: 15px;
        letter-spacing: 2px;
    }
    
    #shock-hawking-btn {
        width: 180px;
        padding: 10px 0;
        font-size: 14px;
        bottom: 70px;
        right: 15px;
        letter-spacing: 2px;
    }
    
    /* Control panel popup */
    #control-panel-popup {
        width: 85vw !important;
        left: 7.5vw !important;
        top: 15vh !important;
        min-height: 50vh !important;
        font-size: 3.5vw !important;
    }
    
    #control-panel-popup h3 {
        font-size: 4vw !important;
    }
    
    .control-row input {
        font-size: 3vw !important;
    }
    
    /* Main menu - ‰øÆÂ§çÁßªÂä®Á´ØÊåâÈíÆÁÇπÂáªÈóÆÈ¢ò */
    #main-menu {
        padding-left: 8%;
        padding-right: 8%;
        align-items: center;
    }
    
    #star-icon {
        width: 12vw;
        max-width: 60px;
        top: 10vh;
    }
    
    #star-icon-2 {
        width: 12vw;
        max-width: 60px;
        top: 18vh; /* ÊØîÁ¨¨‰∏ÄÈ¢ó‰Ωé8vh */
    }
    
    #main-menu h1 {
        font-size: 10vw;
        margin-bottom: 8vh;
        text-align: center;
        width: 100%;
    }
    
    #main-menu button {
        font-size: 5vw;
        width: 70vw;
        max-width: 400px;
        padding: 3vh 6vw;
        margin: 2vh 0;
        text-align: center;
        min-height: 60px;
        touch-action: manipulation;
        -webkit-tap-highlight-color: rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 103;
    }
    
    #main-menu button::before {
        content: '';
        opacity: 0;
    }
    
    #main-menu button:hover::before,
    #main-menu button:focus::before {
        opacity: 0;
    }
    
    #main-menu button:active {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(0.98);
    }
    
    .copyright {
        font-size: 2.5vw;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        width: 90%;
    }
    
    .reset-hint {
        font-size: 2.5vw;
    }
    
    .version {
        font-size: 2.5vw;
    }
    
    /* Game over screen */
    #game-over h2 {
        font-size: 12vw;
    }
    
    #game-over-subtitle {
        font-size: 3.5vw;
    }
    
    #game-over button {
        font-size: 4vw;
        width: 60vw;
        padding: 2vh 4vw;
    }
    
    /* Tutorial */
    #tutorial-content {
        max-width: 85vw;
        padding: 3vh 4vw;
    }
    
    #tutorial-content h2 {
        font-size: 5vw;
    }
    
    #tutorial-content p {
        font-size: 3.5vw;
    }
    
    #tutorial-got-it {
        font-size: 4vw;
        width: 40vw;
        padding: 2vh 4vw;
    }
    
    /* Night intro */
    #night-intro-text {
        font-size: 12vw;
    }
    
    .cutscene-hint {
        font-size: 3.5vw;
    }
}

/* Mobile Landscape - Ê®™Â±è‰ºòÂåñ */
@media (max-width: 926px) and (orientation: landscape) {
    /* Preloader mobile styles */
    .preloader-logo {
        font-size: 4vh;
    }
    
    .preloader-text {
        font-size: 2vh;
    }
    
    .preloader-percentage {
        font-size: 2vh;
    }
    
    /* Ê®™Â±èÊó∂Â¢ûÂ§ßÊëÑÂÉèÂ§¥ÊåâÈíÆÂπ∂Á°Æ‰øùÂèØËßÅ */
    #camera-btn {
        width: 70px !important;
        height: 60vh !important;
        min-width: 70px !important;
        min-height: 200px !important;
        background: rgba(0, 0, 0, 0.95) !important;
        border: 3px solid rgba(255, 255, 255, 0.7) !important;
        border-right: none !important;
        z-index: 25 !important;
        top: 30vh !important;
        transform: translateY(0) !important;
    }
    
    #camera-btn .camera-arrow {
        font-size: 20px !important;
    }
    
    #camera-btn div[style*="CAMERA"] {
        font-size: 14px !important;
    }
    
    /* UI adjustments for landscape */
    #top-left-ui {
        top: 1vh;
        left: 1vw;
    }
    
    #time-display {
        font-size: 3vh;
    }
    
    #night-display {
        font-size: 2vh;
    }
    
    #bottom-right-ui {
        bottom: 1vh;
        right: 1vw;
    }
    
    #oxygen-display {
        font-size: 3vh;
    }
    
    .vent-icon {
        width: 4vh;
        height: 4vh;
    }
    
    /* Camera panel - Ê®™Â±èÊó∂‰∏çÂç†Êª°Â±èÂπïÔºåÁïôÂá∫Âè≥‰æßÁ©∫Èó¥ */
    #camera-panel {
        width: calc(100vw - 70px);
        height: 100vh;
        right: 70px;
        top: 0;
        border: none;
        border-right: 3px solid #444;
    }
    
    #current-cam-label {
        font-size: 2.5vh;
        top: 1vh;
        left: 1vw;
    }
    
    #camera-error-label {
        font-size: 5vh;
        top: 1vh;
        right: 2vw;
    }
    
    /* Camera grid - Ê®™Â±èÊó∂Áº©Â∞èÂπ∂ÁßªÂà∞Â∑¶‰∏ãËßí */
    #camera-grid {
        width: 25vw;
        max-width: 280px;
        bottom: 1vh;
        left: 1vw;
    }
    
    /* Ê®™Â±èÊó∂Ë∞ÉÊï¥ÊåâÈíÆÂ∏ÉÂ±Ä */
    #play-sound-btn {
        width: 180px;
        padding: 2vh 0;
        font-size: 2.5vh;
        bottom: 2vh;
        right: 2vw;
        letter-spacing: 2px;
    }
    
    #shock-hawking-btn {
        width: 180px;
        padding: 2vh 0;
        font-size: 2.5vh;
        bottom: 10vh;
        right: 2vw;
        letter-spacing: 2px;
    }
    
    /* Main menu landscape */
    #main-menu {
        padding-left: 5%;
        align-items: flex-start;
    }
    
    #main-menu h1 {
        font-size: 6vh;
        margin-bottom: 3vh;
        text-align: left;
    }
    
    #main-menu button {
        font-size: 2.5vh;
        width: 30vw;
        min-width: 200px;
        padding: 1.5vh 3vw;
        margin: 1vh 0;
        min-height: 50px;
    }
    
    .copyright,
    .reset-hint,
    .version {
        font-size: 1.5vh;
    }
    
    /* Game over screen landscape */
    #game-over h2 {
        font-size: 8vh;
    }
    
    #game-over-subtitle {
        font-size: 2vh;
    }
    
    #game-over button {
        font-size: 2.5vh;
        width: 30vw;
        padding: 1.5vh 3vw;
        min-height: 50px;
    }
    
    /* Tutorial - Ê®™Â±èÊó∂Â§ßÂπÖÁº©Â∞è */
    #tutorial-content {
        max-width: 70vw;
        max-height: 85vh;
        padding: 2vh 3vw;
        overflow-y: auto;
    }
    
    #tutorial-content h2 {
        font-size: 2.5vh;
        margin-bottom: 1.5vh;
    }
    
    #tutorial-content p {
        font-size: 1.6vh;
        line-height: 1.5;
        margin-bottom: 2vh;
    }
    
    #tutorial-got-it {
        font-size: 2vh;
        width: 20vw;
        min-width: 120px;
        padding: 1.5vh 3vw;
        min-height: 45px;
    }
    
    /* Night intro landscape */
    #night-intro-text {
        font-size: 8vh;
    }
    
    .cutscene-hint {
        font-size: 2vh;
    }
}

/* Prevent text selection on touch devices */
@media (hover: none) and (pointer: coarse) {
    * {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    input, textarea {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
}

/* Touch feedback */
@media (hover: none) and (pointer: coarse) {
    .hotspot:active,
    .control-panel-button:active,
    .camera-button:active,
    button:active {
        opacity: 0.7;
        transform: scale(0.95);
    }
}

</style>
</head>
<body>

    <div id="preloader">
        <div class="preloader-content">
            <div class="preloader-logo">FIVE NIGHTS<br>AT EPSTEIN'S</div>
            <div class="preloader-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <div class="preloader-text">LOADING<span class="loading-dots">...</span></div>
            <div class="preloader-progress">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="preloader-percentage" id="preloader-percentage">0%</div>
        </div>
    </div>

    <div id="game-container">
   
        <div id="game-screen">
            <img id="current-scene" src="" alt="" style="display: none;">
            
       
            <div id="hotspots"></div>
            
      
            <div id="ui-overlay">
            
                <div id="top-left-ui">
                    <div id="time-display"><span id="time-value">12 AM</span></div>
                    <div id="night-display">NIGHT <span id="night-value">1</span></div>
                </div>
                
         
                <div id="bottom-right-ui">
                    <div id="oxygen-display">
                        <img src="assets/images/fa3.png" alt="Vent" class="vent-icon">
                        <span id="power-value">100</span><span class="percent-sign">%</span><span class="oxygen-unit">O<sub>2</sub></span>
                    </div>
                </div>
            </div>
        </div>


        <div id="camera-panel" class="hidden">
            <div id="current-cam-label">CAM 11</div>
            <div id="camera-error-label">ERR</div>
  
            <div id="character-overlay"></div>
            <div id="camera-grid"></div>
            <button id="shock-hawking-btn">ELECTROCUTE</button>
            <button id="play-sound-btn">PLAY SOUND</button>
       
            <video id="camera-static-video" loop muted playsinline>
                <source src="assets/vedio/202512191935.webm" type="video/webm">
            </video>
        </div>


        <div id="cutscene" class="hidden">
            <img src="assets/images/cutscene.png" alt="Cutscene">
            <div class="cutscene-hint">Click to continue...</div>
        </div>

  
        <div id="night-intro" class="hidden">
            <div id="night-intro-text">NIGHT 1</div>
        </div>


        <div id="main-menu">
            <img id="star-icon" class="hidden" src="assets/images/star.png" alt="Star">
            <img id="star-icon-2" class="hidden" src="assets/images/star.png" alt="Star 2">
            <h1>FIVE<br>NIGHTS<br>AT<br>EPSTEIN'S</h1>
            <button id="start-game">NEW GAME</button>
            <button id="continue-game" class="hidden">CONTINUE</button>
            <button id="special-night-btn" class="hidden">EPSTEIN'S SPECIAL NIGHT</button>
            <div class="copyright">¬© EVAN PRODUCTIONS</div>
            <div class="version">v1.1.5</div>
        </div>
        
    
        <canvas id="static-canvas"></canvas>
        
 
        <audio id="menu-music" loop>
            <source src="assets/sounds/music3.ogg" type="audio/ogg">
        </audio>

    
        <div id="game-over" class="hidden">
         
            <video id="game-over-static" loop muted playsinline autoplay>
                <source src="assets/vedio/202512191935.webm" type="video/webm">
            </video>
            <div id="game-over-content">
                <h2 id="game-over-text"></h2>
                <p id="game-over-subtitle" class="hidden"></p>
                <button id="restart">Restart</button>
                <button id="main-menu-btn">Main Menu</button>
            </div>
        </div>

       
        <div id="tutorial-overlay" class="hidden">
            <div id="tutorial-content">
                <h2>DEFEND YOURSELF AGAINST EPSTEIN</h2>
                <p>
                    EPSTEIN ALWAYS STARTS AT CAM 11. USE THE CAMERA'S AUDIO LURE TO KEEP EPSTEIN FAR AWAY FROM YOU. 
                    MAKE SURE THE CAMERA YOU'RE PLAYING THE SOUND IN IS NEXT TO THE CAMERA WHERE EPSTEIN IS. 
                    PLAYING SOUND IN ONLY ONE SPOT WILL NOT WORK IF YOU DO IT TWICE OR MORE IN A ROW. 
                    USING THE AUDIO LURE TOO MUCH WILL LEAD TO THE CAMERAS BREAKING. 
                    TO FIX THEM HEAD TO THE CONTROL PANEL AND RESTART THE CAMERAS LIKE YOU JUST DID. 
                    EPSTEIN DOES NOT ATTACK THROUGH THE VENTS SO DON'T BOTHER CLOSING THEM FOR THIS NIGHT.
                </p>
                <button id="tutorial-got-it">GOT IT</button>
            </div>
        </div>
    </div>

    
    
    
    
    
    
    
    
    
    

<script>
// ËµÑÊ∫êÁÆ°ÁêÜÂô®
class AssetManager {
    constructor() {
        this.images = {};
        this.sounds = {};
        this.loaded = false;
    }

    async loadAssets() {
        // Ëé∑ÂèñÂΩìÂâçËÑöÊú¨ÁöÑÂü∫Á°ÄË∑ØÂæÑ
        const basePath = this.getBasePath();
        
        // ‰ªé Unity ÊèêÂèñÁöÑËµÑÊ∫ê
        const imagePaths = {
            office: `${basePath}assets/images/original.png`,
            cam1: `${basePath}assets/images/Cam1.png`,
            cam2: `${basePath}assets/images/Cam2.png`,
            cam3: `${basePath}assets/images/Cam3.png`,
            cam4: `${basePath}assets/images/Cam4.png`,
            cam5: `${basePath}assets/images/Cam5.png`,
            cam6: `${basePath}assets/images/Cam6.png`,
            cam7: `${basePath}assets/images/Cam7.png`,
            cam8: `${basePath}assets/images/Cam8.png`,
            cam9: `${basePath}assets/images/Cam9.png`,
            cam10: `${basePath}assets/images/Cam10.png`,
            cam11: `${basePath}assets/images/Cam11.png`,
            jumpscare: `${basePath}assets/images/jump.png`, // EPË∑≥ÊùÄÂõæÁâá
            trumpJumpscare: `${basePath}assets/images/jumptrump.png`, // TrumpË∑≥ÊùÄÂõæÁâá
            hawkingJumpscare: `${basePath}assets/images/scaryhawking.png`, // HawkingË∑≥ÊùÄÂõæÁâá
        };

        const soundPaths = {
            ambient: `${basePath}assets/sounds/music.ogg`,
            static: `${basePath}assets/sounds/Static_sound.ogg`,
            staticLoop: `${basePath}assets/sounds/Static_sound.ogg`,
            vents: `${basePath}assets/sounds/vents.ogg`,
            ventCrawling: `${basePath}assets/sounds/vent-crawling.mp3`,
            jumpscare: `${basePath}assets/sounds/jumpcare.ogg`,
            hawkingJumpscare: `${basePath}assets/sounds/stephenjumpscare.ogg`, // HawkingË∑≥ÊùÄÈü≥Êïà
            blip: `${basePath}assets/sounds/Blip.ogg`,
            win: `${basePath}assets/sounds/winmusic.ogg`,
            chimes: `${basePath}assets/sounds/chimes.ogg`,
            crank1: `${basePath}assets/sounds/Crank1.ogg`,
            crank2: `${basePath}assets/sounds/Crank2.ogg`,
            ekg: `${basePath}assets/sounds/ekg.wav`,
            hawking_shock: `${basePath}assets/sounds/hawking_shock.wav`,
            goldenstephenscare: `${basePath}assets/sounds/goldenstephenscare.ogg`, // Golden ÈúçÈáëÈü≥Êïà
        };

        // Âä†ËΩΩÂõæÁâá
        for (const [key, path] of Object.entries(imagePaths)) {
            try {
                this.images[key] = await this.loadImage(path);
            } catch (e) {
                console.warn(`Failed to load image: ${path}`);
            }
        }

        // Âä†ËΩΩÈü≥È¢ë
        for (const [key, path] of Object.entries(soundPaths)) {
            try {
                this.sounds[key] = new Audio(path);
            } catch (e) {
                console.warn(`Failed to load sound: ${path}`);
            }
        }

        this.loaded = true;
    }

    getBasePath() {
        // Êú¨Âú∞ÂºÄÂèëÁéØÂ¢É - ÂßãÁªà‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑ
        return './';
    }

    loadImage(src) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
        });
    }

    playSound(key, loop = false, volume = 1.0) {
        if (this.sounds[key]) {
            this.sounds[key].loop = loop;
            this.sounds[key].volume = volume;
            this.sounds[key].play();
        }
    }

    stopSound(key) {
        if (this.sounds[key]) {
            this.sounds[key].pause();
            this.sounds[key].currentTime = 0;
        }
    }

    setSoundVolume(key, volume) {
        if (this.sounds[key]) {
            this.sounds[key].volume = volume;
        }
    }
}


// Camera system management
class CameraSystem {
    constructor(game) {
        this.game = game;
        this.cameraPanel = document.getElementById('camera-panel');
        this.currentCamLabel = document.getElementById('current-cam-label');
        this.cameraErrorLabel = document.getElementById('camera-error-label');
        this.playSoundBtn = document.getElementById('play-sound-btn');
        this.shockHawkingBtn = document.getElementById('shock-hawking-btn');
        this.currentSoundToggle = false;
        this.staticVideo = document.getElementById('camera-static-video');
        
        // Êí≠ÊîæÂ£∞Èü≥ÊåâÈíÆÁä∂ÊÄÅ
        this.soundButtonCooldown = false;
        this.soundButtonUseCount = 0;
        this.maxSoundUses = 5; // ËøûÁª≠‰ΩøÁî®5Ê¨°ÂêéÊëÑÂÉèÂ§¥ÊïÖÈöú
        this.cooldownTime = 8000; // 8ÁßíÂÜ∑Âç¥
        this.cooldownInterval = null; // ÂÜ∑Âç¥Âä®ÁîªÂÆöÊó∂Âô®
        
        // ÊØè‰∏™‰ΩçÁΩÆÁöÑËøûÁª≠Âê∏ÂºïËÆ°Êï∞
        this.locationAttractCount = {}; // { 'cam11': 2, 'cam8': 1, ... }
        this.maxLocationAttractCount = 2; // Âêå‰∏Ä‰ΩçÁΩÆÊúÄÂ§öËøûÁª≠Âê∏Âºï2Ê¨°
        this.lastEpLocation = null; // ËÆ∞ÂΩïEPÁöÑ‰∏ä‰∏Ä‰∏™‰ΩçÁΩÆÔºåÁî®‰∫éÊ£ÄÊµãÁßªÂä®
        
        // EP ËßíËâ≤ÈÖçÁΩÆ - Áõ¥Êé•ÂºïÁî® EnemyAI ÁöÑÈÖçÁΩÆÔºàÊ∏∏ÊàèÂàùÂßãÂåñÂêé‰ºöËÆæÁΩÆÔºâ
        this.characterImages = null;
        this.characterPositions = null;
        this.characterBrightness = null;
        this.characterRotation = null;
        
        this.bindEvents();
    }
    
    // Initialize EP config (from EnemyAI)
    initEPConfig() {
        if (this.game.enemyAI) {
            this.characterImages = this.game.enemyAI.characterImages;
            this.characterPositions = this.game.enemyAI.characterPositions;
            this.characterBrightness = this.game.enemyAI.characterBrightness;
            this.characterRotation = this.game.enemyAI.characterRotation;
            console.log('EP config initialized from EnemyAI');
        }
    }

    bindEvents() {
        if (this.playSoundBtn) {
            this.playSoundBtn.addEventListener('click', () => this.playAmbientSound());
        }
        if (this.shockHawkingBtn) {
            this.shockHawkingBtn.addEventListener('click', () => this.shockHawking());
        }
    }

    toggle() {
        // console.log('üì∑ Camera toggle called, current state:', this.game.state.cameraOpen);
        if (this.game.state.cameraOpen) {
            this.close();
        } else {
            this.open();
        }
    }

    open() {
        // console.log('üì∑ Opening camera...');
        // console.log('üì∑ Camera panel element:', this.cameraPanel);
        // console.log('üì∑ Camera panel classes before:', this.cameraPanel.className);
        
        this.game.state.cameraOpen = true;
        this.cameraPanel.classList.remove('hidden');
        this.cameraPanel.classList.add('show');
        
        // console.log('üì∑ Camera panel classes after:', this.cameraPanel.className);
        // console.log('üì∑ Camera panel display:', window.getComputedStyle(this.cameraPanel).display);
        // console.log('üì∑ Camera panel opacity:', window.getComputedStyle(this.cameraPanel).opacity);
        // console.log('üì∑ Camera panel transform:', window.getComputedStyle(this.cameraPanel).transform);
        
        this.game.assets.playSound('crank1');
        
        // Start looping low volume static sound
        this.game.assets.playSound('staticLoop', true, 0.3);
        
        this.createCameraGrid();
        
        // Êõ¥Êñ∞ÁîµÂáªÊåâÈíÆÊòæÁ§∫
        this.updateShockButtonVisibility();
        
        // Êõ¥Êñ∞ÈúçÈáëË≠¶Âëä‰ΩçÁΩÆÔºà‰ªéÈ£éÊâáÂ∑¶ËæπÁßªÂà∞Âú∞Âõæ‰∏äÔºâ
        if (this.game.enemyAI && this.game.enemyAI.hawking.active) {
            this.game.enemyAI.updateHawkingWarningDisplay();
        }
        
        // If camera failed, show failure effect
        if (this.game.state.cameraFailed) {
            console.log('üì∑ Camera is failed, showing failure effect');
            this.showCameraFailure();
        } else {
            console.log('üì∑ Camera is normal, showing normal view');
            // Normal state, ensure all failure effects removed
            this.cameraPanel.classList.remove('transitioning');
            
            // Hide ERR label
            if (this.cameraErrorLabel) {
                this.cameraErrorLabel.classList.remove('active');
            }
            
            // Stop static
            this.stopStatic();
            
            // Show map
            const cameraGrid = document.getElementById('camera-grid');
            if (cameraGrid) {
                cameraGrid.style.display = 'block';
            }
            
            // Update view
            this.updateView();
        }
        
        // Stop view rotation
        this.game.isRotatingLeft = false;
        this.game.isRotatingRight = false;
    }
    
    // Show camera failure effect
    showCameraFailure() {
        console.log('Showing camera failure effect...');
        
        // Night 5: 30% Ê¶ÇÁéáËß¶Âèë Golden ÈúçÈáëÂΩ©Ëõã
        if (this.game.state.currentNight === 5 && Math.random() < 0.3) {
            this.game.showGoldenStephen();
        }
        
        // Hide background image and characters
        this.cameraPanel.classList.add('transitioning');
        
        // Hide map
        const cameraGrid = document.getElementById('camera-grid');
        if (cameraGrid) {
            cameraGrid.style.display = 'none';
            console.log('Camera grid hidden');
        }
        
        // Show ERR label
        if (this.cameraErrorLabel) {
            this.cameraErrorLabel.classList.add('active');
            console.log('ERR label shown');
        }
        
        // Show and play static video
        if (this.staticVideo) {
            console.log('Starting static video...');
            this.staticVideo.classList.add('active');
            this.staticVideo.currentTime = 0; // Play from beginning
            this.staticVideo.play().catch(e => console.log('Video playback failed:', e));
        } else {
            console.error('Static video element not found!');
        }
    }
    
    // Stop static effect
    stopStatic() {
        if (this.staticVideo) {
            this.staticVideo.classList.remove('active');
            this.staticVideo.pause();
            this.staticVideo.currentTime = 0;
        }
    }
    
    // Start static effect (for switching cameras)
    startStatic() {
        if (this.staticVideo) {
            this.staticVideo.classList.add('active');
            this.staticVideo.play().catch(e => console.log('Video playback failed:', e));
        }
    }
    
    // Restore camera normal display
    restoreCameraView() {
        console.log('Restoring camera view...');
        
        // Stop static
        this.stopStatic();
        console.log('Static video stopped');
        
        // Remove failure state
        this.cameraPanel.classList.remove('transitioning');
        console.log('Removed transitioning class');
        
        // Hide ERR label
        if (this.cameraErrorLabel) {
            this.cameraErrorLabel.classList.remove('active');
            console.log('ERR label hidden');
        }
        
        // Show map
        const cameraGrid = document.getElementById('camera-grid');
        if (cameraGrid) {
            cameraGrid.style.display = 'block';
            console.log('Camera grid shown');
        }
        
        // Update view
        this.updateView();
        console.log('View updated');
    }
    
    // Fix camera
    restartCamera() {
        // Â¶ÇÊûúÊéßÂà∂Èù¢ÊùøÊ≠£ÂøôÔºå‰∏çÂÖÅËÆ∏Êìç‰Ωú
        if (this.game.state.controlPanelBusy) {
            console.log('Control panel is busy, cannot restart camera');
            return;
        }
        
        console.log('Restarting camera system...');
        this.game.state.cameraRestarting = true;
        this.game.state.controlPanelBusy = true; // ÈîÅÂÆöÊéßÂà∂Èù¢Êùø
        
        // Êí≠ÊîæÂøÉÁîµÂõæÈü≥Êïà
        this.game.assets.playSound('ekg', false, 0.8);
        
        // Restore after 4 seconds
        setTimeout(() => {
            // Êó†ËÆ∫‰πãÂâçÊòØÂê¶ÊïÖÈöúÔºåÈáçÂêØÂêéÈÉΩÊÅ¢Â§çÊ≠£Â∏∏
            this.game.state.cameraFailed = false;
            this.game.state.cameraRestarting = false;
            this.game.state.controlPanelBusy = false; // Ëß£ÈîÅÊéßÂà∂Èù¢Êùø
            
            // Stop static noise (Â¶ÇÊûúÊúâÁöÑËØù)
            this.game.assets.stopSound('static');
            
            // Reset sound button count (ÊÅ¢Â§ç5Ê¨°‰ΩøÁî®Ê¨°Êï∞)
            this.resetSoundButtonCount();
            
            console.log('Camera system restored!');
            
            // If camera is open, immediately restore display
            if (this.game.state.cameraOpen) {
                console.log('Camera is open, restoring view...');
                this.restoreCameraView();
            }
        }, 4000);
    }

    close() {
        this.game.state.cameraOpen = false;
        this.cameraPanel.classList.add('closing');
        this.cameraPanel.classList.remove('show');
        
        // Stop looping static sound
        this.game.assets.stopSound('staticLoop');
        
        // Clear character display
        const characterOverlay = document.getElementById('character-overlay');
        if (characterOverlay) {
            characterOverlay.innerHTML = '';
            console.log('Character overlay cleared');
        }
        
        // Êõ¥Êñ∞ÈúçÈáëË≠¶Âëä‰ΩçÁΩÆÔºà‰ªéÂú∞ÂõæÁßªÂà∞È£éÊâáÂ∑¶ËæπÔºâ
        if (this.game.enemyAI && this.game.enemyAI.hawking.active) {
            this.game.enemyAI.updateHawkingWarningDisplay();
        }
        
        setTimeout(() => {
            this.cameraPanel.classList.add('hidden');
            this.cameraPanel.classList.remove('closing');
        }, 400);
        
        this.game.assets.playSound('crank2');
    }

    switchCamera(camNum) {
        // If camera failed, cannot switch
        if (this.game.state.cameraFailed) {
            console.log('Camera system is offline! Cannot switch cameras.');
            return;
        }
        
        // Add transition state, hide background image
        this.cameraPanel.classList.add('transitioning');
        
        // Hide map
        const cameraGrid = document.getElementById('camera-grid');
        if (cameraGrid) {
            cameraGrid.style.display = 'none';
        }
        
        // ÈöêËóèËßíËâ≤
        const characterOverlay = document.getElementById('character-overlay');
        if (characterOverlay) {
            characterOverlay.style.display = 'none';
        }
        
        // ÊöÇÊó∂Èôç‰ΩéÂæ™ÁéØÈùôÊÄÅÈü≥ÁöÑÈü≥Èáè
        this.game.assets.setSoundVolume('staticLoop', 0.1);
        
        // Êí≠ÊîæÊ≠£Â∏∏Èü≥ÈáèÁöÑÈùôÊÄÅÈü≥Êïà
        this.game.assets.playSound('static', false, 1.0);
        
        // 1000ms ÂêéÂÅúÊ≠¢ÈùôÊÄÅÈü≥Êïà
        setTimeout(() => {
            this.game.assets.stopSound('static');
        }, 1000);
        
        // Show static effect
        this.startStatic();
        
        // Switch camera after 500ms
        setTimeout(() => {
            // If camera already failed, stop switch animation, show failure effect
            if (this.game.state.cameraFailed) {
                console.log('Camera failed during switch, showing failure effect');
                this.showCameraFailure();
                return;
            }
            
            this.game.state.currentCam = `cam${camNum}`;
            this.updateView();
            this.createCameraGrid();
            
            // After another 500ms fade out static, restore background
            setTimeout(() => {
                // Check again if failed
                if (this.game.state.cameraFailed) {
                    console.log('Camera failed during switch, showing failure effect');
                    this.showCameraFailure();
                    return;
                }
                
                this.stopStatic();
                this.cameraPanel.classList.remove('transitioning');
                
                // ÊòæÁ§∫Âú∞Âõæ
                if (cameraGrid) {
                    cameraGrid.style.display = 'block';
                }
                
                // ÊòæÁ§∫ËßíËâ≤
                if (characterOverlay) {
                    characterOverlay.style.display = 'block';
                }
                
                // Êõ¥Êñ∞ÁîµÂáªÊåâÈíÆÊòæÁ§∫ÔºàÊ†πÊçÆÂΩìÂâçÊëÑÂÉèÂ§¥Ôºâ
                this.updateShockButtonVisibility();
                
                // ÊÅ¢Â§çÂæ™ÁéØÈùôÊÄÅÈü≥ÁöÑÈü≥Èáè
                this.game.assets.setSoundVolume('staticLoop', 0.3);
            }, 500);
        }, 500);
    }

    updateView() {
        // If camera failed, don't update view
        if (this.game.state.cameraFailed) {
            return;
        }
        
        // Update camera panel background image
        if (this.game.assets.images[this.game.state.currentCam]) {
            this.cameraPanel.style.backgroundImage = `url('${this.game.assets.images[this.game.state.currentCam].src}')`;
        }
        
        // Êõ¥Êñ∞ÊëÑÂÉèÂ§¥Ê†áÁ≠æ
        const camNum = this.game.state.currentCam.replace('cam', '');
        this.currentCamLabel.textContent = `CAM ${camNum}`;
        
        // Êõ¥Êñ∞ËßíËâ≤ÊòæÁ§∫
        this.updateCharacterDisplay();
        
        // Êõ¥Êñ∞ÁîµÂáªÊåâÈíÆÊòæÁ§∫
        this.updateShockButtonVisibility();
    }
    
    // Êõ¥Êñ∞ËßíËâ≤ÊòæÁ§∫ÔºàÊîØÊåÅÂ§ö‰∏™Êïå‰∫∫Ôºâ
    updateCharacterDisplay() {
        const currentCam = this.game.state.currentCam;
        const epLocation = this.game.enemyAI.getCurrentLocation();
        const trumpLocation = this.game.enemyAI.getTrumpCurrentLocation();
        const hawkingActive = this.game.enemyAI.hawking.active;
        
        console.log(`updateCharacterDisplay - Current Cam: ${currentCam}, EP: ${epLocation}, Trump: ${trumpLocation}, Hawking: ${hawkingActive}, Night: ${this.game.state.currentNight}`);
        
        // ÊâìÂç∞ÊâÄÊúâÁõ∏ÂÖ≥ÂÖÉÁ¥†ÁöÑz-index
        console.log('üîç Z-Index Debug:');
        console.log('  - cameraPanel:', window.getComputedStyle(this.cameraPanel).zIndex);
        const staticVideo = document.getElementById('camera-static-video');
        if (staticVideo) {
            console.log('  - staticVideo:', window.getComputedStyle(staticVideo).zIndex);
        }
        const existingOverlay = document.getElementById('character-overlay');
        if (existingOverlay) {
            console.log('  - characterOverlay:', window.getComputedStyle(existingOverlay).zIndex);
            console.log('  - characterOverlay display:', window.getComputedStyle(existingOverlay).display);
            console.log('  - characterOverlay children count:', existingOverlay.children.length);
        }
        
        // Ëé∑ÂèñÊàñÂàõÂª∫ËßíËâ≤ÂÆπÂô®
        let characterOverlay = document.getElementById('character-overlay');
        if (!characterOverlay) {
            characterOverlay = document.createElement('div');
            characterOverlay.id = 'character-overlay';
            characterOverlay.style.position = 'absolute';
            characterOverlay.style.top = '0';
            characterOverlay.style.left = '0';
            characterOverlay.style.width = '100%';
            characterOverlay.style.height = '100%';
            characterOverlay.style.pointerEvents = 'none';
            characterOverlay.style.zIndex = '5';
            characterOverlay.style.overflow = 'hidden';
            this.cameraPanel.appendChild(characterOverlay);
        }
        
        // Ê∏ÖÁ©∫‰πãÂâçÁöÑËßíËâ≤
        characterOverlay.innerHTML = '';
        
        console.log('üîç Character overlay cleared, checking EP display conditions...');
        console.log('üîç EP hasSpawned:', this.game.enemyAI.epstein.hasSpawned);
        console.log('üîç EP location matches current cam:', epLocation === currentCam);
        console.log('üîç Has characterImages:', !!this.characterImages);
        console.log('üîç Has image for current cam:', this.characterImages ? !!this.characterImages[currentCam] : 'N/A');
        
        // ÊòæÁ§∫ÈúçÈáëÔºàÂ¶ÇÊûúÊøÄÊ¥ª‰∏îÂú®cam6Ôºâ
        if (hawkingActive && currentCam === 'cam6') {
            const hawkingImg = document.createElement('img');
            hawkingImg.src = 'assets/images/mrstephen.png';
            hawkingImg.style.position = 'absolute';
            hawkingImg.className = 'visible hawking-character';
            hawkingImg.style.zIndex = '3'; // Hawking Âú®ÊúÄ‰∏äÂ±Ç
            hawkingImg.style.left = '59.6%';
            hawkingImg.style.bottom = '0.9%';
            hawkingImg.style.width = '37%';
            hawkingImg.style.transform = 'translateX(-50%) rotate(-5deg)';
            hawkingImg.style.filter = 'brightness(0.33) contrast(1) saturate(1)';
            
            characterOverlay.appendChild(hawkingImg);
            console.log(`‚úì Displaying Hawking at cam6`);
        }
        
        // ÊòæÁ§∫ EPÔºàÂ¶ÇÊûúÂ∑≤Âá∫Âú∫‰∏îÂú®ÂΩìÂâçÊëÑÂÉèÂ§¥Ôºâ
        // console.log('üîç EP Display Check:', {
        //     hasSpawned: this.game.enemyAI.epstein.hasSpawned,
        //     epLocation: epLocation,
        //     currentCam: currentCam,
        //     match: epLocation === currentCam,
        //     hasImage: !!this.characterImages,
        //     imageForCam: this.characterImages ? !!this.characterImages[currentCam] : 'N/A'
        // });
        
        if (this.game.enemyAI.epstein.hasSpawned && epLocation === currentCam && this.characterImages && this.characterImages[currentCam]) {
            // ÂàõÂª∫EPÂÆπÂô®ÔºàÁî®‰∫éÂåÖÂê´EPÂõæÁâáÂíåÁîµÁúºÔºâ
            const epContainer = document.createElement('div');
            epContainer.className = 'ep-container';
            epContainer.style.position = 'absolute';
            epContainer.style.zIndex = '1';
            
            const pos = this.characterPositions[currentCam];
            if (pos) {
                if (pos.left) {
                    epContainer.style.left = pos.left;
                    epContainer.style.right = 'auto';
                } else if (pos.right) {
                    epContainer.style.right = pos.right;
                    epContainer.style.left = 'auto';
                }
                
                epContainer.style.bottom = pos.bottom;
                epContainer.style.width = pos.width;
                epContainer.style.transform = pos.transform || 'none';
            }
            
            // EPÂõæÁâá
            const epImg = document.createElement('img');
            epImg.src = this.characterImages[currentCam];
            epImg.style.position = 'relative';
            epImg.style.width = '100%';
            epImg.style.height = 'auto';
            epImg.style.display = 'block';
            epImg.className = 'visible ep-character';
            
            // Â∫îÁî®ÊòéÊöóÂ∫¶
            const brightness = this.characterBrightness[currentCam] || 100;
            epImg.style.filter = `brightness(${brightness}%)`;
            
            epContainer.appendChild(epImg);
            characterOverlay.appendChild(epContainer);
            console.log(`‚úì Displaying EP at ${currentCam}`);
            
            // Night 6: Ê∏≤ÊüìÁîµÁúºÁâπÊïàÔºà‰Ωú‰∏∫EPÂÆπÂô®ÁöÑÂ≠êÂÖÉÁ¥†Ôºâ
            if (this.game.state.currentNight === 6) {
                this.renderLightningEyes(epContainer, currentCam);
            }
        }
        
        // ÊòæÁ§∫ TrumpÔºàÂ¶ÇÊûúÂ∑≤Âá∫Âú∫‰∏îÂú®ÂΩìÂâçÊëÑÂÉèÂ§¥Ôºå‰∏î‰∏çÂú®Áà¨Ë°åÁä∂ÊÄÅÔºå‰∏îÂΩìÂâçÂ§úÊôöÊúâTrumpÈÖçÁΩÆÔºâ
        if (this.game.enemyAI.trump.hasSpawned && !this.game.enemyAI.trump.isCrawling && trumpLocation === currentCam && this.game.enemyAI.currentTrumpConfig) {
            const trumpImages = this.game.enemyAI.trumpImages;
            const trumpPositions = this.game.enemyAI.trumpPositions;
            const trumpBrightness = this.game.enemyAI.trumpBrightness;
            
            if (trumpImages[currentCam]) {
                const trumpImg = document.createElement('img');
                trumpImg.src = trumpImages[currentCam];
                trumpImg.style.position = 'absolute';
                trumpImg.className = 'visible trump-character';
                trumpImg.style.zIndex = '2'; // Trump Âú®‰∏äÂ±Ç
                
                const pos = trumpPositions[currentCam];
                if (pos) {
                    if (pos.left) {
                        trumpImg.style.left = pos.left;
                        trumpImg.style.right = 'auto';
                    } else if (pos.right) {
                        trumpImg.style.right = pos.right;
                        trumpImg.style.left = 'auto';
                    }
                    
                    trumpImg.style.bottom = pos.bottom;
                    trumpImg.style.width = pos.width;
                    trumpImg.style.transform = pos.transform || 'none';
                }
                
                const brightness = trumpBrightness[currentCam] || 100;
                trumpImg.style.filter = `brightness(${brightness}%)`;
                
                characterOverlay.appendChild(trumpImg);
                console.log(`‚úì Displaying Trump at ${currentCam}`);
            }
        }
        
        if (characterOverlay.children.length === 0) {
            console.log(`‚úó No characters at current camera (viewing ${currentCam})`);
        }
    }

    createCameraGrid() {
        const grid = document.getElementById('camera-grid');
        grid.innerHTML = '';
        
        // ÂàõÂª∫Âú∞ÂõæÂÆπÂô®
        const mapContainer = document.createElement('div');
        mapContainer.style.position = 'relative';
        mapContainer.style.width = '100%';
        mapContainer.style.height = '100%';
        
        // Ê∑ªÂä†Âú∞ÂõæÂõæÁâá
        const mapImg = document.createElement('img');
        mapImg.src = 'assets/images/FNAE-Map-layout.png';
        mapImg.style.width = '100%';
        mapImg.style.height = 'auto';
        mapImg.style.display = 'block';
        mapContainer.appendChild(mapImg);
        
        // Ê∑ªÂä† YOU Ê†áËÆ∞ÔºàÁé©ÂÆ∂‰ΩçÁΩÆÔºâ
        const youMarker = document.createElement('div');
        youMarker.style.position = 'absolute';
        youMarker.style.left = '7.0%';
        youMarker.style.top = '82.6%';
        youMarker.style.width = '13.0%';
        youMarker.style.height = '8.0%';
        youMarker.style.display = 'flex';
        youMarker.style.alignItems = 'center';
        youMarker.style.justifyContent = 'center';
        youMarker.style.fontSize = '0.7vw';
        youMarker.style.fontWeight = 'bold';
        youMarker.style.color = '#fff';
        youMarker.style.textShadow = '1px 1px 2px #000';
        youMarker.style.fontFamily = 'Arial, sans-serif';
        youMarker.style.background = 'rgba(0, 0, 0, 0.5)';
        youMarker.style.borderRadius = '4px';
        youMarker.textContent = 'YOU';
        mapContainer.appendChild(youMarker);
        
        // ÂÆö‰πâÊØè‰∏™ÊëÑÂÉèÂ§¥Âú®Âú∞Âõæ‰∏äÁöÑ‰ΩçÁΩÆÔºàÁôæÂàÜÊØîÔºâ
        const cameraPositions = [
            { cam: 1, x: 25.7, y: 84.3, width: 13.0, height: 8.0 },
            { cam: 2, x: 35.0, y: 56.6, width: 13.0, height: 8.0 },
            { cam: 3, x: 51.5, y: 77.6, width: 13.0, height: 8.0 },
            { cam: 4, x: 57.7, y: 44.9, width: 12.9, height: 8.0 },
            { cam: 5, x: 75.4, y: 60.3, width: 12.9, height: 8.0 },
            { cam: 6, x: 77.2, y: 82.2, width: 13.0, height: 8.0 },
            { cam: 7, x: 52.0, y: 27.9, width: 12.9, height: 8.0 },
            { cam: 8, x: 80.2, y: 21.9, width: 12.8, height: 8.0 },
            { cam: 9, x: 24.4, y: 20.6, width: 12.9, height: 8.0 },
            { cam: 10, x: 7.9, y: 39.1, width: 12.8, height: 8.0 },
            { cam: 11, x: 72.9, y: 4.6, width: 13.0, height: 8.0 },
        ];
        
        // ‰∏∫ÊØè‰∏™ÊëÑÂÉèÂ§¥ÂàõÂª∫ÂèØÁÇπÂáªÁÉ≠Âå∫
        cameraPositions.forEach(pos => {
            const hotspot = document.createElement('div');
            hotspot.className = 'camera-hotspot';
            hotspot.style.position = 'absolute';
            hotspot.style.left = pos.x + '%';
            hotspot.style.top = pos.y + '%';
            hotspot.style.width = pos.width + '%';
            hotspot.style.height = pos.height + '%';
            hotspot.style.cursor = 'pointer';
            hotspot.style.transition = 'all 0.2s';
            hotspot.style.display = 'flex';
            hotspot.style.alignItems = 'center';
            hotspot.style.justifyContent = 'center';
            hotspot.style.fontSize = '0.7vw';
            hotspot.style.fontWeight = 'bold';
            hotspot.style.color = '#fff';
            hotspot.style.textShadow = '1px 1px 2px #000';
            hotspot.style.fontFamily = 'Arial, sans-serif';
            hotspot.style.whiteSpace = 'nowrap';
            hotspot.style.borderRadius = '4px';
            hotspot.style.letterSpacing = '0.5px';
            
            // Ê∑ªÂä†CAMÊñáÊú¨
            hotspot.textContent = `CAM ${pos.cam}`;
            
            // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊëÑÂÉèÂ§¥ÁªøËâ≤Èó™ÁÉÅ
            if (this.game.state.currentCam === `cam${pos.cam}`) {
                hotspot.classList.add('camera-selected');
                hotspot.style.border = 'none';
            } else {
                hotspot.style.border = 'none';
                hotspot.style.background = 'transparent';
            }
            
            // ÊÇ¨ÊµÆÊïàÊûú
            hotspot.addEventListener('mouseenter', () => {
                if (this.game.state.currentCam !== `cam${pos.cam}`) {
                    hotspot.style.background = 'rgba(255, 255, 255, 0.2)';
                }
            });
            
            hotspot.addEventListener('mouseleave', () => {
                if (this.game.state.currentCam !== `cam${pos.cam}`) {
                    hotspot.style.background = 'transparent';
                }
            });
            
            // ÁÇπÂáªÂàáÊç¢ÊëÑÂÉèÂ§¥
            hotspot.addEventListener('click', () => this.switchCamera(pos.cam));
            
            mapContainer.appendChild(hotspot);
        });
        
        grid.appendChild(mapContainer);
    }

    playAmbientSound() {
        // Â¶ÇÊûúÂú®ÂÜ∑Âç¥‰∏≠Ôºå‰∏çËÉΩ‰ΩøÁî®
        if (this.soundButtonCooldown) {
            console.log('Sound button on cooldown');
            return;
        }
        
        const currentCam = this.game.state.currentCam;
        
        // Ê£ÄÊü•EPÊòØÂê¶ÁßªÂä®‰∫ÜÔºåÂ¶ÇÊûúÁßªÂä®‰∫ÜÂàôÈáçÁΩÆÊâÄÊúâ‰ΩçÁΩÆÁöÑËÆ°Êï∞
        const currentEpLocation = this.game.enemyAI.getCurrentLocation();
        if (this.lastEpLocation !== currentEpLocation) {
            console.log(`EP moved from ${this.lastEpLocation} to ${currentEpLocation}, resetting all location counts`);
            this.locationAttractCount = {}; // ÈáçÁΩÆÊâÄÊúâ‰ΩçÁΩÆËÆ°Êï∞
            this.lastEpLocation = currentEpLocation;
        }
        
        // ‰∫§ÊõøÊí≠Êîæ 1.ogg Âíå 2.ogg
        const soundFile = this.currentSoundToggle ? '2.ogg' : '1.ogg';
        this.currentSoundToggle = !this.currentSoundToggle;
        
        // ÂàõÂª∫Âπ∂Êí≠ÊîæÈü≥È¢ë
        const audio = new Audio(`assets/sounds/${soundFile}`);
        audio.play().catch(e => console.log('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e));
        
        // Ê£ÄÊü•ÂΩìÂâç‰ΩçÁΩÆÊòØÂê¶Â∑≤ÁªèÁî®ÂÆå2Ê¨°
        let canAttract = true;
        if (this.locationAttractCount[currentCam] >= this.maxLocationAttractCount) {
            console.log(`Location ${currentCam} already used ${this.maxLocationAttractCount} times - wasting player's attempt`);
            canAttract = false;
        }
        
        // Â∞ùËØïÂê∏ÂºïEPÂà∞ÂΩìÂâçÊëÑÂÉèÂ§¥‰ΩçÁΩÆÔºàÂ¶ÇÊûú‰ΩçÁΩÆÂèØÁî®Ôºâ
        let attracted = false;
        if (canAttract) {
            attracted = this.game.enemyAI.attractToSound(currentCam);
            
            if (attracted) {
                // Âê∏ÂºïÊàêÂäüÔºåÊí≠ÊîæËøáÂú∫Âä®Áîª
                this.playAttractionTransition();
                
                // Â¢ûÂä†ËØ•‰ΩçÁΩÆÁöÑËÆ°Êï∞
                this.locationAttractCount[currentCam] = (this.locationAttractCount[currentCam] || 0) + 1;
                console.log(`Epstein attracted to ${currentCam}! Count: ${this.locationAttractCount[currentCam]}/${this.maxLocationAttractCount}`);
                
                // Êõ¥Êñ∞EP‰ΩçÁΩÆËÆ∞ÂΩï
                this.lastEpLocation = currentCam;
            } else {
                // Âê∏ÂºïÂ§±Ë¥•Ôºà‰∏çÈÇªËøëÊàñÂÖ∂‰ªñÂéüÂõ†ÔºâÔºå‰∏çÁªôÁî®Êà∑ÊèêÁ§∫
                console.log('Attraction failed');
            }
        } else {
            // ‰ΩçÁΩÆÂ∑≤Áî®ÂÆå2Ê¨°ÔºåÊµ™Ë¥πÁé©ÂÆ∂ÁöÑÂ∞ùËØï
            console.log('Location maxed out - player wasted an attempt');
        }
        
        // Â¢ûÂä†‰ΩøÁî®Ê¨°Êï∞ÔºàÊó†ËÆ∫ÊòØÂê¶ÊàêÂäüÔºâ
        this.soundButtonUseCount++;
        console.log(`Sound button used: ${this.soundButtonUseCount}/${this.maxSoundUses}`);
        
        // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞ÊúÄÂ§ß‰ΩøÁî®Ê¨°Êï∞
        if (this.soundButtonUseCount >= this.maxSoundUses) {
            console.log('Sound button overused! Camera failure!');
            this.soundButtonUseCount = 0; // ÈáçÁΩÆËÆ°Êï∞
            
            // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÂê∏ÂºïÂä®ÁîªÔºåÁ´ãÂç≥ÂÅúÊ≠¢
            if (this.cameraPanel.classList.contains('transitioning')) {
                this.stopStatic();
                this.cameraPanel.classList.remove('transitioning');
            }
            
            // Ëß¶ÂèëÊëÑÂÉèÂ§¥ÊïÖÈöú
            this.game.enemyAI.triggerCameraFailure();
        }
        
        // ÂºÄÂßãÂÜ∑Âç¥
        this.soundButtonCooldown = true;
        this.playSoundBtn.style.opacity = '0.5';
        this.playSoundBtn.style.cursor = 'not-allowed';
        
        // Ê∑ªÂä†Âä†ËΩΩÂä®Áîª
        this.startCooldownAnimation();
        
        // 8ÁßíÂêéËß£Èô§ÂÜ∑Âç¥
        setTimeout(() => {
            this.soundButtonCooldown = false;
            this.playSoundBtn.style.opacity = '1';
            this.playSoundBtn.style.cursor = 'pointer';
            this.stopCooldownAnimation();
        }, this.cooldownTime);
    }
    
    // ÂºÄÂßãÂÜ∑Âç¥Âä®Áîª
    startCooldownAnimation() {
        let dotCount = 0;
        this.cooldownInterval = setInterval(() => {
            dotCount = (dotCount + 1) % 4;
            const dots = '.'.repeat(dotCount);
            this.playSoundBtn.textContent = `PLAY SOUND${dots}`;
        }, 500);
    }
    
    // ÂÅúÊ≠¢ÂÜ∑Âç¥Âä®Áîª
    stopCooldownAnimation() {
        if (this.cooldownInterval) {
            clearInterval(this.cooldownInterval);
            this.cooldownInterval = null;
        }
        this.playSoundBtn.textContent = 'PLAY SOUND';
    }
    
    // Âê∏ÂºïÊàêÂäüÁöÑËøáÂú∫Âä®Áîª
    playAttractionTransition() {
        console.log('Playing attraction transition...');
        
        // Ê∑ªÂä†ËøáÂú∫Áä∂ÊÄÅÔºåÈöêËóèËÉåÊôØÂõæÁâáÂíåÂú∞Âõæ
        this.cameraPanel.classList.add('transitioning');
        
        // ÈöêËóèÂú∞Âõæ
        const cameraGrid = document.getElementById('camera-grid');
        if (cameraGrid) {
            cameraGrid.style.display = 'none';
        }
        
        // ÈöêËóèËßíËâ≤
        const characterOverlay = document.getElementById('character-overlay');
        if (characterOverlay) {
            characterOverlay.style.display = 'none';
        }
        
        // ÊöÇÊó∂Èôç‰ΩéÂæ™ÁéØÈùôÊÄÅÈü≥ÁöÑÈü≥Èáè
        this.game.assets.setSoundVolume('staticLoop', 0.1);
        
        // Êí≠ÊîæÊ≠£Â∏∏Èü≥ÈáèÁöÑÈùôÊÄÅÈü≥Êïà
        this.game.assets.playSound('static', false, 1.0);
        
        // 1000ms ÂêéÂÅúÊ≠¢ÈùôÊÄÅÈü≥Êïà
        setTimeout(() => {
            this.game.assets.stopSound('static');
        }, 1000);
        
        // ÊòæÁ§∫Èõ™Ëä±ÊïàÊûú
        this.startStatic();
        
        // 500ms ÂêéÊõ¥Êñ∞ÊòæÁ§∫
        setTimeout(() => {
            // Â¶ÇÊûúÊëÑÂÉèÂ§¥Â∑≤ÁªèÊïÖÈöúÔºåÂÅúÊ≠¢Âä®ÁîªÂπ∂ÊòæÁ§∫ÊïÖÈöúÊïàÊûú
            if (this.game.state.cameraFailed) {
                console.log('Camera failed during attraction transition, showing failure effect');
                this.showCameraFailure();
                return;
            }
            
            this.updateCharacterDisplay();
            
            // ÂÜçËøá 500ms Ê∑°Âá∫Èõ™Ëä±ÔºåÊÅ¢Â§çËÉåÊôØ
            setTimeout(() => {
                // Â¶ÇÊûúÊëÑÂÉèÂ§¥Â∑≤ÁªèÊïÖÈöúÔºåÂÅúÊ≠¢Âä®ÁîªÂπ∂ÊòæÁ§∫ÊïÖÈöúÊïàÊûú
                if (this.game.state.cameraFailed) {
                    console.log('Camera failed during attraction transition, showing failure effect');
                    this.showCameraFailure();
                    return;
                }
                
                this.stopStatic();
                this.cameraPanel.classList.remove('transitioning');
                
                // ÊòæÁ§∫Âú∞Âõæ
                if (cameraGrid) {
                    cameraGrid.style.display = 'block';
                }
                
                // ÊòæÁ§∫ËßíËâ≤
                if (characterOverlay) {
                    characterOverlay.style.display = 'block';
                }
                
                // ÊÅ¢Â§çÂæ™ÁéØÈùôÊÄÅÈü≥ÁöÑÈü≥Èáè
                this.game.assets.setSoundVolume('staticLoop', 0.3);
            }, 500);
        }, 500);
    }
    
    // ÈáçÁΩÆÂ£∞Èü≥ÊåâÈíÆËÆ°Êï∞ÔºàÊëÑÂÉèÂ§¥ÈáçÂêØÂêéË∞ÉÁî®Ôºâ
    resetSoundButtonCount() {
        this.soundButtonUseCount = 0;
    }
    
    // EPÁßªÂä®Êó∂ÁöÑËøáÂú∫Âä®Áîª
    playMovementTransition() {
        console.log('Playing movement transition...');
        
        // Â¶ÇÊûúÊëÑÂÉèÂ§¥Â∑≤ÁªèÊïÖÈöúÔºå‰∏çÊí≠ÊîæÂä®Áîª
        if (this.game.state.cameraFailed) {
            console.log('Camera already failed, skipping movement transition');
            return;
        }
        
        // Ê∑ªÂä†ËøáÂú∫Áä∂ÊÄÅ
        this.cameraPanel.classList.add('transitioning');
        
        // ÈöêËóèÂú∞Âõæ
        const cameraGrid = document.getElementById('camera-grid');
        if (cameraGrid) {
            cameraGrid.style.display = 'none';
        }
        
        // ÈöêËóèËßíËâ≤
        const characterOverlay = document.getElementById('character-overlay');
        if (characterOverlay) {
            characterOverlay.style.display = 'none';
        }
        
        // ÊöÇÊó∂Èôç‰ΩéÂæ™ÁéØÈùôÊÄÅÈü≥ÁöÑÈü≥Èáè
        this.game.assets.setSoundVolume('staticLoop', 0.1);
        
        // Êí≠ÊîæÊ≠£Â∏∏Èü≥ÈáèÁöÑÈùôÊÄÅÈü≥Êïà
        this.game.assets.playSound('static', false, 1.0);
        
        // 1000ms ÂêéÂÅúÊ≠¢ÈùôÊÄÅÈü≥Êïà
        setTimeout(() => {
            this.game.assets.stopSound('static');
        }, 1000);
        
        // ÊòæÁ§∫Èõ™Ëä±ÊïàÊûú
        this.startStatic();
        
        // 500ms ÂêéÊõ¥Êñ∞ÊòæÁ§∫
        setTimeout(() => {
            // Â¶ÇÊûúÊëÑÂÉèÂ§¥Â∑≤ÁªèÊïÖÈöúÔºåÂÅúÊ≠¢Âä®ÁîªÂπ∂ÊòæÁ§∫ÊïÖÈöúÊïàÊûú
            if (this.game.state.cameraFailed) {
                console.log('Camera failed during movement transition, showing failure effect');
                this.showCameraFailure();
                return;
            }
            
            this.updateCharacterDisplay();
            
            // ÂÜçËøá 500ms Ê∑°Âá∫Èõ™Ëä±ÔºåÊÅ¢Â§çËÉåÊôØ
            setTimeout(() => {
                // Â¶ÇÊûúÊëÑÂÉèÂ§¥Â∑≤ÁªèÊïÖÈöúÔºåÂÅúÊ≠¢Âä®ÁîªÂπ∂ÊòæÁ§∫ÊïÖÈöúÊïàÊûú
                if (this.game.state.cameraFailed) {
                    console.log('Camera failed during movement transition, showing failure effect');
                    this.showCameraFailure();
                    return;
                }
                
                this.stopStatic();
                this.cameraPanel.classList.remove('transitioning');
                
                // ÊòæÁ§∫Âú∞Âõæ
                if (cameraGrid) {
                    cameraGrid.style.display = 'block';
                }
                
                // ÊòæÁ§∫ËßíËâ≤
                if (characterOverlay) {
                    characterOverlay.style.display = 'block';
                }
                
                // ÊÅ¢Â§çÂæ™ÁéØÈùôÊÄÅÈü≥ÁöÑÈü≥Èáè
                this.game.assets.setSoundVolume('staticLoop', 0.3);
            }, 500);
        }, 500);
    }
    
    // ÁîµÂáªÈúçÈáë
    shockHawking() {
        // Á´ãÂç≥Êí≠ÊîæÈü≥Êïà
        this.game.assets.playSound('hawking_shock', false, 1.0);
        
        // ÊòæÁ§∫Èõ™Ëä±ËøáÂú∫Âä®Áîª
        this.cameraPanel.classList.add('transitioning');
        
        // Êí≠ÊîæÈõ™Ëä±ËßÜÈ¢ë
        if (this.staticVideo) {
            this.staticVideo.classList.add('active');
            this.staticVideo.currentTime = 0;
            this.staticVideo.play().catch(e => console.log('Video playback failed:', e));
        }
        
        // 1ÁßíÂêéÊâßË°åÁîµÂáªÂπ∂ÊÅ¢Â§çÁîªÈù¢
        setTimeout(() => {
            if (this.game.enemyAI && this.game.enemyAI.shockHawking()) {
                console.log('Hawking shocked successfully!');
            }
            
            // ÂÅúÊ≠¢Èõ™Ëä±ËßÜÈ¢ë
            if (this.staticVideo) {
                this.staticVideo.classList.remove('active');
                this.staticVideo.pause();
            }
            
            // ÊÅ¢Â§çÊëÑÂÉèÂ§¥ÁîªÈù¢
            this.cameraPanel.classList.remove('transitioning');
            this.updateView();
        }, 1000);
    }
    
    // Êõ¥Êñ∞ÁîµÂáªÊåâÈíÆÊòæÁ§∫ÔºàÂè™Âú®cam6‰∏îÁ¨¨3-5ÂÖ≥ÊâçÊòæÁ§∫ÔºåNight 6‰∏çÊòæÁ§∫Ôºâ
    updateShockButtonVisibility() {
        if (this.shockHawkingBtn) {
            const currentCam = this.game.state.currentCam;
            if (this.game.state.currentNight >= 3 && this.game.state.currentNight <= 5 && this.game.state.cameraOpen && currentCam === 'cam6') {
                this.shockHawkingBtn.style.display = 'block';
            } else {
                this.shockHawkingBtn.style.display = 'none';
            }
        }
    }
    
    // Ê∏≤ÊüìÁîµÁúºÁâπÊïàÔºàNight 6Ôºâ- ‰Ωú‰∏∫EPÂÆπÂô®ÁöÑÂ≠êÂÖÉÁ¥†
    renderLightningEyes(epContainer, currentCam) {
        const eyesConfig = this.game.enemyAI.lightningEyesConfig[currentCam];
        if (!eyesConfig) return;
        
        // ÂàõÂª∫‰∏§Âè™ÁúºÁùõÔºàÁõ∏ÂØπ‰∫éEPÂõæÁâáÂÆö‰ΩçÔºâ
        [eyesConfig.eye1, eyesConfig.eye2].forEach((eyeConfig, index) => {
            // ÁúºÁùõÂÆπÂô®
            const eyeContainer = document.createElement('div');
            eyeContainer.className = 'lightning-eye-container';
            eyeContainer.style.position = 'absolute';
            eyeContainer.style.left = eyeConfig.left;
            eyeContainer.style.top = eyeConfig.top;
            eyeContainer.style.width = eyeConfig.width;
            eyeContainer.style.height = eyeConfig.height;
            eyeContainer.style.transform = 'translate(-50%, -50%)';
            eyeContainer.style.transformOrigin = 'center center';
            eyeContainer.style.zIndex = '10';
            eyeContainer.style.pointerEvents = 'none';
            
            // Ê†∏ÂøÉÂèëÂÖâÁÇπ
            const core = document.createElement('div');
            core.className = 'lightning-eye-core';
            core.style.position = 'absolute';
            core.style.top = '50%';
            core.style.left = '50%';
            core.style.width = '60%';
            core.style.height = '60%';
            core.style.transform = 'translate(-50%, -50%)';
            core.style.background = 'radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(0, 255, 255, 1) 40%, rgba(0, 200, 255, 0.6) 70%, transparent 100%)';
            core.style.borderRadius = '50%';
            core.style.filter = 'brightness(2)';
            core.style.animation = 'lightning-pulse 0.15s infinite';
            
            // Â§ñÂ±ÇÂÖâÊôï
            const glow = document.createElement('div');
            glow.className = 'lightning-eye-glow';
            glow.style.position = 'absolute';
            glow.style.top = '50%';
            glow.style.left = '50%';
            glow.style.width = '100%';
            glow.style.height = '100%';
            glow.style.transform = 'translate(-50%, -50%)';
            glow.style.background = 'radial-gradient(ellipse at center, rgba(0, 255, 255, 0.8) 0%, rgba(0, 255, 255, 0.4) 30%, rgba(0, 200, 255, 0.2) 60%, transparent 100%)';
            glow.style.borderRadius = '50%';
            glow.style.boxShadow = `
                0 0 20px rgba(0, 255, 255, 1),
                0 0 40px rgba(0, 255, 255, 0.8),
                0 0 60px rgba(0, 255, 255, 0.6)
            `;
            glow.style.animation = 'lightning-flicker 0.1s infinite';
            
            // Èõ∑ÁîµÊïàÊûúÔºàÂ§öÊù°ÈöèÊú∫Èó™ÁîµÔºâ
            for (let i = 0; i < 3; i++) {
                const lightning = document.createElement('div');
                lightning.className = 'lightning-bolt';
                lightning.style.position = 'absolute';
                lightning.style.top = '50%';
                lightning.style.left = '50%';
                lightning.style.width = '2px';
                lightning.style.height = `${30 + Math.random() * 40}%`;
                lightning.style.background = 'linear-gradient(to bottom, rgba(255, 255, 255, 1), rgba(0, 255, 255, 0.8), transparent)';
                lightning.style.transformOrigin = 'top center';
                lightning.style.transform = `translate(-50%, -50%) rotate(${Math.random() * 360}deg)`;
                lightning.style.boxShadow = '0 0 5px rgba(0, 255, 255, 1), 0 0 10px rgba(0, 255, 255, 0.8)';
                lightning.style.animation = `lightning-bolt ${0.1 + Math.random() * 0.1}s infinite`;
                lightning.style.animationDelay = `${Math.random() * 0.1}s`;
                lightning.style.opacity = '0.8';
                eyeContainer.appendChild(lightning);
            }
            
            eyeContainer.appendChild(glow);
            eyeContainer.appendChild(core);
            epContainer.appendChild(eyeContainer);
        });
        
        console.log(`‚ö° Rendered lightning eyes with electric effects at ${currentCam}`);
    }
}


// Êïå‰∫∫AIÁ≥ªÁªü - Âü∫‰∫éFNAFÊú∫Âà∂
class EnemyAI {
    constructor(game) {
        this.game = game;
        
        // ==================== AIÈÖçÁΩÆÁ≥ªÁªü ====================
        // Epstein AIÈÖçÁΩÆÔºàÊåâÂ§úÊï∞Ôºâ
        this.epsteinConfig = {
            1: {
                aiLevel: 12,              // AIÁ≠âÁ∫ß (0-20)Ôºå12/20 = 60%ÁßªÂä®Ê¶ÇÁéá
                movementInterval: [9000, 10000],  // ÁßªÂä®Ê£ÄÊü•Èó¥ÈöîÔºàÊØ´ÁßíÔºâ[ÊúÄÂ∞èÂÄº, ÊúÄÂ§ßÂÄº]
                movementDuration: 1000,   // ÁßªÂä®Âä®ÁîªÊó∂ÈïøÔºàÊØ´ÁßíÔºâ
                spawnDelay: 120000,        // Âá∫Âú∫Âª∂ËøüÔºàÊØ´ÁßíÔºâ
                movementProbability: {    // ÁßªÂä®ÊñπÂêëÊ¶ÇÁéá
                    forward: 0.8,         // ÂâçËøõÊ¶ÇÁéá 100%
                    lateral: 0.1,         // Âπ≥ÁßªÊ¶ÇÁéá 0%ÔºàÂΩìÂâç‰∏çÊîØÊåÅÔºâ
                    backward: 0.1         // ÂêéÈÄÄÊ¶ÇÁéá 0%
                },
                soundLureResistance: 0  // ÂØπsoundÂê∏ÂºïÁöÑÊäµÊäóÊ¶ÇÁéáÔºà0-1Ôºâ
            },
            2: {
                aiLevel: 12,
                movementInterval: [9000, 10000],
                movementDuration: 1000,
                spawnDelay: 0,
                movementProbability: {
                    forward: 0.8,
                    lateral: 0.1,
                    backward: 0.1
                },
                soundLureResistance: 0.1
            },
            3: {
                aiLevel: 12,
                movementInterval: [9000, 10000],
                movementDuration: 1000,
                spawnDelay: 0,
                movementProbability: {
                    forward: 0.9,
                    lateral: 0.1,
                    backward: 0
                },
                soundLureResistance: 0.15  // Night 3ÂºÄÂßãÔºö15%Ê¶ÇÁéáÊäµÊäósoundÂê∏Âºï
            },
            4: {
                aiLevel: 12,
                movementInterval: [9000, 10000],    // Night 4Ôºö9-10ÁßíÈó¥Èöî
                movementDuration: 1000,
                spawnDelay: 0,
                movementProbability: {
                    forward: 0.9,
                    lateral: 0.1,
                    backward: 0
                },
                soundLureResistance: 0.15
            },
            5: {
                aiLevel: 12,
                movementInterval: [9000, 10000],    // Night 5Ôºö9-10ÁßíÈó¥Èöî
                movementDuration: 1000,
                spawnDelay: 0,
                movementProbability: {
                    forward: 0.9,
                    lateral: 0.1,
                    backward: 0.0
                },
                soundLureResistance: 0.15
            },
            6: {
                aiLevel: 12,
                movementInterval: [6500, 7500],  // 6.5-7.5ÁßíÈó¥Èöî
                movementDuration: 1000,
                spawnDelay: 0,  // Night 6Á´ãÂç≥Âá∫Âú∫
                movementProbability: {
                    forward: 0.9,  // 90%ÂâçËøõ
                    lateral: 0.1,  // 10%Âπ≥Áßª
                    backward: 0.0  // ‰∏çÂêéÈÄÄ
                },
                soundLureResistance: 0.15
            }
        };
        
        // Trump AIÈÖçÁΩÆÔºàÊåâÂ§úÊï∞ÔºåNight 2ÂºÄÂßãÔºâ
        this.trumpConfig = {
            2: {
                aiLevel: 10,              // AIÁ≠âÁ∫ßÔºå10/20 = 50%ÁßªÂä®Ê¶ÇÁéá
                movementInterval: [8000, 9000],  // 8-9ÁßíÈöèÊú∫ÔºàÊØîEPÂø´‰∏ÄÁÇπÔºâ
                movementDuration: 1000,   // ÁßªÂä®Âä®ÁîªÊó∂ÈïøÔºàÊØ´ÁßíÔºâ
                spawnDelay: 0,            // Âá∫Âú∫Âª∂ËøüÔºàÊØ´ÁßíÔºâÔºåÂºÄÂ±ÄÂ∞±Âá∫Âú∫
                movementProbability: {    // ÁßªÂä®ÊñπÂêëÊ¶ÇÁéá
                    forward: 0.9,         // 90% ÂâçËøõÔºàÊõ¥ÊøÄËøõÔºâ
                    lateral: 0.1,         // 10% Âπ≥Áßª
                    backward: 0.0         // 0% ÂêéÈÄÄ
                },
                ventCrawling: {           // ÈÄöÈ£éÁÆ°Áà¨Ë°åÈÖçÁΩÆ
                    cam1Probability: 1.0, // Âú®cam1Êó∂Áà¨Ë°åÊ¶ÇÁéá 100%
                    cam2Probability: 0.5, // Âú®cam2Êó∂Áà¨Ë°åÊ¶ÇÁéá 50%
                    soundDelay: 5000,     // ÂºÄÂßãÁà¨Ë°åÂêéÂ§ö‰πÖÊí≠ÊîæÈü≥ÊïàÔºàÊØ´ÁßíÔºâ
                    soundDuration: 10000, // Áà¨Ë°åÈü≥ÊïàÊåÅÁª≠Êó∂ÈïøÔºàÊØ´ÁßíÔºâ
                    totalDuration: 20000, // Áà¨Ë°åÊÄªÊó∂ÈïøÔºàÊØ´ÁßíÔºâ
                    retreatDelay: 2000,   // Ë¢´ÈòªÊ≠¢ÂêéÂ§ö‰πÖÊí≠ÊîæÊí§ÈÄÄÈü≥ÊïàÔºàÊØ´ÁßíÔºâ
                    retreatSoundDuration: 3000 // Êí§ÈÄÄÈü≥ÊïàÊåÅÁª≠Êó∂ÈïøÔºàÊØ´ÁßíÔºâ
                }
            },
            3: {
                aiLevel: 13,              // 65%ÁßªÂä®Ê¶ÇÁéá
                movementInterval: [8000, 9000],  // 8-9ÁßíÈöèÊú∫ÔºàÊØîEPÂø´‰∏ÄÁÇπÔºâ
                movementDuration: 1000,
                spawnDelay: 0,
                movementProbability: {
                    forward: 0.8,         // 80% ÂâçËøõ
                    lateral: 0.2,         // 20% Âπ≥ÁßªÔºàÂ¢ûÂä†‰∏çÂèØÈ¢ÑÊµãÊÄßÔºâ
                    backward: 0.0
                },
                ventCrawling: {
                    cam1Probability: 1.0,
                    cam2Probability: 0.5,
                    soundDelay: 5000,
                    soundDuration: 10000,
                    totalDuration: 20000,
                    retreatDelay: 2000,
                    retreatSoundDuration: 3000
                }
            },
            4: {
                aiLevel: 13,
                movementInterval: [8000, 9000],    // 8-9ÁßíÈöèÊú∫ÔºàÊØîEPÂø´Ôºâ
                movementDuration: 1000,
                spawnDelay: 0,
                movementProbability: {
                    forward: 0.8,         // 80% ÂâçËøõ
                    lateral: 0.2,         // 20% Âπ≥Áßª
                    backward: 0.0
                },
                ventCrawling: {
                    cam1Probability: 1.0,
                    cam2Probability: 0.5,
                    soundDelay: 5000,
                    soundDuration: 10000,
                    totalDuration: 20000,
                    retreatDelay: 2000,
                    retreatSoundDuration: 3000
                }
            },
            5: {
                aiLevel: 13,
                movementInterval: [8000, 9000],    // 8-9ÁßíÈöèÊú∫ÔºàÊØîEPÂø´Ôºâ
                movementDuration: 1000,
                spawnDelay: 0,
                movementProbability: {
                    forward: 0.8,         // 80% ÂâçËøõ
                    lateral: 0.2,         // 20% Âπ≥Áßª
                    backward: 0.0
                },
                ventCrawling: {
                    cam1Probability: 1.0,
                    cam2Probability: 0.5,
                    soundDelay: 5000,
                    soundDuration: 10000,
                    totalDuration: 20000,
                    retreatDelay: 2000,
                    retreatSoundDuration: 3000
                }
            }
        };
        
        // ÂΩìÂâçÈÖçÁΩÆÔºàËøêË°åÊó∂‰ΩøÁî®Ôºâ
        this.currentEpsteinConfig = null;
        this.currentTrumpConfig = null;
        
        // Áà±Ê≥ºÊñØÂù¶ÁöÑÁä∂ÊÄÅ
        this.epstein = {
            currentLocation: 'cam11', // Ëµ∑Âßã‰ΩçÁΩÆÔºàÊúÄËøúÔºâ
            aiLevel: 0, // AIÁ≠âÁ∫ß (0-20)
            movementTimer: null,
            movementInterval: 12000, // ÁßªÂä®Ê£ÄÊü•Èó¥Èöî
            hasMovedOnce: false, // ÊòØÂê¶Â∑≤ÁªèÁßªÂä®Ëøá‰∏ÄÊ¨°
            hasSpawned: false, // ÊòØÂê¶Â∑≤ÁªèÂá∫Âú∫
        };
        
        // ÁâπÊúóÊôÆÁöÑÁä∂ÊÄÅ
        this.trump = {
            currentLocation: 'cam10', // Ëµ∑Âßã‰ΩçÁΩÆ
            aiLevel: 0, // AIÁ≠âÁ∫ß (0-20)
            movementTimer: null,
            movementInterval: 10000, // ÁßªÂä®Ê£ÄÊü•Èó¥Èöî
            hasSpawned: false, // ÊòØÂê¶Â∑≤ÁªèÂá∫Âú∫
            isCrawling: false, // ÊòØÂê¶Ê≠£Âú®Áà¨Ë°å
            crawlingTimer: null, // Áà¨Ë°åËÆ°Êó∂Âô®
            crawlingFrom: null, // ‰ªéÂì™‰∏™ÊëÑÂÉèÂ§¥ÂºÄÂßãÁà¨Ë°åÔºàcam1Êàñcam2Ôºâ
            retreatTimer: null, // Êí§ÈÄÄËÆ°Êó∂Âô®
        };
        
        // ÈúçÈáëÁöÑÁä∂ÊÄÅÔºàÁ¨¨3ÂÖ≥ÂºÄÂßãÔºâ
        this.hawking = {
            active: false, // ÊòØÂê¶ÊøÄÊ¥ª
            location: 'cam6', // Âõ∫ÂÆöÂú®cam6
            timer: null, // ËÆ°Êó∂Âô®
            warningLevel: 0, // 0=Êó†Ë≠¶Âëä, 1=ÈªÑËâ≤Ë≠¶Âëä, 2=Á∫¢Ëâ≤Ë≠¶Âëä
            warningTimer: null, // Ë≠¶ÂëäËÆ°Êó∂Âô®
            attackTimer: null, // ÊîªÂáªËÆ°Êó∂Âô®
        };
        
        // ÊØè‰∏™ÊëÑÂÉèÂ§¥‰ΩøÁî®ÁöÑËßíËâ≤ÂõæÁâáÔºàÊ†πÊçÆË∑ùÁ¶ªÂäûÂÖ¨ÂÆ§ËøúËøëÔºâ
        this.characterImages = {
            'cam11': '/FNAE-HTML5-1.1.5/assets/images/enemyep1.png',
            'cam10': '/FNAE-HTML5-1.1.5/assets/images/ep1.png',
            'cam1': '/FNAE-HTML5-1.1.5/assets/images/ep4.png',
            'cam9': '/FNAE-HTML5-1.1.5/assets/images/enemyep1.png',
            'cam8': '/FNAE-HTML5-1.1.5/assets/images/enemyep1.png',
            'cam7': '/FNAE-HTML5-1.1.5/assets/images/enemyep1.png',
            'cam6': '/FNAE-HTML5-1.1.5/assets/images/enemyep1.png',
            'cam5': '/FNAE-HTML5-1.1.5/assets/images/enemyep4.png',
            'cam4': '/FNAE-HTML5-1.1.5/assets/images/ep1.png',
            'cam3': '/FNAE-HTML5-1.1.5/assets/images/ep4.png',
            'cam2': '/FNAE-HTML5-1.1.5/assets/images/enemyep1.png',
        };
        
        // Night 6 ‰∏ìÁî®ÂõæÁâáÔºàÂ∏¶ÁîµÁúºÔºâ
        this.characterImagesNight6 = {
            'cam11': '/FNAE-HTML5-1.1.5/assets/images/enemyep1_night6.png',
            'cam10': '/FNAE-HTML5-1.1.5/assets/images/ep1_night6.png',
            'cam1': '/FNAE-HTML5-1.1.5/assets/images/ep4_night6.png',
            'cam9': '/FNAE-HTML5-1.1.5/assets/images/enemyep1_night6.png',
            'cam8': '/FNAE-HTML5-1.1.5/assets/images/enemyep1_night6.png',
            'cam7': '/FNAE-HTML5-1.1.5/assets/images/enemyep1_night6.png',
            'cam6': '/FNAE-HTML5-1.1.5/assets/images/enemyep1_night6.png',
            'cam5': '/FNAE-HTML5-1.1.5/assets/images/enemyep4_night6.png',
            'cam4': '/FNAE-HTML5-1.1.5/assets/images/ep1_night6.png',
            'cam3': '/FNAE-HTML5-1.1.5/assets/images/ep4_night6.png',
            'cam2': '/FNAE-HTML5-1.1.5/assets/images/enemyep1_night6.png',
        };
        
        // ÁâπÊúóÊôÆÁöÑÂõæÁâáÈÖçÁΩÆÔºà‰ΩøÁî®ÁªùÂØπË∑ØÂæÑÔºâ
        this.trumpImages = {
            'cam10': '/FNAE-HTML5-1.1.5/assets/images/trump3.png',
            'cam11': '/FNAE-HTML5-1.1.5/assets/images/trump3.png',
            'cam9': '/FNAE-HTML5-1.1.5/assets/images/trump.png',
            'cam8': '/FNAE-HTML5-1.1.5/assets/images/trump5.png',
            'cam7': '/FNAE-HTML5-1.1.5/assets/images/trump3.png',
            'cam6': '/FNAE-HTML5-1.1.5/assets/images/trump3.png',
            'cam5': '/FNAE-HTML5-1.1.5/assets/images/trump2.png',
            'cam1': '/FNAE-HTML5-1.1.5/assets/images/trump4.png',
            'cam2': '/FNAE-HTML5-1.1.5/assets/images/trump4.png',
            'cam3': '/FNAE-HTML5-1.1.5/assets/images/trump2.png',
            'cam4': '/FNAE-HTML5-1.1.5/assets/images/trump3.png',
        };
        
        // ÂÆö‰πâÁßªÂä®Ë∑ØÂæÑÂõæÔºàÊ†πÊçÆÂú∞ÂõæËøûÊé•ÂÖ≥Á≥ªÔºåÂè™ËÉΩÂêëÂâçÁßªÂä®Ôºâ
        // ÊØè‰∏™‰ΩçÁΩÆÁöÑÊ≠•ÈïøÔºàË∑ùÁ¶ªÂäûÂÖ¨ÂÆ§ÁöÑÊúÄÁü≠Ë∑ØÂæÑÈïøÂ∫¶Ôºâ- ‰ΩøÁî®BFSËÆ°ÁÆó
        // Office ‚Üê Cam1 ‚Üê Cam3 ‚Üê ...
        this.locationDepth = {
            'office': 0,  // ÁªàÁÇπ
            'cam1': 1,    // Cam1 ‚Üí Office (1Ê≠•)
            'cam2': 2,    // Cam2 ‚Üí Cam1 ‚Üí Office (2Ê≠•) ‚úÖ ‰øÆÊ≠£
            'cam3': 2,    // Cam3 ‚Üí Cam1 ‚Üí Office (2Ê≠•)
            'cam6': 3,    // Cam6 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (3Ê≠•)
            'cam4': 3,    // Cam4 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (3Ê≠•)
            'cam5': 4,    // Cam5 ‚Üí Cam6 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (4Ê≠•)
            'cam7': 4,    // Cam7 ‚Üí Cam4 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (4Ê≠•)
            'cam8': 5,    // Cam8 ‚Üí Cam5 ‚Üí Cam6 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (5Ê≠•)
            'cam11': 5,   // Cam11 ‚Üí Cam7 ‚Üí Cam4 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (5Ê≠•)
            'cam9': 5,    // Cam9 ‚Üí Cam7 ‚Üí Cam4 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (5Ê≠•)
            'cam10': 6,   // Cam10 ‚Üí Cam9 ‚Üí Cam7 ‚Üí Cam4 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (6Ê≠•)
        };
        
        // ÁâπÊúóÊôÆÁöÑÊ≠•ÈïøÈÖçÁΩÆÔºà‰ΩøÁî®ÂíåEPÁõ∏ÂêåÁöÑÊ≠•ÈïøÔºå‰∏ÄÊ≠•‰∏ÄÊ≠•Ëµ∞Ôºâ
        this.trumpLocationDepth = {
            'office': 0,  // ÁªàÁÇπ
            'cam1': 1,    // Cam1 ‚Üí Office (1Ê≠•)
            'cam2': 2,    // Cam2 ‚Üí Cam1 ‚Üí Office (2Ê≠•)
            'cam3': 2,    // Cam3 ‚Üí Cam1 ‚Üí Office (2Ê≠•)
            'cam6': 3,    // Cam6 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (3Ê≠•)
            'cam4': 3,    // Cam4 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (3Ê≠•)
            'cam5': 4,    // Cam5 ‚Üí Cam6 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (4Ê≠•)
            'cam7': 4,    // Cam7 ‚Üí Cam4 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (4Ê≠•)
            'cam8': 5,    // Cam8 ‚Üí Cam5 ‚Üí Cam6 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (5Ê≠•)
            'cam11': 5,   // Cam11 ‚Üí Cam7 ‚Üí Cam4 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (5Ê≠•)
            'cam9': 5,    // Cam9 ‚Üí Cam7 ‚Üí Cam4 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (5Ê≠•)
            'cam10': 6,   // Cam10 ‚Üí Cam9 ‚Üí Cam7 ‚Üí Cam4 ‚Üí Cam3 ‚Üí Cam1 ‚Üí Office (6Ê≠•)
        };
        
        // ÂÆö‰πâÁßªÂä®Ë∑ØÂæÑÂõæÔºàÂè™ËÉΩÂêëÂäûÂÖ¨ÂÆ§ÊñπÂêëÁßªÂä®Ôºå‰∏çËÉΩÂêéÈÄÄÔºâ
        this.movementPaths = {
            'cam11': ['cam7', 'cam8'], // Cam11Âè™ËøûÊé•Cam7ÂíåCam8
            'cam9': ['cam7', 'cam10'],
            'cam10': ['cam9'], // Ê≠ªËÉ°ÂêåÔºåÂè™ËÉΩÂéªcam9
            'cam8': ['cam7', 'cam5'],
            'cam7': ['cam4'],
            'cam4': ['cam2', 'cam3'], // ‰øÆÊ≠£ÔºöÊ∑ªÂä†cam3
            'cam5': ['cam4', 'cam6'],
            'cam2': ['cam3', 'cam1'], // ‰øÆÊ≠£ÔºöÊ∑ªÂä†cam1
            'cam3': ['cam1', 'cam6'],
            'cam6': ['cam3'],
            'cam1': ['office'], // Â§ßÈó®ÔºåÂè™ËÉΩËøõÂäûÂÖ¨ÂÆ§
            'office': [] // Âà∞ËææÂäûÂÖ¨ÂÆ§ÔºåÊ∏∏ÊàèÁªìÊùü
        };
        
        // ÊØè‰∏™ÊëÑÂÉèÂ§¥ÁöÑÈÇªËøëÊàøÈó¥ÔºàÁî®‰∫ésoundÂê∏ÂºïÔºâ- ÂÆåÊï¥ÁöÑÂèåÂêëËøûÊé•
        this.adjacentRooms = {
            'cam11': ['cam7', 'cam8'],
            'cam9': ['cam7', 'cam10'],
            'cam10': ['cam9'],
            'cam8': ['cam11', 'cam7', 'cam5'],
            'cam7': ['cam11', 'cam8', 'cam9', 'cam4'],
            'cam4': ['cam7', 'cam2', 'cam5', 'cam3'], // ‰øÆÊ≠£ÔºöÊ∑ªÂä†cam3
            'cam5': ['cam8', 'cam4', 'cam6'],
            'cam2': ['cam4', 'cam3', 'cam1'], // ‰øÆÊ≠£ÔºöÊ∑ªÂä†cam1
            'cam3': ['cam2', 'cam1', 'cam6', 'cam4'], // ‰øÆÊ≠£ÔºöÊ∑ªÂä†cam4
            'cam6': ['cam5', 'cam3'],
            'cam1': ['cam3', 'cam2'], // ‰øÆÊ≠£ÔºöÊ∑ªÂä†cam2Ôºà‰∏çÂåÖÊã¨officeÔºåÂõ†‰∏∫ÈÇ£ÊòØÁªàÁÇπÔºâ
        };
        
        // ÊØè‰∏™ÊëÑÂÉèÂ§¥ÁöÑËßíËâ≤‰ΩçÁΩÆÈÖçÁΩÆÔºàCSSÂÆö‰ΩçÔºâ
        this.characterPositions = {
            'cam11': { left: '57.1%', bottom: '0%', width: '29%', transform: 'translateX(-50%) rotate(0deg)' },
            'cam10': { left: '73.8%', bottom: '1.6%', width: '89.2%', transform: 'translateX(-50%) rotate(0deg)' },
            'cam1': { left: '39.9%', bottom: '35.3%', width: '38.8%', transform: 'translateX(-50%) rotate(0deg)' },
            'cam9': { left: '18.5%', bottom: '0%', width: '29.6%', transform: 'translateX(-50%) rotate(0deg)' },
            'cam8': { left: '96.1%', bottom: '0%', width: '29.6%', transform: 'translateX(-50%) rotate(-23deg)' },
            'cam7': { left: '49.7%', bottom: '0%', width: '29.6%', transform: 'translateX(-50%) rotate(-5deg)' },
            'cam6': { left: '16.6%', bottom: '0%', width: '29.6%', transform: 'translateX(-50%) rotate(-5deg)' },
            'cam5': { left: '71.1%', bottom: '0%', width: '29.6%', transform: 'translateX(-50%) rotate(-5deg)' },
            'cam4': { left: '91.4%', bottom: '6.8%', width: '66.9%', transform: 'translateX(-50%) rotate(-5deg)' },
            'cam3': { left: '7.4%', bottom: '5%', width: '66.9%', transform: 'translateX(-50%) rotate(-5deg)' },
            'cam2': { left: '39.6%', bottom: '27.7%', width: '37.8%', transform: 'translateX(-50%) rotate(-139deg)' },
        };
        
        // ËßíËâ≤ÊòéÊöóÂ∫¶ÈÖçÁΩÆÔºàÁôæÂàÜÊØîÔºâ
        this.characterBrightness = {
            'cam11': 100,
            'cam10': 100,
            'cam1': 22,
            'cam9': 8,
            'cam8': 9,
            'cam7': 9,
            'cam6': 9,
            'cam5': 7,
            'cam4': 65,
            'cam3': 30,
            'cam2': 8,
        };
        
        // ËßíËâ≤ÊóãËΩ¨ÈÖçÁΩÆÔºàÂ∫¶Êï∞Ôºâ
        this.characterRotation = {
            'cam11': 0,
            'cam10': 0,
            'cam1': 0,
            'cam9': 0,
            'cam8': -23,
            'cam7': -5,
            'cam6': -5,
            'cam5': -5,
            'cam4': -5,
            'cam3': -5,
            'cam2': -139,
        };
        
        // ÁîµÁúºÁâπÊïàÈÖçÁΩÆÔºàNight 6 ÁâπÊÆäÂ§úÊôöÔºâ- ÂùêÊ†áÁõ∏ÂØπ‰∫éEPÂõæÁâá
        this.lightningEyesConfig = {
            'cam11': {
                eye1: { left: '46.3%', top: '14.8%', width: '10%', height: '10%' },
                eye2: { left: '54.2%', top: '13.8%', width: '10%', height: '10%' }
            },
            'cam10': {
                eye1: { left: '37.0%', top: '41.7%', width: '10%', height: '10%' },
                eye2: { left: '38.7%', top: '43.5%', width: '10%', height: '10%' }
            },
            'cam1': {
                eye1: { left: '47.7%', top: '41.6%', width: '10%', height: '10%' },
                eye2: { left: '49.9%', top: '42.3%', width: '10%', height: '10%' }
            },
            'cam9': {
                eye1: { left: '46.8%', top: '15.1%', width: '10%', height: '10%' },
                eye2: { left: '54.7%', top: '14.1%', width: '10%', height: '10%' }
            },
            'cam8': {
                eye1: { left: '47.1%', top: '15.8%', width: '10%', height: '10%' },
                eye2: { left: '53.9%', top: '15.3%', width: '10%', height: '10%' }
            },
            'cam7': {
                eye1: { left: '46.3%', top: '15.6%', width: '10%', height: '10%' },
                eye2: { left: '54.2%', top: '13.6%', width: '10%', height: '10%' }
            },
            'cam6': {
                eye1: { left: '46.8%', top: '15.4%', width: '10%', height: '10%' },
                eye2: { left: '53.7%', top: '14.5%', width: '10%', height: '10%' }
            },
            'cam5': {
                eye1: { left: '52.2%', top: '21.3%', width: '10%', height: '10%' },
                eye2: { left: '62.0%', top: '23.1%', width: '10%', height: '10%' }
            },
            'cam4': {
                eye1: { left: '37.1%', top: '42.4%', width: '10%', height: '10%' },
                eye2: { left: '38.4%', top: '43.6%', width: '10%', height: '10%' }
            },
            'cam3': {
                eye1: { left: '47.7%', top: '41.4%', width: '10%', height: '10%' },
                eye2: { left: '50.0%', top: '42.5%', width: '10%', height: '10%' }
            },
            'cam2': {
                eye1: { left: '46.1%', top: '15.3%', width: '10%', height: '10%' },
                eye2: { left: '53.9%', top: '14.3%', width: '10%', height: '10%' }
            }
        };
        
        // ÁâπÊúóÊôÆÁöÑ‰ΩçÁΩÆÈÖçÁΩÆÔºà‰ΩøÁî®Ë∞ÉËØïÂ∑•ÂÖ∑ËÆæÁΩÆÔºâ
        this.trumpPositions = {
            'cam10': { left: '10%', bottom: '0%', width: '40%', transform: 'translateX(-50%) rotate(0deg)' },
            'cam11': { left: '38.2%', bottom: '0%', width: '40%', transform: 'translateX(-50%) rotate(0deg)' },
            'cam9': { left: '0%', bottom: '34.6%', width: '13.9%', transform: 'translateX(-50%) rotate(44deg)' },
            'cam8': { left: '1.5%', bottom: '24.5%', width: '20.1%', transform: 'translateX(-50%) rotate(58deg)' },
            'cam7': { left: '7.4%', bottom: '0%', width: '41.4%', transform: 'translateX(-50%) rotate(1deg)' },
            'cam6': { left: '86.3%', bottom: '0%', width: '41.4%', transform: 'translateX(-50%) rotate(1deg)' },
            'cam5': { left: '0%', bottom: '0%', width: '29.3%', transform: 'translateX(-50%) rotate(1deg)' },
            'cam1': { left: '10.8%', bottom: '15%', width: '31.6%', transform: 'translateX(-50%) rotate(1deg)' },
            'cam2': { left: '77.2%', bottom: '32.3%', width: '31.6%', transform: 'translateX(-50%) rotate(1deg)' },
            'cam3': { left: '100%', bottom: '21.4%', width: '32.9%', transform: 'translateX(-50%) rotate(-62deg)' },
            'cam4': { left: '11%', bottom: '0%', width: '31.6%', transform: 'translateX(-50%) rotate(1deg)' },
        };
        
        // ÁâπÊúóÊôÆÁöÑÊòéÊöóÂ∫¶ÈÖçÁΩÆ
        this.trumpBrightness = {
            'cam10': 31,
            'cam11': 100,
            'cam9': 29,
            'cam8': 28,
            'cam7': 28,
            'cam6': 28,
            'cam5': 12,
            'cam1': 40,
            'cam2': 31,
            'cam3': 19,
            'cam4': 31,
        };
        
        // ÁâπÊúóÊôÆÁöÑÊóãËΩ¨ÈÖçÁΩÆ
        this.trumpRotation = {
            'cam10': 0,
            'cam11': 0,
            'cam9': 44,
            'cam8': 58,
            'cam7': 1,
            'cam6': 1,
            'cam5': 1,
            'cam1': 1,
            'cam2': 1,
            'cam3': -62,
            'cam4': 1,
        };
    }

    // ÂºÄÂßãAIÂæ™ÁéØ
    start() {
        console.log(`üéÆ EnemyAI.start() called for Night ${this.game.state.currentNight}`);
        
        // Ê†πÊçÆÂ§úÊï∞Âä†ËΩΩÈÖçÁΩÆÂπ∂ËÆæÁΩÆAIÁ≠âÁ∫ß
        this.loadAIConfig();
        
        console.log(`Night ${this.game.state.currentNight} - Epstein AI Config:`, this.currentEpsteinConfig);
        console.log(`Epstein will spawn in ${this.currentEpsteinConfig.spawnDelay / 1000} seconds...`);
        
        // Ê†πÊçÆÈÖçÁΩÆÂª∂ËøüÂêéEPÂá∫Âú∫
        const spawnTimer = setTimeout(() => {
            console.log(`‚è∞ Spawn timer triggered after ${this.currentEpsteinConfig.spawnDelay}ms`);
            this.spawnEpstein();
        }, this.currentEpsteinConfig.spawnDelay);
        
        console.log(`‚è∞ Spawn timer created:`, spawnTimer);
        
        // Á¨¨2-5ÊôöÔºåÁâπÊúóÊôÆÂá∫Âú∫ÔºàNight 6 Ê≤°Êúâ TrumpÔºâ
        if (this.game.state.currentNight >= 2 && this.game.state.currentNight <= 5 && this.currentTrumpConfig) {
            console.log(`Night ${this.game.state.currentNight} - Trump AI Config:`, this.currentTrumpConfig);
            console.log(`Trump will spawn in ${this.currentTrumpConfig.spawnDelay / 1000} seconds...`);
            
            // Ê†πÊçÆÈÖçÁΩÆÂª∂ËøüÂêéTrumpÂá∫Âú∫
            setTimeout(() => {
                this.spawnTrump();
            }, this.currentTrumpConfig.spawnDelay);
        }
        
        // Á¨¨3ÊôöÂèä‰ª•ÂêéÔºåÈúçÈáëÊøÄÊ¥ªÔºà‰ΩÜ Night 6 ‰∏çÊøÄÊ¥ªÔºâ
        if (this.game.state.currentNight >= 3 && this.game.state.currentNight <= 5) {
            console.log('Hawking activated at cam6!');
            this.startHawking();
        }
    }
    
    // Âä†ËΩΩAIÈÖçÁΩÆ
    loadAIConfig() {
        const night = this.game.state.currentNight;
        
        // Âä†ËΩΩEpsteinÈÖçÁΩÆ
        this.currentEpsteinConfig = this.epsteinConfig[night] || this.epsteinConfig[1];
        this.epstein.aiLevel = this.currentEpsteinConfig.aiLevel;
        this.epstein.movementInterval = this.getRandomInterval(this.currentEpsteinConfig.movementInterval);
        
        // Âä†ËΩΩTrumpÈÖçÁΩÆÔºàNight 2-5Ôºâ
        if (night >= 2 && night <= 5) {
            this.currentTrumpConfig = this.trumpConfig[night] || this.trumpConfig[2];
            this.trump.aiLevel = this.currentTrumpConfig.aiLevel;
            this.trump.movementInterval = this.getRandomInterval(this.currentTrumpConfig.movementInterval);
        } else {
            this.currentTrumpConfig = null; // Night 6 Ê≤°Êúâ Trump
        }
        
        console.log(`AI Config loaded for Night ${night}`);
        console.log(`- Epstein: Level ${this.epstein.aiLevel}, Interval ${this.epstein.movementInterval}ms`);
        if (this.currentTrumpConfig) {
            console.log(`- Trump: Level ${this.trump.aiLevel}, Interval ${this.trump.movementInterval}ms`);
        } else {
            console.log(`- Trump: Not active this night`);
        }
    }
    
    // ‰ªéÂå∫Èó¥‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Èó¥ÈöîÊó∂Èó¥
    getRandomInterval(intervalConfig) {
        // Â¶ÇÊûúÊòØÊï∞ÁªÑÔºå‰ªéÂå∫Èó¥‰∏≠ÈöèÊú∫ÈÄâÊã©
        if (Array.isArray(intervalConfig)) {
            const [min, max] = intervalConfig;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        // Â¶ÇÊûúÊòØÊï∞Â≠óÔºåÁõ¥Êé•ËøîÂõû
        return intervalConfig;
    }
    
    // EPÂá∫Âú∫
    spawnEpstein() {
        if (this.epstein.hasSpawned) return;
        
        this.epstein.hasSpawned = true;
        console.log('‚úÖ Epstein has spawned!');
        
        // Á¨¨‰∏ÄÂÖ≥Ëß¶ÂèëÊëÑÂÉèÂ§¥ÊïÖÈöúÔºåÁ¨¨‰∫åÂÖ≥Âèä‰ª•Âêé‰∏çËß¶Âèë
        if (this.game.state.currentNight === 1) {
            this.triggerCameraFailure();
        }
        
        // ÂºÄÂßãÁßªÂä®Ê£ÄÊü•Âæ™ÁéØ
        this.startMovementLoop();
    }
    
    // TrumpÂá∫Âú∫
    spawnTrump() {
        if (this.trump.hasSpawned) return;
        
        this.trump.hasSpawned = true;
        console.log('Trump has spawned at cam10!');
        
        // Á´ãÂç≥Êõ¥Êñ∞ÊëÑÂÉèÂ§¥ÊòæÁ§∫ÔºàÂ¶ÇÊûúÊëÑÂÉèÂ§¥ÊâìÂºÄÔºâ
        if (this.game.state.cameraOpen) {
            this.updateCameraDisplay();
        }
        
        // ÂºÄÂßãTrumpÁöÑÁßªÂä®Ê£ÄÊü•Âæ™ÁéØ
        this.startTrumpMovementLoop();
    }

    // ÂÅúÊ≠¢AI
    stop() {
        if (this.epstein.movementTimer) {
            clearTimeout(this.epstein.movementTimer);  // Êîπ‰∏∫ clearTimeout
            this.epstein.movementTimer = null;
        }
        if (this.trump.movementTimer) {
            clearTimeout(this.trump.movementTimer);    // Êîπ‰∏∫ clearTimeout
            this.trump.movementTimer = null;
        }
        if (this.trump.crawlingTimer) {
            clearTimeout(this.trump.crawlingTimer);
            this.trump.crawlingTimer = null;
        }
        if (this.trump.retreatTimer) {
            clearTimeout(this.trump.retreatTimer);
            this.trump.retreatTimer = null;
        }
        if (this.hawking.timer) {
            clearTimeout(this.hawking.timer);
            this.hawking.timer = null;
        }
        if (this.hawking.warningTimer) {
            clearTimeout(this.hawking.warningTimer);
            this.hawking.warningTimer = null;
        }
        if (this.hawking.attackTimer) {
            clearTimeout(this.hawking.attackTimer);
            this.hawking.attackTimer = null;
        }
        // ÂÅúÊ≠¢Áà¨Ë°åÈü≥Êïà
        this.game.assets.stopSound('ventCrawling');
        // ÈöêËóèÈúçÈáëË≠¶Âëä
        this.hideHawkingWarning();
    }

    // ÂºÄÂßãÁßªÂä®Ê£ÄÊü•Âæ™ÁéØ
    startMovementLoop() {
        // ‰ΩøÁî® setTimeout ËÄå‰∏çÊòØ setIntervalÔºå‰ª•ÊîØÊåÅÂä®ÊÄÅÈó¥Èöî
        const scheduleNextCheck = () => {
            // Night 4ÁâπÊÆäÊú∫Âà∂Ôºö4AMÂêéEPÂèòÂæóÊõ¥ÊøÄËøõ
            let currentConfig = this.currentEpsteinConfig;
            if (this.game.state.currentNight === 4 && this.game.state.currentTime >= 4) {
                // 4AMÂêé‰ΩøÁî®Êõ¥ÊøÄËøõÁöÑÈÖçÁΩÆ
                currentConfig = {
                    ...this.currentEpsteinConfig,
                    movementInterval: [8000, 10000],
                    movementProbability: {
                        forward: 1.0,
                        lateral: 0.0,
                        backward: 0.0
                    }
                };
            }
            
            // ‰ªéÈÖçÁΩÆÂå∫Èó¥‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏ã‰∏ÄÊ¨°Ê£ÄÊü•ÁöÑÈó¥Èöî
            const nextInterval = this.getRandomInterval(currentConfig.movementInterval);
            
            this.epstein.movementTimer = setTimeout(() => {
                this.checkMovement();
                // ÈÄíÂΩíË∞ÉÂ∫¶‰∏ã‰∏ÄÊ¨°Ê£ÄÊü•
                scheduleNextCheck();
            }, nextInterval);
        };
        
        // ÂºÄÂßãÁ¨¨‰∏ÄÊ¨°Ë∞ÉÂ∫¶
        scheduleNextCheck();
    }
    
    // ÂºÄÂßãTrumpÁöÑÁßªÂä®Ê£ÄÊü•Âæ™ÁéØ
    startTrumpMovementLoop() {
        // ‰ΩøÁî® setTimeout ËÄå‰∏çÊòØ setIntervalÔºå‰ª•ÊîØÊåÅÂä®ÊÄÅÈó¥Èöî
        const scheduleNextCheck = () => {
            // Night 5ÁâπÊÆäÊú∫Âà∂Ôºö4AMÂêéTrumpÂèòÂæóÊõ¥ÊøÄËøõ
            let currentConfig = this.currentTrumpConfig;
            if (this.game.state.currentNight === 5 && this.game.state.currentTime >= 4) {
                // 4AMÂêé‰ΩøÁî®Êõ¥ÊøÄËøõÁöÑÈÖçÁΩÆ
                currentConfig = {
                    ...this.currentTrumpConfig,
                    movementInterval: [6000, 7000], // 6-7ÁßíÈó¥Èöî
                    movementProbability: {
                        forward: 1.0,
                        lateral: 0.0,
                        backward: 0.0
                    }
                };
            }
            
            // ‰ªéÈÖçÁΩÆÂå∫Èó¥‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏ã‰∏ÄÊ¨°Ê£ÄÊü•ÁöÑÈó¥Èöî
            const nextInterval = this.getRandomInterval(currentConfig.movementInterval);
            
            this.trump.movementTimer = setTimeout(() => {
                this.checkTrumpMovement();
                // ÈÄíÂΩíË∞ÉÂ∫¶‰∏ã‰∏ÄÊ¨°Ê£ÄÊü•
                scheduleNextCheck();
            }, nextInterval);
        };
        
        // ÂºÄÂßãÁ¨¨‰∏ÄÊ¨°Ë∞ÉÂ∫¶
        scheduleNextCheck();
    }

    // Ê£ÄÊü•ÊòØÂê¶ÁßªÂä®ÔºàFNAFÊú∫Âà∂Ôºâ
    checkMovement() {
        // Â¶ÇÊûúËøòÊú™Âá∫Âú∫Ôºå‰∏çÁßªÂä®
        if (!this.epstein.hasSpawned) return;
        
        // Â¶ÇÊûúAIÁ≠âÁ∫ß‰∏∫0Ôºå‰∏çÁßªÂä®
        if (this.epstein.aiLevel === 0) return;
        
        // Â¶ÇÊûúÂ∑≤ÁªèÂú®ÂäûÂÖ¨ÂÆ§Ôºå‰∏çÂÜçÁßªÂä®
        if (this.epstein.currentLocation === 'office') return;
        
        // ÁîüÊàêÈöèÊú∫Êï∞ 1-20
        const randomNumber = Math.floor(Math.random() * 20) + 1;
        
        // Â¶ÇÊûúÈöèÊú∫Êï∞ <= AIÁ≠âÁ∫ßÔºåÁßªÂä®ÊàêÂäü
        if (randomNumber <= this.epstein.aiLevel) {
            this.moveToNextLocation();
        }
    }
    
    // Ê£ÄÊü•TrumpÊòØÂê¶ÁßªÂä®
    checkTrumpMovement() {
        // Â¶ÇÊûúËøòÊú™Âá∫Âú∫Ôºå‰∏çÁßªÂä®
        if (!this.trump.hasSpawned) return;
        
        // Â¶ÇÊûúAIÁ≠âÁ∫ß‰∏∫0Ôºå‰∏çÁßªÂä®
        if (this.trump.aiLevel === 0) return;
        
        // Â¶ÇÊûúÂ∑≤ÁªèÂú®ÂäûÂÖ¨ÂÆ§Ôºå‰∏çÂÜçÁßªÂä®
        if (this.trump.currentLocation === 'office') return;
        
        // ÁîüÊàêÈöèÊú∫Êï∞ 1-20
        const randomNumber = Math.floor(Math.random() * 20) + 1;
        
        // Â¶ÇÊûúÈöèÊú∫Êï∞ <= AIÁ≠âÁ∫ßÔºåÁßªÂä®ÊàêÂäü
        if (randomNumber <= this.trump.aiLevel) {
            this.moveTrumpToNextLocation();
        }
    }

    // ÁßªÂä®Âà∞‰∏ã‰∏Ä‰∏™‰ΩçÁΩÆÔºàÊîØÊåÅÂâçËøõ„ÄÅÂπ≥Áßª„ÄÅÂêéÈÄÄÔºâ
    moveToNextLocation() {
        const currentLoc = this.epstein.currentLocation;
        const currentDepth = this.locationDepth[currentLoc];
        
        // Night 4ÁâπÊÆäÊú∫Âà∂Ôºö4AMÂêéEPÂèòÂæóÊõ¥ÊøÄËøõ
        let config = this.currentEpsteinConfig;
        if (this.game.state.currentNight === 4 && this.game.state.currentTime >= 4) {
            config = {
                ...this.currentEpsteinConfig,
                movementProbability: {
                    forward: 1.0,
                    lateral: 0.0,
                    backward: 0.0
                }
            };
            // Âè™Âú®Á¨¨‰∏ÄÊ¨°Ëß¶ÂèëÊó∂ÊòæÁ§∫Êó•Âøó
            if (!this.epstein.night4AggressiveMode) {
                console.log('‚ö° Night 4: 4AM reached! EP is now in aggressive mode (forward only)');
                this.epstein.night4AggressiveMode = true;
            }
        }
        
        // Ëé∑ÂèñÊâÄÊúâ‰ΩçÁΩÆÔºà‰∏çÈôê‰∫éÈÇªÂ±ÖÔºâ
        const allLocations = Object.keys(this.locationDepth).filter(loc => 
            loc !== 'office' && loc !== currentLoc
        );
        
        // Ëé∑ÂèñÈÇªËøëÊàøÈó¥
        const adjacentLocs = this.adjacentRooms[currentLoc] || [];
        
        // ÂàÜÁ±ªÊâÄÊúâÂèØËÉΩÁöÑÁßªÂä®‰ΩçÁΩÆ
        // ÂâçËøõÔºöÊâÄÊúâÊ≠•ÈïøÂáè1ÁöÑ‰ΩçÁΩÆÔºà‰∏çÈôê‰∫éÈÇªËøëÔºâ
        const forwardLocations = allLocations.filter(loc => this.locationDepth[loc] === currentDepth - 1);
        // Âπ≥ÁßªÔºöÂè™ËÉΩÁßªÂä®Âà∞ÈÇªËøëÊàøÈó¥‰∏îÊ≠•ÈïøÁõ∏ÂêåÁöÑ‰ΩçÁΩÆ
        const lateralLocations = adjacentLocs.filter(loc => this.locationDepth[loc] === currentDepth);
        // ÂêéÈÄÄÔºöÂè™ËÉΩÁßªÂä®Âà∞ÈÇªËøëÊàøÈó¥‰∏îÊ≠•ÈïøÂä†1ÁöÑ‰ΩçÁΩÆ
        const backwardLocations = adjacentLocs.filter(loc => this.locationDepth[loc] === currentDepth + 1);
        
        // Â¶ÇÊûúÂΩìÂâçÊ≠•ÈïøÊòØ1‰∏îÊ≤°ÊúâÂâçËøõ‰ΩçÁΩÆÔºåÂ∞ùËØïÁßªÂä®Âà∞office
        if (forwardLocations.length === 0 && currentDepth === 1) {
            console.log(`Epstein moved: ${currentLoc} -> office`);
            this.epstein.currentLocation = 'office';
            this.triggerJumpscare('epstein');
            return;
        }
        
        // Ê†πÊçÆÈÖçÁΩÆÊ¶ÇÁéáÂÜ≥ÂÆöÁßªÂä®ÊñπÂêë
        const movementProb = config.movementProbability;
        const totalProb = movementProb.forward + movementProb.lateral + movementProb.backward;
        
        // Â¶ÇÊûúÊÄªÊ¶ÇÁéá‰∏∫0ÊàñÊ≤°Êúâ‰ªª‰ΩïÂèØÁßªÂä®‰ΩçÁΩÆÔºå‰∏çÁßªÂä®
        if (totalProb === 0 || (forwardLocations.length === 0 && lateralLocations.length === 0 && backwardLocations.length === 0)) {
            console.log(`Epstein has no valid path from ${currentLoc}`);
            return;
        }
        
        // ÂΩí‰∏ÄÂåñÊ¶ÇÁéáÔºàÁ°Æ‰øùÊÄªÂíå‰∏∫1Ôºâ
        const normalizedProb = {
            forward: movementProb.forward / totalProb,
            lateral: movementProb.lateral / totalProb,
            backward: movementProb.backward / totalProb
        };
        
        // Ê†πÊçÆÊ¶ÇÁéáÈÄâÊã©ÁßªÂä®ÊñπÂêë
        const random = Math.random();
        let selectedLocations = [];
        let movementType = '';
        
        if (random < normalizedProb.forward && forwardLocations.length > 0) {
            // ÂâçËøõ
            selectedLocations = forwardLocations;
            movementType = 'forward';
        } else if (random < normalizedProb.forward + normalizedProb.lateral && lateralLocations.length > 0) {
            // Âπ≥Áßª
            selectedLocations = lateralLocations;
            movementType = 'lateral';
        } else if (backwardLocations.length > 0) {
            // ÂêéÈÄÄ
            selectedLocations = backwardLocations;
            movementType = 'backward';
        } else {
            // Â¶ÇÊûúÈÄâ‰∏≠ÁöÑÊñπÂêëÊ≤°ÊúâÂèØÁî®‰ΩçÁΩÆÔºåÂõûÈÄÄÂà∞ÂâçËøõÔºàÈªòËÆ§Ë°å‰∏∫Ôºâ
            if (forwardLocations.length > 0) {
                selectedLocations = forwardLocations;
                movementType = 'forward (fallback)';
            } else if (lateralLocations.length > 0) {
                selectedLocations = lateralLocations;
                movementType = 'lateral (fallback)';
            } else if (backwardLocations.length > 0) {
                selectedLocations = backwardLocations;
                movementType = 'backward (fallback)';
            } else {
                console.log(`Epstein has no valid path from ${currentLoc}`);
                return;
            }
        }
        
        // ‰ªéÈÄâ‰∏≠ÁöÑÊñπÂêë‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™‰ΩçÁΩÆ
        const nextLocation = selectedLocations[Math.floor(Math.random() * selectedLocations.length)];
        
        console.log(`Epstein moved [${movementType}]: ${currentLoc} (depth ${currentDepth}) -> ${nextLocation} (depth ${this.locationDepth[nextLocation]})`);
        
        this.epstein.currentLocation = nextLocation;
        
        // Êí≠ÊîæÁßªÂä®Èü≥Êïà
        this.game.assets.playSound('blip', false, 0.5);
        
        // Â¶ÇÊûúÂà∞ËææÂäûÂÖ¨ÂÆ§ÔºåËß¶ÂèëÊ∏∏ÊàèÁªìÊùü
        if (nextLocation === 'office') {
            this.triggerJumpscare('epstein');
            return;
        }
        
        // Â¶ÇÊûúÊëÑÂÉèÂ§¥ÊâìÂºÄ‰∏îÊ≤°ÊúâÊïÖÈöúÔºåÊó†ËÆ∫Êü•ÁúãÂì™‰∏™ÊëÑÂÉèÂ§¥ÈÉΩÊí≠ÊîæÂä®Áîª
        if (this.game.state.cameraOpen && !this.game.state.cameraFailed) {
            this.game.camera.playMovementTransition();
        }
        
        // Êõ¥Êñ∞ÊëÑÂÉèÂ§¥ÊòæÁ§∫
        this.updateCameraDisplay();
    }
    
    // TrumpÁßªÂä®Âà∞‰∏ã‰∏Ä‰∏™‰ΩçÁΩÆÔºàÊîØÊåÅÂâçËøõ„ÄÅÂπ≥Áßª„ÄÅÂêéÈÄÄÔºâ
    moveTrumpToNextLocation() {
        const currentLoc = this.trump.currentLocation;
        const currentDepth = this.trumpLocationDepth[currentLoc];
        
        // Night 5ÁâπÊÆäÊú∫Âà∂Ôºö4AMÂêéTrumpÂèòÂæóÊõ¥ÊøÄËøõ
        let config = this.currentTrumpConfig;
        if (this.game.state.currentNight === 5 && this.game.state.currentTime >= 4) {
            config = {
                ...this.currentTrumpConfig,
                movementProbability: {
                    forward: 1.0,
                    lateral: 0.0,
                    backward: 0.0
                },
                ventCrawling: {
                    ...this.currentTrumpConfig.ventCrawling,
                    cam1Probability: 1.0, // 4AMÂêéÂú®cam1ÂøÖÂÆöÁà¨Ë°å
                    cam2Probability: 0.8  // 4AMÂêéÂú®cam2Êúâ80%Ê¶ÇÁéáÁà¨Ë°å
                }
            };
            // Âè™Âú®Á¨¨‰∏ÄÊ¨°Ëß¶ÂèëÊó∂ÊòæÁ§∫Êó•Âøó
            if (!this.trump.night5AggressiveMode) {
                console.log('‚ö° Night 5: 4AM reached! Trump is now in aggressive mode (faster + more crawling)');
                this.trump.night5AggressiveMode = true;
            }
        }
        
        // Â¶ÇÊûúÊ≠£Âú®Áà¨Ë°åÔºå‰∏çËÉΩÁßªÂä®
        if (this.trump.isCrawling) {
            console.log('Trump is crawling, cannot move');
            return;
        }
        
        // Â¶ÇÊûúÂú®cam1ÔºåÊ†πÊçÆÈÖçÁΩÆÊ¶ÇÁéáÂÜ≥ÂÆöÊòØÂê¶Áà¨Ë°å
        if (currentLoc === 'cam1') {
            const shouldCrawl = Math.random() < config.ventCrawling.cam1Probability;
            if (shouldCrawl) {
                console.log(`Trump starting to crawl from ${currentLoc} to office (${config.ventCrawling.cam1Probability * 100}% chance)`);
                this.startTrumpCrawling(currentLoc);
                return;
            }
        }
        
        // Â¶ÇÊûúÂú®cam2ÔºåÊ†πÊçÆÈÖçÁΩÆÊ¶ÇÁéáÂÜ≥ÂÆöÊòØÂê¶Áà¨Ë°å
        if (currentLoc === 'cam2') {
            const shouldCrawl = Math.random() < config.ventCrawling.cam2Probability;
            if (shouldCrawl) {
                console.log(`Trump decided to crawl from ${currentLoc} to office (${config.ventCrawling.cam2Probability * 100}% chance)`);
                this.startTrumpCrawling(currentLoc);
                return;
            } else {
                console.log(`Trump decided to continue moving from ${currentLoc} (${(1 - config.ventCrawling.cam2Probability) * 100}% chance)`);
                // ÁªßÁª≠ÊâßË°åÊ≠£Â∏∏ÁßªÂä®ÈÄªËæë
            }
        }
        
        // Ëé∑ÂèñTrumpÂèØ‰ª•ÂéªÁöÑ‰ΩçÁΩÆ
        const allLocations = Object.keys(this.trumpLocationDepth).filter(loc => 
            loc !== 'office' && loc !== currentLoc
        );
        
        // Ëé∑ÂèñÈÇªËøëÊàøÈó¥
        const adjacentLocs = this.adjacentRooms[currentLoc] || [];
        
        // ÂàÜÁ±ªÊâÄÊúâÂèØËÉΩÁöÑÁßªÂä®‰ΩçÁΩÆ
        // ÂâçËøõÔºöÊâÄÊúâÊ≠•ÈïøÂáè1ÁöÑ‰ΩçÁΩÆÔºà‰∏çÈôê‰∫éÈÇªËøëÔºâ
        const forwardLocations = allLocations.filter(loc => this.trumpLocationDepth[loc] === currentDepth - 1);
        // Âπ≥ÁßªÔºöÂè™ËÉΩÁßªÂä®Âà∞ÈÇªËøëÊàøÈó¥‰∏îÊ≠•ÈïøÁõ∏ÂêåÁöÑ‰ΩçÁΩÆ
        const lateralLocations = adjacentLocs.filter(loc => this.trumpLocationDepth[loc] === currentDepth);
        // ÂêéÈÄÄÔºöÂè™ËÉΩÁßªÂä®Âà∞ÈÇªËøëÊàøÈó¥‰∏îÊ≠•ÈïøÂä†1ÁöÑ‰ΩçÁΩÆ
        const backwardLocations = adjacentLocs.filter(loc => this.trumpLocationDepth[loc] === currentDepth + 1);
        
        // Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÂèØÁßªÂä®‰ΩçÁΩÆÔºå‰∏çÁßªÂä®
        if (forwardLocations.length === 0 && lateralLocations.length === 0 && backwardLocations.length === 0) {
            console.log(`Trump has no valid path from ${currentLoc}`);
            return;
        }
        
        // Ê†πÊçÆÈÖçÁΩÆÊ¶ÇÁéáÂÜ≥ÂÆöÁßªÂä®ÊñπÂêë
        const movementProb = config.movementProbability;
        const totalProb = movementProb.forward + movementProb.lateral + movementProb.backward;
        
        // Â¶ÇÊûúÊÄªÊ¶ÇÁéá‰∏∫0Ôºå‰∏çÁßªÂä®
        if (totalProb === 0) {
            console.log(`Trump movement probability is 0`);
            return;
        }
        
        // ÂΩí‰∏ÄÂåñÊ¶ÇÁéá
        const normalizedProb = {
            forward: movementProb.forward / totalProb,
            lateral: movementProb.lateral / totalProb,
            backward: movementProb.backward / totalProb
        };
        
        // Ê†πÊçÆÊ¶ÇÁéáÈÄâÊã©ÁßªÂä®ÊñπÂêë
        const random = Math.random();
        let selectedLocations = [];
        let movementType = '';
        
        if (random < normalizedProb.forward && forwardLocations.length > 0) {
            selectedLocations = forwardLocations;
            movementType = 'forward';
        } else if (random < normalizedProb.forward + normalizedProb.lateral && lateralLocations.length > 0) {
            selectedLocations = lateralLocations;
            movementType = 'lateral';
        } else if (backwardLocations.length > 0) {
            selectedLocations = backwardLocations;
            movementType = 'backward';
        } else {
            // ÂõûÈÄÄÂà∞ÂèØÁî®ÁöÑÊñπÂêë
            if (forwardLocations.length > 0) {
                selectedLocations = forwardLocations;
                movementType = 'forward (fallback)';
            } else if (lateralLocations.length > 0) {
                selectedLocations = lateralLocations;
                movementType = 'lateral (fallback)';
            } else if (backwardLocations.length > 0) {
                selectedLocations = backwardLocations;
                movementType = 'backward (fallback)';
            } else {
                console.log(`Trump has no valid path from ${currentLoc}`);
                return;
            }
        }
        
        // ‰ªéÈÄâ‰∏≠ÁöÑÊñπÂêë‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™‰ΩçÁΩÆ
        const nextLocation = selectedLocations[Math.floor(Math.random() * selectedLocations.length)];
        
        console.log(`Trump moved [${movementType}]: ${currentLoc} (depth ${currentDepth}) -> ${nextLocation} (depth ${this.trumpLocationDepth[nextLocation]})`);
        
        this.trump.currentLocation = nextLocation;
        
        // Êí≠ÊîæÁßªÂä®Èü≥Êïà
        this.game.assets.playSound('blip', false, 0.5);
        
        // Â¶ÇÊûúÊëÑÂÉèÂ§¥ÊâìÂºÄ‰∏îÊ≤°ÊúâÊïÖÈöúÔºåÊí≠ÊîæÂä®Áîª
        if (this.game.state.cameraOpen && !this.game.state.cameraFailed) {
            this.game.camera.playMovementTransition();
        }
        
        // Êõ¥Êñ∞ÊëÑÂÉèÂ§¥ÊòæÁ§∫
        this.updateCameraDisplay();
    }
    
    // TrumpÂºÄÂßãÁà¨Ë°åËøõÂÖ•ÂäûÂÖ¨ÂÆ§
    startTrumpCrawling(fromLocation) {
        const config = this.currentTrumpConfig.ventCrawling;
        
        this.trump.isCrawling = true;
        this.trump.crawlingFrom = fromLocation; // ËÆ∞ÂΩï‰ªéÂì™ÈáåÂºÄÂßãÁà¨Ë°å
        this.trump.currentLocation = 'crawling'; // Ê†áËÆ∞‰∏∫Áà¨Ë°åÁä∂ÊÄÅ
        
        console.log(`Trump is crawling from ${fromLocation}...`);
        console.log(`Crawling config: soundDelay=${config.soundDelay}ms, soundDuration=${config.soundDuration}ms, totalDuration=${config.totalDuration}ms`);
        
        // Êõ¥Êñ∞ÊëÑÂÉèÂ§¥ÊòæÁ§∫ÔºàTrumpÊ∂àÂ§±Ôºâ
        this.updateCameraDisplay();
        
        // Ê†πÊçÆÈÖçÁΩÆÂª∂ËøüÂêéÂºÄÂßãÊí≠ÊîæÁà¨Ë°åÈü≥Êïà
        setTimeout(() => {
            // Ê£ÄÊü•TrumpÊòØÂê¶ËøòÂú®Áà¨Ë°åÔºàÂèØËÉΩÂ∑≤ÁªèË¢´ÈòªÊ≠¢Ôºâ
            if (this.trump.isCrawling && this.trump.currentLocation === 'crawling') {
                console.log('Playing crawling sound...');
                this.game.assets.playSound('ventCrawling', true, 0.8);
                
                // Ê†πÊçÆÈÖçÁΩÆÊåÅÁª≠Êó∂ÈïøÂêéÂÅúÊ≠¢Áà¨Ë°åÈü≥Êïà
                setTimeout(() => {
                    if (this.trump.isCrawling && this.trump.currentLocation === 'crawling') {
                        console.log('Stopping crawling sound...');
                        this.game.assets.stopSound('ventCrawling');
                    }
                }, config.soundDuration);
            }
        }, config.soundDelay);
        
        // Ê†πÊçÆÈÖçÁΩÆÊÄªÊó∂ÈïøÂêéÂà∞ËææÂäûÂÖ¨ÂÆ§Âπ∂Ëß¶ÂèëË∑≥ÊùÄ
        this.trump.crawlingTimer = setTimeout(() => {
            console.log('Trump reached the office!');
            this.trump.currentLocation = 'office';
            this.trump.isCrawling = false;
            this.trump.crawlingFrom = null;
            
            // ÂÅúÊ≠¢Áà¨Ë°åÈü≥ÊïàÔºàÂ¶ÇÊûúËøòÂú®Êí≠ÊîæÔºâ
            this.game.assets.stopSound('ventCrawling');
            
            // Ëß¶ÂèëË∑≥ÊùÄ
            this.triggerJumpscare('trump');
        }, config.totalDuration);
    }
    
    // ÈòªÊ≠¢TrumpÁà¨Ë°åÔºàÁé©ÂÆ∂ÂÖ≥Èó≠ÈÄöÈ£éÂè£Ôºâ
    stopTrumpCrawling() {
        if (!this.trump.isCrawling) {
            return false;
        }
        
        const config = this.currentTrumpConfig.ventCrawling;
        
        console.log('Trump crawling blocked by closed vents!');
        
        // Ê∏ÖÈô§Áà¨Ë°åËÆ°Êó∂Âô®
        if (this.trump.crawlingTimer) {
            clearTimeout(this.trump.crawlingTimer);
            this.trump.crawlingTimer = null;
        }
        
        // ÂÅúÊ≠¢Áà¨Ë°åÈü≥Êïà
        this.game.assets.stopSound('ventCrawling');
        
        // TrumpË¢´ÈòªÊ≠¢ÔºåÁ´ãÂç≥Âà§ÂÆöÁ¶ªÂºÄ
        this.trump.isCrawling = false;
        
        // ÊâæÂá∫ÊâÄÊúâÊ≠•Èïø‰∏∫3ÁöÑ‰ΩçÁΩÆ
        const depth3Locations = Object.keys(this.trumpLocationDepth).filter(loc => 
            this.trumpLocationDepth[loc] === 3 && loc !== 'office'
        );
        
        // Â¶ÇÊûúÊ≤°ÊúâÊ≠•Èïø‰∏∫3ÁöÑ‰ΩçÁΩÆÔºå‰ΩøÁî®EPÁöÑÊ≠•Èïø3‰ΩçÁΩÆ
        let retreatLocation;
        if (depth3Locations.length > 0) {
            // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Ê≠•Èïø‰∏∫3ÁöÑ‰ΩçÁΩÆ
            retreatLocation = depth3Locations[Math.floor(Math.random() * depth3Locations.length)];
        } else {
            // ‰ΩøÁî®EPÁöÑÊ≠•ÈïøÈÖçÁΩÆ‰∏≠ÁöÑÊ≠•Èïø3‰ΩçÁΩÆ
            const epDepth3Locations = Object.keys(this.locationDepth).filter(loc => 
                this.locationDepth[loc] === 3 && loc !== 'office'
            );
            retreatLocation = epDepth3Locations[Math.floor(Math.random() * epDepth3Locations.length)];
        }
        
        console.log(`Trump will retreat to ${retreatLocation} (depth 3)`);
        
        // Á´ãÂç≥ÁßªÂä®Âà∞Êí§ÈÄÄ‰ΩçÁΩÆ
        this.trump.currentLocation = retreatLocation;
        this.trump.crawlingFrom = null;
        
        // Êõ¥Êñ∞ÊëÑÂÉèÂ§¥ÊòæÁ§∫
        this.updateCameraDisplay();
        
        // Ê†πÊçÆÈÖçÁΩÆÂª∂ËøüÂêéÊí≠ÊîæÊí§ÈÄÄÈü≥Êïà
        setTimeout(() => {
            console.log('Playing retreat crawling sound...');
            this.game.assets.playSound('ventCrawling', false, 0.8);
            
            // Ê†πÊçÆÈÖçÁΩÆÊåÅÁª≠Êó∂ÈïøÂêéÂÅúÊ≠¢Èü≥Êïà
            setTimeout(() => {
                this.game.assets.stopSound('ventCrawling');
            }, config.retreatSoundDuration);
        }, config.retreatDelay);
        
        return true;
    }
    
    // Ê£ÄÊü•ÈÄöÈ£éÂè£Áä∂ÊÄÅÂèòÂåñÔºà‰ªéGame.jsË∞ÉÁî®Ôºâ
    onVentsChanged(ventsClosed) {
        // Â¶ÇÊûúTrumpÊ≠£Âú®Áà¨Ë°å‰∏îÁé©ÂÆ∂ÂÖ≥Èó≠‰∫ÜÈÄöÈ£éÂè£ÔºåÈòªÊ≠¢Trump
        if (this.trump.isCrawling && ventsClosed) {
            this.stopTrumpCrawling();
        }
    }
    
    // ‰ΩøÁî®soundÂê∏ÂºïÊïå‰∫∫Ôºà‰ªéCameraSystemË∞ÉÁî®Ôºâ
    attractToSound(soundLocation) {
        let epAttracted = false;
        let trumpAttracted = false;
        
        // Â∞ùËØïÂê∏ÂºïEP
        const epCurrentLoc = this.epstein.currentLocation;
        const adjacentToEp = this.adjacentRooms[epCurrentLoc];
        
        if (this.epstein.hasSpawned && adjacentToEp && adjacentToEp.includes(soundLocation)) {
            // Ê†πÊçÆÈÖçÁΩÆÊ£ÄÊü•ÊòØÂê¶ÊäµÊäósoundÂê∏Âºï
            const resistance = this.currentEpsteinConfig.soundLureResistance;
            if (resistance > 0) {
                const failChance = Math.random();
                if (failChance < resistance) {
                    console.log(`Epstein resisted the sound lure! (${resistance * 100}% chance on Night ${this.game.state.currentNight})`);
                    // Âê∏ÂºïÂ§±Ë¥•Ôºå‰ΩÜ‰ªçÁÑ∂Êí≠ÊîæÈü≥ÊïàËÆ©Áé©ÂÆ∂‰ª•‰∏∫ÊàêÂäü‰∫Ü
                    this.game.assets.playSound('blip', false, 0.5);
                    return false; // ËøîÂõûfalseË°®Á§∫Ê≤°ÊúâÁúüÊ≠£Âê∏ÂºïÂà∞
                }
            }
            
            // Âê∏ÂºïÊàêÂäüÔºåEPÁßªÂä®Âà∞sound‰ΩçÁΩÆÔºàÂèØ‰ª•ÂâçËøõÊàñÂêéÈÄÄÔºâ
            const currentDepth = this.locationDepth[epCurrentLoc];
            const soundDepth = this.locationDepth[soundLocation];
            console.log(`Epstein attracted by sound: ${epCurrentLoc} (depth ${currentDepth}) -> ${soundLocation} (depth ${soundDepth})`);
            
            this.epstein.currentLocation = soundLocation;
            
            // Êí≠ÊîæÁßªÂä®Èü≥Êïà
            this.game.assets.playSound('blip', false, 0.5);
            
            // Â¶ÇÊûúÂà∞ËææÂäûÂÖ¨ÂÆ§ÔºåËß¶ÂèëÊ∏∏ÊàèÁªìÊùü
            if (soundLocation === 'office') {
                this.triggerJumpscare('epstein');
            }
            
            epAttracted = true;
        } else {
            console.log(`Sound at ${soundLocation} is not adjacent to Epstein at ${epCurrentLoc}`);
        }
        
        // Â∞ùËØïÂê∏ÂºïTrumpÔºàÂ¶ÇÊûúÂ∑≤Âá∫Âú∫‰∏î‰∏çÂú®Áà¨Ë°åÁä∂ÊÄÅÔºâ
        const trumpCurrentLoc = this.trump.currentLocation;
        const adjacentToTrump = this.adjacentRooms[trumpCurrentLoc];
        
        if (this.trump.hasSpawned && !this.trump.isCrawling && adjacentToTrump && adjacentToTrump.includes(soundLocation)) {
            // Âê∏ÂºïÊàêÂäüÔºåTrumpÁßªÂä®Âà∞sound‰ΩçÁΩÆÔºàÂèØ‰ª•ÂâçËøõÊàñÂêéÈÄÄÔºâ
            const currentDepth = this.trumpLocationDepth[trumpCurrentLoc];
            const soundDepth = this.trumpLocationDepth[soundLocation];
            console.log(`Trump attracted by sound: ${trumpCurrentLoc} (depth ${currentDepth}) -> ${soundLocation} (depth ${soundDepth})`);
            
            this.trump.currentLocation = soundLocation;
            
            // Êí≠ÊîæÁßªÂä®Èü≥ÊïàÔºàÂ¶ÇÊûúEPÊ≤°ÊúâÊí≠ÊîæÔºâ
            if (!epAttracted) {
                this.game.assets.playSound('blip', false, 0.5);
            }
            
            // Â¶ÇÊûúÂà∞ËææÂäûÂÖ¨ÂÆ§ÔºåËß¶ÂèëÊ∏∏ÊàèÁªìÊùü
            if (soundLocation === 'office') {
                this.triggerJumpscare('trump');
            }
            
            trumpAttracted = true;
        } else if (this.trump.hasSpawned && !this.trump.isCrawling) {
            console.log(`Sound at ${soundLocation} is not adjacent to Trump at ${trumpCurrentLoc}`);
        }
        
        // Ê≥®ÊÑèÔºö‰∏çÂú®ËøôÈáåÊõ¥Êñ∞ÊòæÁ§∫ÔºåÁî±CameraSystemÁöÑÂä®ÁîªÂ§ÑÁêÜ
        
        return epAttracted || trumpAttracted;
    }
    
    // Ëß¶ÂèëÊëÑÂÉèÂ§¥ÊïÖÈöú
    triggerCameraFailure() {
        console.log('Camera system failure!');
        this.game.state.cameraFailed = true;
        
        // Êí≠ÊîæÈùôÊÄÅÂô™Èü≥
        this.game.assets.playSound('static', true, 1.0);
        
        // Â¶ÇÊûúÊëÑÂÉèÂ§¥ÊâìÂºÄÔºåÁ´ãÂç≥ÊòæÁ§∫ÊïÖÈöúÊïàÊûú
        if (this.game.state.cameraOpen) {
            this.game.camera.showCameraFailure();
        }
        // Â¶ÇÊûúÊëÑÂÉèÂ§¥Ê≤°ÊâìÂºÄÔºå‰∏ãÊ¨°ÊâìÂºÄÊó∂‰ºöËá™Âä®ÊòæÁ§∫ÊïÖÈöúÊïàÊûúÔºàÂú®open()ÊñπÊ≥ï‰∏≠Ôºâ
    }

    // Êõ¥Êñ∞ÊëÑÂÉèÂ§¥ÊòæÁ§∫
    updateCameraDisplay() {
        // Áõ¥Êé•Ë∞ÉÁî® CameraSystem ÁöÑÊòæÁ§∫ÊñπÊ≥ï
        if (this.game.camera) {
            this.game.camera.updateCharacterDisplay();
        }
    }

    // Ëß¶ÂèëË∑≥ÊùÄ
    triggerJumpscare(enemy = 'epstein') {
        console.log(`JUMPSCARE by ${enemy}!`);
        this.stop();
        
        // ÈúçÈáëÁöÑÁâπÊÆäË∑≥ÊùÄÂä®Áîª
        if (enemy === 'hawking') {
            this.triggerHawkingMissileJumpscare();
            return;
        }
        
        // ÂÅúÊ≠¢ÊâÄÊúâÈü≥Êïà
        this.game.assets.stopSound('vents');
        this.game.assets.stopSound('static');
        
        // ÂàõÂª∫Ë∑≥ÊùÄÂä®ÁîªÂÆπÂô®
        const jumpscareContainer = document.createElement('div');
        jumpscareContainer.id = 'jumpscare-container';
        jumpscareContainer.style.position = 'fixed';
        jumpscareContainer.style.top = '0';
        jumpscareContainer.style.left = '0';
        jumpscareContainer.style.width = '100%';
        jumpscareContainer.style.height = '100%';
        jumpscareContainer.style.display = 'flex';
        jumpscareContainer.style.alignItems = 'center';
        jumpscareContainer.style.justifyContent = 'center';
        jumpscareContainer.style.zIndex = '99999';
        jumpscareContainer.style.overflow = 'hidden';
        
        // ÂàõÂª∫ÂäûÂÖ¨ÂÆ§ËÉåÊôØ
        const officeBackground = document.createElement('img');
        officeBackground.src = this.game.assets.images.office.src;
        officeBackground.style.position = 'absolute';
        officeBackground.style.top = '0';
        officeBackground.style.left = '0';
        officeBackground.style.width = '100%';
        officeBackground.style.height = '100%';
        officeBackground.style.objectFit = 'cover';
        officeBackground.style.zIndex = '1';
        
        // ÂàõÂª∫Ë∑≥ÊùÄÂõæÁâáÔºàÂ±Ö‰∏≠ÊòæÁ§∫Ôºâ
        const jumpscareImg = document.createElement('img');
        // Ê†πÊçÆÊïå‰∫∫ÈÄâÊã©Ë∑≥ÊùÄÂõæÁâá
        if (enemy === 'trump') {
            jumpscareImg.src = this.game.assets.images.trumpJumpscare?.src || this.game.assets.images.jumpscare.src;
        } else if (enemy === 'hawking') {
            jumpscareImg.src = this.game.assets.images.hawkingJumpscare?.src || this.game.assets.images.jumpscare.src;
        } else {
            jumpscareImg.src = this.game.assets.images.jumpscare.src;
        }
        jumpscareImg.style.position = 'absolute';
        jumpscareImg.style.top = '50%';
        jumpscareImg.style.left = '50%';
        jumpscareImg.style.transform = 'translate(-50%, -50%)';
        jumpscareImg.style.width = '25%'; // ÂàùÂßãÂ§ßÂ∞è25%
        jumpscareImg.style.height = 'auto';
        jumpscareImg.style.zIndex = '2';
        jumpscareImg.style.transition = 'none';
        
        jumpscareContainer.appendChild(officeBackground);
        jumpscareContainer.appendChild(jumpscareImg);
        document.body.appendChild(jumpscareContainer);
        
        // Êí≠ÊîæË∑≥ÊùÄÈü≥Êïà
        if (enemy === 'hawking') {
            this.game.assets.playSound('hawkingJumpscare', false, 1.0);
        } else {
            this.game.assets.playSound('jumpscare', false, 1.0);
        }
        
        // Á¨¨1Â∏ßÔºö25% (Á´ãÂç≥ÊòæÁ§∫)
        // Â∑≤ÁªèËÆæÁΩÆ
        
        // Á¨¨2Â∏ßÔºö50% (0.15ÁßíÂêé)
        setTimeout(() => {
            jumpscareImg.style.width = '50%';
        }, 150);
        
        // Á¨¨3Â∏ßÔºö100% (0.3ÁßíÂêé)
        setTimeout(() => {
            jumpscareImg.style.width = '100%';
        }, 300);
        
        // 1.5ÁßíÂêéÊ∑°Âá∫Âπ∂ÊòæÁ§∫Ê∏∏ÊàèÁªìÊùüÁîªÈù¢
        setTimeout(() => {
            jumpscareContainer.style.transition = 'opacity 0.5s';
            jumpscareContainer.style.opacity = '0';
            
            setTimeout(() => {
                document.body.removeChild(jumpscareContainer);
                this.game.gameOver('GAME OVER');
            }, 500);
        }, 1500);
    }

    // Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ
    getCurrentLocation() {
        return this.epstein.currentLocation;
    }
    
    // Ëé∑ÂèñÂΩìÂâçEPÁöÑÂõæÁâáÔºàÊ†πÊçÆÂ§úÊï∞ÈÄâÊã©ÊòØÂê¶Â∏¶ÁîµÁúºÔºâ
    getCurrentImage(cam, night) {
        if (night === 6 && this.characterImagesNight6[cam]) {
            return this.characterImagesNight6[cam];
        }
        return this.characterImages[cam];
    }
    
    // Ëé∑ÂèñTrumpÂΩìÂâç‰ΩçÁΩÆ
    getTrumpCurrentLocation() {
        return this.trump.currentLocation;
    }
    
    // Ê£ÄÊü•TrumpÊòØÂê¶Ê≠£Âú®Áà¨Ë°å
    isTrumpCrawling() {
        return this.trump.isCrawling;
    }

    // ÈáçÁΩÆAI
    reset() {
        this.stop();
        
        // ÈáçÁΩÆ Epstein
        this.epstein.currentLocation = 'cam11';
        this.epstein.aiLevel = 0;
        this.epstein.hasMovedOnce = false;
        this.epstein.hasSpawned = false;
        this.epstein.night4AggressiveMode = false; // ÈáçÁΩÆNight 4ÊøÄËøõÊ®°ÂºèÊ†áÂøó
        if (this.epstein.timer) {
            clearTimeout(this.epstein.timer);
            this.epstein.timer = null;
        }
        
        // ÈáçÁΩÆ Trump
        this.trump.currentLocation = 'cam10';
        this.trump.aiLevel = 0;
        this.trump.hasSpawned = false;
        this.trump.isCrawling = false;
        this.trump.crawlingFrom = null;
        this.trump.night5AggressiveMode = false; // ÈáçÁΩÆNight 5ÊøÄËøõÊ®°ÂºèÊ†áÂøó
        if (this.trump.timer) {
            clearTimeout(this.trump.timer);
            this.trump.timer = null;
        }
        if (this.trump.crawlingTimer) {
            clearTimeout(this.trump.crawlingTimer);
            this.trump.crawlingTimer = null;
        }
        if (this.trump.retreatTimer) {
            clearTimeout(this.trump.retreatTimer);
            this.trump.retreatTimer = null;
        }
        
        // ÈáçÁΩÆ Hawking
        this.hawking.active = false;
        this.hawking.warningLevel = 0;
        if (this.hawking.timer) {
            clearTimeout(this.hawking.timer);
            this.hawking.timer = null;
        }
        if (this.hawking.warningTimer) {
            clearTimeout(this.hawking.warningTimer);
            this.hawking.warningTimer = null;
        }
        if (this.hawking.attackTimer) {
            clearTimeout(this.hawking.attackTimer);
            this.hawking.attackTimer = null;
        }
        this.hideHawkingWarning();
        
        // Ê∏ÖÈô§ÊâÄÊúâËßíËâ≤ÊòæÁ§∫
        const characterOverlay = document.getElementById('character-overlay');
        if (characterOverlay) {
            characterOverlay.innerHTML = '';
        }
        
        console.log('EnemyAI reset complete');
    }
    
    // ÂêØÂä®ÈúçÈáëÊú∫Âà∂
    startHawking() {
        this.hawking.active = true;
        this.hawking.warningLevel = 0;
        console.log('Hawking started at cam6');
        
        // 20ÁßíÂêéÂºÄÂßãÈªÑËâ≤Ë≠¶Âëä
        this.hawking.timer = setTimeout(() => {
            this.showHawkingWarning('yellow');
        }, 20000);
    }
    
    // ÊòæÁ§∫ÈúçÈáëË≠¶Âëä
    showHawkingWarning(level) {
        if (!this.hawking.active) return;
        
        console.log(`Hawking warning: ${level}`);
        
        if (level === 'yellow') {
            this.hawking.warningLevel = 1;
            this.updateHawkingWarningDisplay();
            
            // 5ÁßíÂêéÂçáÁ∫ß‰∏∫Á∫¢Ëâ≤Ë≠¶Âëä
            this.hawking.warningTimer = setTimeout(() => {
                this.showHawkingWarning('red');
            }, 5000);
        } else if (level === 'red') {
            this.hawking.warningLevel = 2;
            this.updateHawkingWarningDisplay();
            
            // 5ÁßíÂêéÊëÑÂÉèÂ§¥ÂùèÊéâ
            this.hawking.warningTimer = setTimeout(() => {
                this.hawkingBreakCamera();
            }, 5000);
        }
    }
    
    // Êõ¥Êñ∞ÈúçÈáëË≠¶ÂëäÊòæÁ§∫
    updateHawkingWarningDisplay() {
        let warningIcon = document.getElementById('hawking-warning-icon');
        
        if (!warningIcon) {
            warningIcon = document.createElement('img');
            warningIcon.id = 'hawking-warning-icon';
            warningIcon.style.position = 'absolute';
            warningIcon.style.zIndex = '1000';
            warningIcon.style.display = 'block';
            warningIcon.style.animation = 'flash 0.5s infinite';
            
            // Ê†πÊçÆÊëÑÂÉèÂ§¥Áä∂ÊÄÅÂÜ≥ÂÆöÊ∑ªÂä†Âà∞Âì™Èáå
            if (this.game.state.cameraOpen) {
                const cameraGrid = document.getElementById('camera-grid');
                if (cameraGrid) {
                    cameraGrid.appendChild(warningIcon);
                }
            } else {
                document.body.appendChild(warningIcon);
            }
        }
        
        // Ê†πÊçÆÊëÑÂÉèÂ§¥Áä∂ÊÄÅÂÜ≥ÂÆö‰ΩçÁΩÆÂíåÂ§ßÂ∞è
        if (this.game.state.cameraOpen) {
            // ÊëÑÂÉèÂ§¥ÊâìÂºÄÔºöÂú®Âú∞Âõæ‰∏ä cam6 Âè≥ËæπÔºå‰ΩøÁî®Áõ∏ÂØπ‰∫éÂú∞ÂõæÁöÑÁôæÂàÜÊØîÂÆö‰Ωç
            // cam6 ‰ΩçÁΩÆ: x: 77.2%, y: 82.2%, width: 13.0%, height: 8.0%
            // Ë≠¶ÂëäÂõæÊ†áÊîæÂú® cam6 Âè≥Ëæπ
            warningIcon.style.position = 'absolute';
            warningIcon.style.left = '91%'; // 77.2% + 13.0% + Â∞èÈó¥Ë∑ù
            warningIcon.style.top = '82.2%';
            warningIcon.style.width = '11.2%'; // 8% * 1.4 = 11.2%
            warningIcon.style.height = 'auto';
            warningIcon.style.transform = 'none';
            
            // Á°Æ‰øùÂú®Âú∞ÂõæÂÆπÂô®‰∏≠
            const cameraGrid = document.getElementById('camera-grid');
            if (cameraGrid && warningIcon.parentElement !== cameraGrid) {
                cameraGrid.appendChild(warningIcon);
            }
        } else {
            // ÊëÑÂÉèÂ§¥ÂÖ≥Èó≠ÔºöÂú®È£éÊâáÊ†áÂøóÔºàÊ∞ßÊ∞îÊòæÁ§∫ÔºâÂ∑¶ËæπÔºå‰ΩøÁî® fixed ÂÆö‰Ωç
            warningIcon.style.position = 'fixed';
            warningIcon.style.left = 'auto';
            warningIcon.style.right = 'calc(2vw + 15vw)'; // Ê∞ßÊ∞îÊòæÁ§∫Âè≥ËæπË∑ù + Ê∞ßÊ∞îÊòæÁ§∫ÂÆΩÂ∫¶ + Èó¥Ë∑ù
            warningIcon.style.top = 'auto';
            warningIcon.style.bottom = '2vh';
            warningIcon.style.width = '3vw';
            warningIcon.style.height = 'auto';
            warningIcon.style.transform = 'none';
            
            // Á°Æ‰øùÂú® body ‰∏≠
            if (warningIcon.parentElement !== document.body) {
                document.body.appendChild(warningIcon);
            }
        }
        
        // ËÆæÁΩÆË≠¶ÂëäÂõæÁâá
        if (this.hawking.warningLevel === 1) {
            warningIcon.src = '/FNAE-HTML5-1.1.5/assets/images/Warninglight.png';
        } else if (this.hawking.warningLevel === 2) {
            warningIcon.src = '/FNAE-HTML5-1.1.5/assets/images/Warningheavy.png';
        }
    }
    
    // ÈöêËóèÈúçÈáëË≠¶Âëä
    hideHawkingWarning() {
        const warningIcon = document.getElementById('hawking-warning-icon');
        if (warningIcon) {
            warningIcon.remove();
        }
    }
    
    // ÈúçÈáëÁ†¥ÂùèÊëÑÂÉèÂ§¥
    hawkingBreakCamera() {
        console.log('Hawking broke the camera!');
        
        // ÈöêËóèË≠¶Âëä
        this.hideHawkingWarning();
        
        // ÊëÑÂÉèÂ§¥ÂùèÊéâ
        this.triggerCameraFailure();
        
        // ÈúçÈáë‰ªécam6Ê∂àÂ§±
        this.hawking.active = false;
        this.updateCameraDisplay();
        
        // 4ÁßíÂêéË∑≥ÊùÄ
        this.hawking.attackTimer = setTimeout(() => {
            this.triggerJumpscare('hawking');
        }, 4000);
    }
    
    // ÈúçÈáëÁöÑÂØºÂºπË∑≥ÊùÄÂä®Áîª
    triggerHawkingMissileJumpscare() {
        console.log('Hawking missile jumpscare!');
        
        // ÂÅúÊ≠¢ÊâÄÊúâÈü≥Êïà
        this.game.assets.stopSound('vents');
        this.game.assets.stopSound('static');
        
        // ÂàõÂª∫Ë∑≥ÊùÄÂä®ÁîªÂÆπÂô®
        const jumpscareContainer = document.createElement('div');
        jumpscareContainer.id = 'jumpscare-container';
        jumpscareContainer.style.position = 'fixed';
        jumpscareContainer.style.top = '0';
        jumpscareContainer.style.left = '0';
        jumpscareContainer.style.width = '100%';
        jumpscareContainer.style.height = '100%';
        jumpscareContainer.style.zIndex = '99999';
        jumpscareContainer.style.overflow = 'hidden';
        jumpscareContainer.style.backgroundColor = '#000';
        
        // ÂàõÂª∫ÂäûÂÖ¨ÂÆ§ËÉåÊôØ
        const officeBackground = document.createElement('img');
        officeBackground.src = this.game.assets.images.office.src;
        officeBackground.style.position = 'absolute';
        officeBackground.style.top = '0';
        officeBackground.style.left = '0';
        officeBackground.style.width = '100%';
        officeBackground.style.height = '100%';
        officeBackground.style.objectFit = 'cover';
        officeBackground.style.zIndex = '1';
        
        // ÂàõÂª∫ÈúçÈáëÂõæÁâáÔºàÂú®ÊàøÈó¥ÈáåÔºâ
        const hawkingImg = document.createElement('img');
        hawkingImg.src = '/FNAE-HTML5-1.1.5/assets/images/mrstephen.png';
        hawkingImg.style.position = 'absolute';
        hawkingImg.style.left = '43.6%';
        hawkingImg.style.bottom = '27.4%';
        hawkingImg.style.width = '30%';
        hawkingImg.style.height = 'auto';
        hawkingImg.style.zIndex = '2';
        hawkingImg.style.filter = 'brightness(0.68) contrast(1) saturate(1)';
        
        // ÂàõÂª∫ÂØºÂºπÂõæÁâáÔºà‰ªéÈúçÈáë‰ΩçÁΩÆÈ£ûÂêëÁé©ÂÆ∂Ôºâ
        const missileImg = document.createElement('img');
        missileImg.src = '/FNAE-HTML5-1.1.5/assets/images/front.png';
        missileImg.style.position = 'absolute';
        missileImg.style.left = '25%';
        missileImg.style.top = '40%';
        missileImg.style.width = '5%';
        missileImg.style.height = 'auto';
        missileImg.style.zIndex = '3';
        missileImg.style.transition = 'all 1s ease-out';
        
        // ÂàõÂª∫ÁàÜÁÇ∏Â∏ßÂõæÂÆπÂô®ÔºàÂàùÂßãÈöêËóèÔºâ
        const explosionImg = document.createElement('div');
        explosionImg.style.position = 'absolute';
        explosionImg.style.top = '50%';
        explosionImg.style.left = '50%';
        explosionImg.style.transform = 'translate(-50%, -50%)';
        explosionImg.style.width = '50vw'; // ÂÆπÂô®ÂÆΩÂ∫¶
        explosionImg.style.height = '50vh'; // ÂÆπÂô®È´òÂ∫¶
        explosionImg.style.zIndex = '4';
        explosionImg.style.backgroundImage = 'url(/FNAE-HTML5-1.1.5/assets/images/exp2.png)';
        explosionImg.style.backgroundSize = '400% auto'; // 4ÂàóÔºåÈ´òÂ∫¶Ëá™ÈÄÇÂ∫î
        explosionImg.style.backgroundRepeat = 'no-repeat';
        explosionImg.style.backgroundPosition = '0% 0%';
        explosionImg.style.display = 'none';
        
        jumpscareContainer.appendChild(officeBackground);
        jumpscareContainer.appendChild(hawkingImg);
        jumpscareContainer.appendChild(missileImg);
        jumpscareContainer.appendChild(explosionImg);
        document.body.appendChild(jumpscareContainer);
        
        // Êí≠ÊîæÈúçÈáëË∑≥ÊùÄÈü≥Êïà
        this.game.assets.playSound('hawkingJumpscare', false, 1.0);
        
        // ÂØºÂºπÈ£ûÂêëÁé©ÂÆ∂ÔºàÊîæÂ§ßÂπ∂ÁßªÂä®Âà∞‰∏≠ÂøÉÔºâ
        setTimeout(() => {
            missileImg.style.left = '50%';
            missileImg.style.top = '50%';
            missileImg.style.transform = 'translate(-50%, -50%)';
            missileImg.style.width = '80%';
        }, 50);
        
        // 1ÁßíÂêéÂØºÂºπÂà∞ËææÔºåÂºÄÂßãÁàÜÁÇ∏Âä®Áîª
        setTimeout(() => {
            missileImg.style.display = 'none';
            explosionImg.style.display = 'block';
            
            // Êí≠ÊîæÁàÜÁÇ∏Â∏ßÂä®ÁîªÔºà‰ΩøÁî®Á¨¨‰∏ÄÂàóÁöÑ4Â∏ßÔºåÂéüÂõæÊòØ4Âàó3Ë°åÔºâ
            let frame = 0;
            const totalFrames = 3; // 0-3ÂÖ±4Â∏ß
            const frameInterval = 80; // ÊØèÂ∏ß80ms
            
            // Á¨¨‰∏ÄÂàóÁöÑ4Â∏ßÂØπÂ∫îÁöÑY‰ΩçÁΩÆÔºàÊâãÂä®Ë∞ÉÊï¥ÂêéÁöÑÁ≤æÁ°Æ‰ΩçÁΩÆÔºâ
            const yPositions = [8.00, 36.50, 65.00, 93.00];
            
            const animateExplosion = setInterval(() => {
                // X‰ΩçÁΩÆÂõ∫ÂÆöÂú®0%ÔºàÁ¨¨‰∏ÄÂàóÔºâÔºåY‰ΩçÁΩÆ‰ΩøÁî®È¢ÑËÆæÊï∞ÁªÑ
                explosionImg.style.backgroundPosition = `0% ${yPositions[frame]}%`;
                
                frame++;
                if (frame > totalFrames) {
                    clearInterval(animateExplosion);
                    
                    // ÁàÜÁÇ∏Âä®ÁîªÁªìÊùüÂêéÊ∑°Âá∫
                    setTimeout(() => {
                        jumpscareContainer.style.transition = 'opacity 0.5s';
                        jumpscareContainer.style.opacity = '0';
                        
                        setTimeout(() => {
                            document.body.removeChild(jumpscareContainer);
                            this.game.gameOver('GAME OVER');
                        }, 500);
                    }, 200);
                }
            }, frameInterval);
        }, 1000);
    }
    
    // ÁîµÂáªÈúçÈáëÔºàÁé©ÂÆ∂ÁÇπÂáªÊåâÈíÆÔºâ
    shockHawking() {
        if (!this.hawking.active) {
            console.log('Hawking is not active');
            return false;
        }
        
        console.log('Hawking shocked! Resetting timer...');
        
        // Ê∏ÖÈô§ÊâÄÊúâËÆ°Êó∂Âô®
        if (this.hawking.timer) {
            clearTimeout(this.hawking.timer);
            this.hawking.timer = null;
        }
        if (this.hawking.warningTimer) {
            clearTimeout(this.hawking.warningTimer);
            this.hawking.warningTimer = null;
        }
        if (this.hawking.attackTimer) {
            clearTimeout(this.hawking.attackTimer);
            this.hawking.attackTimer = null;
        }
        
        // ÈáçÁΩÆË≠¶ÂëäÁ≠âÁ∫ß
        this.hawking.warningLevel = 0;
        this.hideHawkingWarning();
        
        // Êí≠ÊîæÁîµÂáªÈü≥Êïà
        this.game.assets.playSound('hawking_shock', false, 0.8);
        
        // 20ÁßíÂêéÈáçÊñ∞ÂºÄÂßãË≠¶Âëä
        this.hawking.timer = setTimeout(() => {
            this.showHawkingWarning('yellow');
        }, 20000);
        
        return true;
    }
}


// Main game class
class Game {
    constructor() {
        this.state = new GameState();
        this.assets = new AssetManager();
        this.ui = new UIManager(this);
        this.camera = new CameraSystem(this);
        this.enemyAI = new EnemyAI(this);
        this.input = new InputHandler(this);
        
        // Initialize CameraSystem's EP config (from EnemyAI)
        this.camera.initEPConfig();
        
        this.timeInterval = null;
        this.powerInterval = null;
        this.viewPosition = 0.25;
        this.isRotatingLeft = false;
        this.isRotatingRight = false;
        this.rotationSpeed = 0.015;
        
        this.initElements();
        this.bindEvents();
    }

    initElements() {
        this.mainMenu = document.getElementById('main-menu');
        this.gameScreen = document.getElementById('game-screen');
        this.gameOverElement = document.getElementById('game-over');
        this.gameOverText = document.getElementById('game-over-text');
        this.tutorialOverlay = document.getElementById('tutorial-overlay');
        this.tutorialGotItBtn = document.getElementById('tutorial-got-it');
        
        this.startBtn = document.getElementById('start-game');
        this.continueBtn = document.getElementById('continue-game');
        this.specialNightBtn = document.getElementById('special-night-btn');
        this.starIcon = document.getElementById('star-icon');
        this.starIcon2 = document.getElementById('star-icon-2');
        this.restartBtn = document.getElementById('restart');
        this.mainMenuBtn = document.getElementById('main-menu-btn');
    }

    bindEvents() {
        this.startBtn.addEventListener('click', () => this.startGame());
        this.continueBtn.addEventListener('click', () => this.continueGame());
        this.specialNightBtn.addEventListener('click', () => this.startSpecialNight());
        this.restartBtn.addEventListener('click', () => this.restartGame());
        this.mainMenuBtn.addEventListener('click', () => this.showMainMenu());
        this.tutorialGotItBtn.addEventListener('click', () => this.closeTutorial());
    }
    
    // Âä†ËΩΩ‰øùÂ≠òÁöÑËøõÂ∫¶
    loadProgress() {
        const savedNight = localStorage.getItem('fnae_current_night');
        if (savedNight) {
            const night = parseInt(savedNight);
            if (night > 1 && night <= this.state.maxNights) {
                this.state.currentNight = night;
                return true;
            }
        }
        return false;
    }
    
    // ‰øùÂ≠òËøõÂ∫¶
    saveProgress() {
        if (this.state.currentNight > 1) {
            localStorage.setItem('fnae_current_night', this.state.currentNight.toString());
        }
    }
    
    // Ê∏ÖÈô§ËøõÂ∫¶
    clearProgress() {
        localStorage.removeItem('fnae_current_night');
    }
    
    // Êõ¥Êñ∞ContinueÊåâÈíÆÊòæÁ§∫
    updateContinueButton() {
        if (this.loadProgress()) {
            this.continueBtn.classList.remove('hidden');
            this.continueBtn.textContent = `CONTINUE (NIGHT ${this.state.currentNight})`;
        } else {
            this.continueBtn.classList.add('hidden');
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Ëß£ÈîÅÁâπÊÆäÂ§úÊôö
        const night6Unlocked = localStorage.getItem('night6Unlocked');
        if (night6Unlocked === 'true') {
            this.specialNightBtn.classList.remove('hidden');
            this.starIcon.classList.remove('hidden');
        } else {
            this.specialNightBtn.classList.add('hidden');
            this.starIcon.classList.add('hidden');
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÈÄöÂÖ≥Night 6
        const night6Completed = localStorage.getItem('night6Completed');
        if (night6Completed === 'true') {
            this.starIcon2.classList.remove('hidden');
        } else {
            this.starIcon2.classList.add('hidden');
        }
        
        // ÊÅ¢Â§çÂà∞Night 1Ôºà‰∏çÂΩ±ÂìçÊåâÈíÆÊòæÁ§∫Ôºâ
        this.state.currentNight = 1;
    }
    
    // ContinueÊ∏∏ÊàèÔºà‰ªé‰øùÂ≠òÁöÑÂÖ≥Âç°ÂºÄÂßãÔºâ
    async continueGame() {
        if (this.loadProgress()) {
            this.mainMenu.classList.add('hidden');
            
            const menuMusic = document.getElementById('menu-music');
            if (menuMusic) {
                menuMusic.pause();
                menuMusic.currentTime = 0;
                menuMusic.loop = false;
            }
            
            // ÈáçÁΩÆÊïå‰∫∫AIÁä∂ÊÄÅ
            this.enemyAI.reset();
            
            // Áõ¥Êé•ÂºÄÂßãÊ∏∏ÊàèÔºå‰∏çÊí≠ÊîæËøáÂú∫Âä®Áîª
            await this.initGame();
        }
    }
    
    // ÂºÄÂßãÁâπÊÆäÂ§úÊôöÔºàNight 6Ôºâ
    async startSpecialNight() {
        this.state.currentNight = 6; // ËÆæÁΩÆ‰∏∫Night 6
        this.clearProgress(); // Ê∏ÖÈô§ÊôÆÈÄöËøõÂ∫¶
        
        this.mainMenu.classList.add('hidden');
        
        const menuMusic = document.getElementById('menu-music');
        if (menuMusic) {
            menuMusic.pause();
            menuMusic.currentTime = 0;
            menuMusic.loop = false;
        }
        
        // ÈáçÁΩÆÊïå‰∫∫AIÁä∂ÊÄÅ
        this.enemyAI.reset();
        
        // Áõ¥Êé•ÂºÄÂßãÊ∏∏ÊàèÔºå‰∏çÊí≠ÊîæËøáÂú∫Âä®Áîª
        await this.initGame();
    }

    async startGame() {
        // NEW GAMEÊÄªÊòØ‰ªéNight 1ÂºÄÂßã
        this.state.currentNight = 1;
        this.clearProgress(); // Ê∏ÖÈô§‰πãÂâçÁöÑËøõÂ∫¶
        
        this.mainMenu.classList.add('hidden');
        
        const menuMusic = document.getElementById('menu-music');
        if (menuMusic) {
            menuMusic.pause();
            menuMusic.currentTime = 0;
            menuMusic.loop = false;
        }
        
        // ÈáçÁΩÆÊïå‰∫∫AIÁä∂ÊÄÅ
        this.enemyAI.reset();
        
        const cutscene = document.getElementById('cutscene');
        cutscene.classList.remove('hidden');
        
        // Ëß¶ÂèëÊ∑°ÂÖ•ÊïàÊûú
        setTimeout(() => {
            cutscene.classList.add('fade-in');
        }, 50);
        
        let cutsceneEnded = false;
        
        const endCutscene = () => {
            if (cutsceneEnded) return;
            cutsceneEnded = true;
            
            // Ê∑°Âá∫ÊïàÊûú
            cutscene.classList.remove('fade-in');
            cutscene.classList.add('fade-out');
            
            // Á≠âÂæÖÊ∑°Âá∫ÂÆåÊàêÂêéÈöêËóèÂπ∂ÂºÄÂßãÊ∏∏Êàè
            setTimeout(() => {
                cutscene.classList.add('hidden');
                cutscene.classList.remove('fade-out');
                // ‰∏çÂú®ËøôÈáåÊòæÁ§∫Ê∏∏ÊàèÁîªÈù¢ÔºåËÆ©initGameÂ§ÑÁêÜ
                this.initGame();
            }, 3000);
            
            cutscene.removeEventListener('click', endCutscene);
            if (autoEndTimeout) clearTimeout(autoEndTimeout);
        };
        
        // ÁÇπÂáªË∑≥Ëøá
        cutscene.addEventListener('click', endCutscene);
        
        // 3ÁßíÂêéËá™Âä®ÂºÄÂßãÊ∑°Âá∫ÔºàÊÄªÂÖ±6ÁßíÔºö3ÁßíÊ∑°ÂÖ• + 3ÁßíÊ∑°Âá∫Ôºâ
        const autoEndTimeout = setTimeout(() => {
            endCutscene();
        }, 3000);
    }
    
    async initGame() {
        // console.log('üéÆ initGame called, currentNight:', this.state.currentNight);
        
        if (!this.assets.loaded) {
            await this.assets.loadAssets();
        }
        
        this.state.reset();
        
        // console.log('üéÆ After state.reset(), currentNight:', this.state.currentNight);
        
        // ÈáçÁΩÆÊëÑÂÉèÂ§¥Á≥ªÁªüÁöÑsoundÊåâÈíÆËÆ°Êï∞
        this.camera.resetSoundButtonCount();
        
        // ÊÅ¢Â§çÊëÑÂÉèÂ§¥Èù¢ÊùøÁöÑdisplayÔºà‰πãÂâçÂèØËÉΩË¢´Âº∫Âà∂ÈöêËóèÔºâ
        const cameraPanel = document.getElementById('camera-panel');
        if (cameraPanel) {
            cameraPanel.style.display = ''; // ÊÅ¢Â§çÈªòËÆ§
            // console.log('üéÆ Camera panel display restored');
        }
        
        // ÊòæÁ§∫ÊØèÊôöÂºÄÂßãÂú∫ÊôØÔºàÂú®ÊòæÁ§∫Ê∏∏ÊàèÁîªÈù¢‰πãÂâçÔºâ
        await this.showNightIntro();
        
        // console.log('üéÆ After showNightIntro(), currentNight:', this.state.currentNight);
        
        // ËøõÂú∫Âä®ÁîªÁªìÊùüÂêéÊâçÊòæÁ§∫Ê∏∏ÊàèÁîªÈù¢
        this.gameScreen.classList.add('active');
        
        this.ui.currentSceneImg.src = this.assets.images.office.src;
        this.ui.currentSceneImg.style.display = 'block';
        this.viewPosition = 0.25;
        this.ui.updateViewPosition(this.viewPosition);
        
        this.ui.update();
        this.ui.createHotspots();
        
        // ÂàùÂßãÂåñÈ£éÊâáÁä∂ÊÄÅÔºàÈÄöÈ£éÂè£ÈªòËÆ§ÊâìÂºÄÔºåÈ£éÊâáÂø´ÈÄüÊóãËΩ¨Ôºâ
        this.initVentFanAnimation();
        
        this.startGameLoop();
        this.startViewRotation();
        
        // Start enemy AI
        this.enemyAI.start();
        
        this.assets.playSound('vents', true);
        
        // Show tutorial
        if (this.state.currentNight === 1) {
            this.showTutorial('night1');
        } else if (this.state.currentNight === 2) {
            this.showTutorial('night2');
        } else if (this.state.currentNight === 3) {
            this.showTutorial('night3');
        }
        
        // console.log('üéÆ Before Golden check, currentNight:', this.state.currentNight);
        
        // Night 5: ÂøÖÂÆöËß¶Âèë Golden ÈúçÈáëÂΩ©ËõãÔºàÊîæÂú®ÊúÄÂêéÔºåÁ°Æ‰øùÊ∏∏ÊàèÂ∑≤ÂÆåÂÖ®ÂàùÂßãÂåñÔºâ
        if (this.state.currentNight === 5) {
            // console.log('üåü Night 5 detected, triggering Golden Stephen...');
            setTimeout(() => {
                this.showGoldenStephen();
            }, 1000); // ËøõÂÖ•Ê∏∏Êàè1ÁßíÂêéËß¶Âèë
        } // else {
            // console.log('‚ùå Not Night 5, currentNight is:', this.state.currentNight);
        // }
    }
    
    // ÂàùÂßãÂåñÈ£éÊâáÂä®ÁîªÁä∂ÊÄÅ
    initVentFanAnimation() {
        const ventIcon = document.querySelector('.vent-icon');
        if (ventIcon) {
            if (this.state.ventsClosed) {
                // ÈÄöÈ£éÂè£ÂÖ≥Èó≠ÔºåÈ£éÊâáÂÅúÊ≠¢
                ventIcon.classList.add('stopped');
                ventIcon.style.animation = 'none';
            } else {
                // ÈÄöÈ£éÂè£ÊâìÂºÄÔºåÈ£éÊâáÂø´ÈÄüÊóãËΩ¨
                ventIcon.classList.remove('stopped', 'slowing', 'speeding-up');
                ventIcon.style.animation = 'spin-fast 0.333s linear infinite';
            }
        }
    }
    
    showTutorial(type = 'night1') {
        const tutorialContent = document.getElementById('tutorial-content');
        if (!tutorialContent) return;
        
        if (type === 'night2') {
            // Night 2 ÊïôÁ®ãÔºöTrump
            tutorialContent.innerHTML = `
                <h2>DEFEND YOURSELF AGAINST TRUMP</h2>
                <p>
                    TRUMP WILL TRY TO ATTACK YOU THROUGH THE VENTS IN CAM 1 AND CAM 2, SO IF YOU HEAR BANGING IN THE VENTS HEAD OVER TO THE CONTROL PANEL AND CLOSE THEM. 
                    AFTER CLOSING THEM YOU WILL HEAR BANGING AGAIN AFTER A FEW SECONDS WHICH MEANS HE LEFT THE VENTS. YOU MUST OPEN THE VENTS OTHERWISE YOU WILL DIE FROM LACK OF OXYGEN. 
                    TRUMP CAN BE LURED WITH THE AUDIOS BUT YOUR MAIN PRIORITY WITH THE AUDIO LURES SHOULD BE EPSTEIN.
                </p>
                <button id="tutorial-got-it">GOT IT</button>
            `;
            // ÈáçÊñ∞ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
            const gotItBtn = document.getElementById('tutorial-got-it');
            if (gotItBtn) {
                gotItBtn.addEventListener('click', () => this.closeTutorial());
            }
        } else if (type === 'night3') {
            // Night 3 ÊïôÁ®ãÔºöÈúçÈáë
            tutorialContent.innerHTML = `
                <h2>DEFEND YOURSELF AGAINST STEPHEN HAWKING</h2>
                <p>
                    STEPHEN HAWKING ALWAYS STAYS AT CAM 6 AND HE IS NOT AFFECTED BY THE AUDIO LURES. 
                    ELECTROCUTE STEPHEN HAWKING EVERY ONCE IN A WHILE TO PREVENT HIM FROM LEAVING CAM 6.
                </p>
                <button id="tutorial-got-it">GOT IT</button>
            `;
            // ÈáçÊñ∞ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
            const gotItBtn = document.getElementById('tutorial-got-it');
            if (gotItBtn) {
                gotItBtn.addEventListener('click', () => this.closeTutorial());
            }
        } else {
            // Night 1 ÊïôÁ®ãÔºöEP
            tutorialContent.innerHTML = `
                <h2>DEFEND YOURSELF AGAINST EPSTEIN</h2>
                <p>
                    EPSTEIN ALWAYS STARTS AT CAM 11. USE THE CAMERA'S AUDIO LURE TO KEEP EPSTEIN FAR AWAY FROM YOU. 
                    MAKE SURE THE CAMERA YOU'RE PLAYING THE SOUND IN IS NEXT TO THE CAMERA WHERE EPSTEIN IS. 
                    PLAYING SOUND IN ONLY ONE SPOT WILL NOT WORK IF YOU DO IT TWICE OR MORE IN A ROW. 
                    USING THE AUDIO LURE TOO MUCH WILL LEAD TO THE CAMERAS BREAKING. 
                    TO FIX THEM HEAD TO THE CONTROL PANEL AND RESTART THE CAMERAS LIKE YOU JUST DID. 
                    EPSTEIN DOES NOT ATTACK THROUGH THE VENTS SO DON'T BOTHER CLOSING THEM FOR THIS NIGHT.
                </p>
                <button id="tutorial-got-it">GOT IT</button>
            `;
            // ÈáçÊñ∞ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
            const gotItBtn = document.getElementById('tutorial-got-it');
            if (gotItBtn) {
                gotItBtn.addEventListener('click', () => this.closeTutorial());
            }
        }
        
        this.tutorialOverlay.classList.remove('hidden');
        // Mark tutorial as active (but don't pause game, allow view rotation)
        this.state.tutorialActive = true;
    }
    
    closeTutorial() {
        this.tutorialOverlay.classList.add('hidden');
        // Close tutorial
        this.state.tutorialActive = false;
    }
    
    // Golden ÈúçÈáëÂΩ©ËõãÊïàÊûú
    showGoldenStephen() {
        console.log('üåü Golden Stephen Hawking appears!');
        
        // ÂàõÂª∫ÂÖ®Â±èÈáëËâ≤ÈúçÈáëÂõæÂ±Ç
        const goldenOverlay = document.createElement('div');
        goldenOverlay.id = 'golden-stephen-overlay';
        goldenOverlay.style.position = 'fixed';
        goldenOverlay.style.top = '0';
        goldenOverlay.style.left = '0';
        goldenOverlay.style.width = '100%';
        goldenOverlay.style.height = '100%';
        goldenOverlay.style.zIndex = '9999';
        goldenOverlay.style.pointerEvents = 'none';
        goldenOverlay.style.background = 'rgba(0, 0, 0, 0.3)';
        
        // ÂàõÂª∫ÈáëËâ≤ÈúçÈáëÂõæÁâá
        const goldenImg = document.createElement('img');
        goldenImg.src = '/FNAE-HTML5-1.1.5/assets/images/goldenstephen.png';
        goldenImg.style.position = 'absolute';
        goldenImg.style.top = '50%';
        goldenImg.style.left = '50%';
        goldenImg.style.transform = 'translate(-50%, -50%)';
        goldenImg.style.width = '80%';
        goldenImg.style.height = '80%';
        goldenImg.style.objectFit = 'contain';
        goldenImg.style.opacity = '0';
        goldenImg.style.animation = 'golden-flicker 2s ease-in-out';
        
        goldenOverlay.appendChild(goldenImg);
        document.body.appendChild(goldenOverlay);
        
        // Êí≠ÊîæÈü≥Êïà
        this.assets.playSound('goldenstephenscare', false, 1.0);
        
        // 2ÁßíÂêéÁßªÈô§
        setTimeout(() => {
            goldenOverlay.remove();
        }, 2000);
    }
    
    showNightIntro() {
        return new Promise((resolve) => {
            const nightIntro = document.getElementById('night-intro');
            const nightIntroText = document.getElementById('night-intro-text');
            
            // Update night number text
            nightIntroText.textContent = `NIGHT ${this.state.currentNight}`;
            
            // Show scene
            nightIntro.classList.remove('hidden');
            
            // Fade in effect (1.5s)
            setTimeout(() => {
                nightIntro.classList.add('fade-in');
            }, 50);
            
            // 1.5s fade in + 2s display then start fade out
            setTimeout(() => {
                nightIntro.classList.remove('fade-in');
                nightIntro.classList.add('fade-out');
                
                // After 1.5s fade out complete, hide and continue game
                setTimeout(() => {
                    nightIntro.classList.add('hidden');
                    nightIntro.classList.remove('fade-out');
                    resolve();
                }, 1500);
            }, 3500); // 1500ms fade in + 2000ms display
        });
    }
    
    startViewRotation() {
        const rotationLoop = () => {
            if (!this.state.isGameRunning) return;
            
            // If control panel or camera is open, disable rotation
            if (!this.state.controlPanelOpen && !this.state.cameraOpen) {
                if (this.isRotatingLeft && this.viewPosition > 0) {
                    this.viewPosition -= this.rotationSpeed;
                    this.viewPosition = Math.max(0, this.viewPosition);
                    this.ui.updateViewPosition(this.viewPosition);
                }
                
                if (this.isRotatingRight && this.viewPosition < 1) {
                    this.viewPosition += this.rotationSpeed;
                    this.viewPosition = Math.min(1, this.viewPosition);
                    this.ui.updateViewPosition(this.viewPosition);
                }
            }
            
            requestAnimationFrame(rotationLoop);
        };
        
        rotationLoop();
    }

    startGameLoop() {
        this.timeInterval = setInterval(() => {
            this.state.currentTime += 1;
            this.ui.update();
            
            if (this.state.currentTime >= 6) {
                this.winNight();
            }
        }, 60000);
        
        this.powerInterval = setInterval(() => {
            this.updatePower();
        }, 1000);
    }

    updatePower() {
        if (this.state.ventsClosed) {
            // When vents closed, oxygen decreases (faster speed)
            this.state.oxygen -= 1.5;
        } else {
            // When vents open, oxygen quickly recovers to 100%
            if (this.state.oxygen < 100) {
                this.state.oxygen += 2;
            }
        }
        
        this.state.oxygen = Math.max(0, Math.min(100, this.state.oxygen));
        
        if (this.state.oxygen <= 0) {
            this.oxygenOut();
        }
        
        this.ui.update();
    }

    toggleVents() {
        console.log('toggleVents called, controlPanelBusy:', this.state.controlPanelBusy);
        
        // Â¶ÇÊûúÊéßÂà∂Èù¢ÊùøÊ≠£ÂøôÔºå‰∏çÂÖÅËÆ∏Êìç‰Ωú
        if (this.state.controlPanelBusy) {
            console.log('Control panel is busy, please wait...');
            return;
        }
        
        // Ê†áËÆ∞ÊéßÂà∂Èù¢Êùø‰∏∫ÂøôÁ¢åÁä∂ÊÄÅ
        this.state.controlPanelBusy = true;
        this.state.ventsToggling = true;
        console.log('Starting vent toggle animation...');
        
        // Êí≠ÊîæÂøÉÁîµÂõæÈü≥Êïà
        this.assets.playSound('ekg', false, 0.8);
        
        // Ëé∑ÂèñÈ£éÊâáÂõæÊ†á
        const ventIcon = document.querySelector('.vent-icon');
        
        if (this.state.ventsClosed) {
            // ÂΩìÂâçÂÖ≥Èó≠ÔºåË¶ÅÊâìÂºÄ -> È£éÊâá‰ªéÂÅúÊ≠¢Âä†ÈÄüÂà∞Âø´ÈÄü
            console.log('Opening vents: fan speeding up');
            if (ventIcon) {
                ventIcon.classList.remove('stopped', 'slowing');
                ventIcon.classList.add('speeding-up');
                
                // ÈÄêÊ≠•Âä†ÈÄüÂä®Áîª
                setTimeout(() => {
                    ventIcon.style.animation = 'spin-slow 2s linear infinite';
                }, 0);
                setTimeout(() => {
                    ventIcon.style.animation = 'spin-slow 1.5s linear infinite';
                }, 1000);
                setTimeout(() => {
                    ventIcon.style.animation = 'spin-fast 0.333s linear infinite';
                    ventIcon.classList.remove('speeding-up');
                }, 2000);
            }
        } else {
            // ÂΩìÂâçÊâìÂºÄÔºåË¶ÅÂÖ≥Èó≠ -> È£éÊâá‰ªéÂø´ÈÄüÂáèÈÄüÂà∞ÂÅúÊ≠¢
            console.log('Closing vents: fan slowing down');
            if (ventIcon) {
                ventIcon.classList.remove('speeding-up');
                ventIcon.classList.add('slowing');
                
                // ÈÄêÊ≠•ÂáèÈÄüÂä®Áîª
                setTimeout(() => {
                    ventIcon.style.animation = 'spin-slow 1.5s linear infinite';
                }, 0);
                setTimeout(() => {
                    ventIcon.style.animation = 'spin-slow 2s linear infinite';
                }, 1000);
                setTimeout(() => {
                    ventIcon.style.animation = 'spin-slow 3s linear infinite';
                }, 2000);
                setTimeout(() => {
                    ventIcon.style.animation = 'none';
                    ventIcon.classList.remove('slowing');
                    ventIcon.classList.add('stopped');
                }, 3000);
            }
        }
        
        // Êõ¥Êñ∞UIÊòæÁ§∫ÁÇπÂä®Áîª
        this.ui.updateVentsStatus();
        
        // ÂêØÂä®ÂÆöÊó∂Êõ¥Êñ∞ÔºàÊØè100msÊõ¥Êñ∞‰∏ÄÊ¨°UIÔºâ
        const updateInterval = setInterval(() => {
            this.ui.updateVentsStatus();
            if (!this.state.ventsToggling) {
                clearInterval(updateInterval);
            }
        }, 100);
        
        // 4ÁßíÂêéÂÆåÊàêÂàáÊç¢
        setTimeout(() => {
            this.state.ventsClosed = !this.state.ventsClosed;
            console.log('Vents:', this.state.ventsClosed ? 'closed' : 'open');
            
            // ÈÄöÁü• EnemyAI ÈÄöÈ£éÂè£Áä∂ÊÄÅÂèòÂåñ
            this.enemyAI.onVentsChanged(this.state.ventsClosed);
            
            // Ëß£Èô§ÈîÅÂÆö
            this.state.ventsToggling = false;
            this.state.controlPanelBusy = false;
            console.log('Vent toggle completed');
            
            // Êõ¥Êñ∞UIÂíåÊéßÂà∂Èù¢ÊùøÈÄâÈ°πÊñáÊú¨
            this.ui.update();
            this.ui.updateVentsStatus();
            this.ui.updateControlPanelOptions();
        }, 4000);
    }

    toggleCamera() {
        // console.log('üéÆ Game.toggleCamera() called');
        // console.log('üéÆ Current state - cameraOpen:', this.state.cameraOpen, 'tutorialActive:', this.state.tutorialActive);
        this.camera.toggle();
    }

    oxygenOut() {
        this.stopGame();
        this.assets.stopSound('ambient');
        // Oxygen depleted triggers jumpscare
        this.enemyAI.triggerJumpscare();
    }
    
    gameOver(message) {
        this.stopGame();
        this.assets.stopSound('ambient');
        
        // Á´ãÂç≥ÈöêËóèÊ∏∏ÊàèÁîªÈù¢
        this.gameScreen.classList.remove('active');
        
        // ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥Èù¢Êùø
        if (this.state.cameraOpen) {
            this.camera.close();
        }
        
        // ÈöêËóèÊëÑÂÉèÂ§¥Èù¢Êùø
        const cameraPanel = document.getElementById('camera-panel');
        if (cameraPanel) {
            cameraPanel.classList.add('hidden');
            cameraPanel.classList.remove('show');
        }
        
        // Ê∏ÖÁêÜËßíËâ≤ÂõæÂ±Ç
        const characterOverlay = document.getElementById('character-overlay');
        if (characterOverlay) {
            characterOverlay.innerHTML = '';
        }
        
        // ÈöêËóèÊéßÂà∂Èù¢Êùø
        const controlPanel = document.getElementById('control-panel');
        if (controlPanel) {
            controlPanel.classList.add('hidden');
        }
        
        this.gameOverScreen(message);
    }

    winNight() {
        this.stopGame();
        this.assets.stopSound('ambient');
        
        // ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥ÔºàÂ¶ÇÊûúÊâìÂºÄÔºâ
        if (this.state.cameraOpen) {
            this.camera.close();
        }
        
        // Âº∫Âà∂ÈöêËóèÊëÑÂÉèÂ§¥Èù¢ÊùøÔºåÈò≤Ê≠¢Èó™Áé∞
        const cameraPanel = document.getElementById('camera-panel');
        if (cameraPanel) {
            cameraPanel.classList.add('hidden');
            cameraPanel.classList.remove('show', 'closing');
            cameraPanel.style.display = 'none'; // Âº∫Âà∂ÈöêËóè
        }
        
        // Á´ãÂç≥ÈöêËóèÊ∏∏ÊàèÁîªÈù¢ÔºåÈò≤Ê≠¢Èó™ÁÉÅ
        this.gameScreen.classList.remove('active');
        
        // Â¶ÇÊûúÊòØ Night 6ÔºåÊí≠ÊîæÁâπÊÆäÁöÑËÉúÂà©Âä®ÁîªÂπ∂Ê†áËÆ∞ÂÆåÊàê
        if (this.state.currentNight === 6) {
            localStorage.setItem('night6Completed', 'true');
            this.playNight6VictoryAnimation();
        } else if (this.state.currentNight === 5) {
            // Night 5ÔºåÊí≠ÊîæÁâπÊÆäÁöÑËÉúÂà©Âä®Áîª
            this.playNight5VictoryAnimation();
        } else {
            // ÂÖ∂‰ªñÂÖ≥Âç°Êí≠ÊîæÊôÆÈÄöÁöÑÂ§úÊôöÁªìÊùüÂä®Áîª
            this.playNightEndAnimation();
        }
    }
    
    // Night 5 ÁâπÊÆäËÉúÂà©Âä®Áîª
    playNight5VictoryAnimation() {
        // ÂàõÂª∫ÂÖ®Â±èÂä®ÁîªÂÆπÂô®
        const animationContainer = document.createElement('div');
        animationContainer.style.position = 'fixed';
        animationContainer.style.top = '0';
        animationContainer.style.left = '0';
        animationContainer.style.width = '100%';
        animationContainer.style.height = '100%';
        animationContainer.style.backgroundColor = '#000';
        animationContainer.style.display = 'flex';
        animationContainer.style.alignItems = 'center';
        animationContainer.style.justifyContent = 'center';
        animationContainer.style.zIndex = '10000';
        animationContainer.style.opacity = '0';
        animationContainer.style.transition = 'opacity 0.5s';
        
        // ÂàõÂª∫Êó∂Èó¥ÊòæÁ§∫
        const timeDisplay = document.createElement('div');
        timeDisplay.style.fontSize = '10vw';
        timeDisplay.style.fontWeight = 'bold';
        timeDisplay.style.color = '#fff';
        timeDisplay.style.fontFamily = 'Arial, sans-serif';
        timeDisplay.textContent = '5:59 AM';
        
        animationContainer.appendChild(timeDisplay);
        document.body.appendChild(animationContainer);
        
        // Ê∑°ÂÖ•
        setTimeout(() => {
            animationContainer.style.opacity = '1';
        }, 50);
        
        // 1ÁßíÂêéÂèò‰∏∫ 6:00 AM Âπ∂Êí≠ÊîæÈíüÂ£∞
        setTimeout(() => {
            timeDisplay.textContent = '6:00 AM';
            this.assets.playSound('chimes', false, 1.0);
        }, 1000);
        
        // 3ÁßíÂêéÊ∑°Âá∫Êó∂Èó¥
        setTimeout(() => {
            timeDisplay.style.transition = 'opacity 0.5s';
            timeDisplay.style.opacity = '0';
            
            setTimeout(() => {
                // ÁßªÈô§Êó∂Èó¥ÊòæÁ§∫
                animationContainer.removeChild(timeDisplay);
                
                // ÂàõÂª∫ "RESCUE ARRIVE" ÊñáÂ≠ó
                const rescueText = document.createElement('div');
                rescueText.style.fontSize = '8vw';
                rescueText.style.fontWeight = 'bold';
                rescueText.style.color = '#0f0'; // ÁªøËâ≤ÔºåË°®Á§∫ÊïëÊè¥
                rescueText.style.fontFamily = 'Arial, sans-serif';
                rescueText.style.textAlign = 'center';
                rescueText.style.opacity = '0';
                rescueText.style.transition = 'opacity 1s';
                rescueText.textContent = 'RESCUE ARRIVE';
                
                animationContainer.appendChild(rescueText);
                
                // Ê∑°ÂÖ• "RESCUE ARRIVE"
                setTimeout(() => {
                    rescueText.style.opacity = '1';
                }, 50);
                
                // 2ÁßíÂêéÊ∑°Âá∫ "RESCUE ARRIVE"ÔºåÊòæÁ§∫ËÉúÂà©ÁîªÈù¢
                setTimeout(() => {
                    rescueText.style.opacity = '0';
                    
                    setTimeout(() => {
                        // ÁßªÈô§ "RESCUE ARRIVE" ÊñáÂ≠ó
                        animationContainer.removeChild(rescueText);
                        
                        // ÂàõÂª∫ËÉúÂà©ÁîªÈù¢
                        const winScreen = document.createElement('img');
                        winScreen.src = '/FNAE-HTML5-1.1.5/assets/images/winscreen.png';
                        winScreen.style.width = '100%';
                        winScreen.style.height = '100%';
                        winScreen.style.objectFit = 'contain';
                        winScreen.style.opacity = '0';
                        winScreen.style.transition = 'opacity 1s';
                        
                        animationContainer.appendChild(winScreen);
                        
                        // Êí≠ÊîæËÉúÂà©Èü≥‰πê
                        this.assets.playSound('win', false, 1.0);
                        
                        // Ê∑°ÂÖ•ËÉúÂà©ÁîªÈù¢
                        setTimeout(() => {
                            winScreen.style.opacity = '1';
                        }, 50);
                        
                        // 5ÁßíÂêéÊ∑°Âá∫Âπ∂ËøîÂõû‰∏ªËèúÂçï
                        setTimeout(() => {
                            animationContainer.style.opacity = '0';
                            
                            setTimeout(() => {
                                document.body.removeChild(animationContainer);
                                
                                // Night 5 ÈÄöÂÖ≥ÂêéÔºåËß£ÈîÅ Night 6ÔºàSpecial NightÔºâ
                                localStorage.setItem('night6Unlocked', 'true');
                                
                                // ËøîÂõû‰∏ªËèúÂçï
                                this.clearProgress();
                                this.showMainMenu();
                            }, 500);
                        }, 5000); // ÊòæÁ§∫5Áßí
                    }, 1000); // "RESCUE ARRIVE" Ê∑°Âá∫1Áßí
                }, 2000); // ÊòæÁ§∫ "RESCUE ARRIVE" 2Áßí
            }, 500); // Êó∂Èó¥Ê∑°Âá∫0.5Áßí
        }, 3000); // ÊòæÁ§∫ "6:00 AM" 2Áßí
    }
    
    // Night 6 ÁâπÊÆäËÉúÂà©Âä®Áîª
    playNight6VictoryAnimation() {
        // ÂàõÂª∫ÂÖ®Â±èÂä®ÁîªÂÆπÂô®
        const animationContainer = document.createElement('div');
        animationContainer.style.position = 'fixed';
        animationContainer.style.top = '0';
        animationContainer.style.left = '0';
        animationContainer.style.width = '100%';
        animationContainer.style.height = '100%';
        animationContainer.style.backgroundColor = '#000';
        animationContainer.style.display = 'flex';
        animationContainer.style.alignItems = 'center';
        animationContainer.style.justifyContent = 'center';
        animationContainer.style.zIndex = '10000';
        animationContainer.style.opacity = '0';
        animationContainer.style.transition = 'opacity 0.5s';
        
        // ÂàõÂª∫Êó∂Èó¥ÊòæÁ§∫
        const timeDisplay = document.createElement('div');
        timeDisplay.style.fontSize = '10vw';
        timeDisplay.style.fontWeight = 'bold';
        timeDisplay.style.color = '#fff';
        timeDisplay.style.fontFamily = 'Arial, sans-serif';
        timeDisplay.textContent = '5:59 AM';
        
        animationContainer.appendChild(timeDisplay);
        document.body.appendChild(animationContainer);
        
        // Ê∑°ÂÖ•
        setTimeout(() => {
            animationContainer.style.opacity = '1';
        }, 50);
        
        // 1ÁßíÂêéÂèò‰∏∫ 6:00 AM Âπ∂Êí≠ÊîæÈíüÂ£∞
        setTimeout(() => {
            timeDisplay.textContent = '6:00 AM';
            this.assets.playSound('chimes', false, 1.0);
        }, 1000);
        
        // 3ÁßíÂêéÊ∑°Âá∫Êó∂Èó¥ÔºåÊòæÁ§∫night6.pngÂõæÁâá
        setTimeout(() => {
            timeDisplay.style.transition = 'opacity 0.5s';
            timeDisplay.style.opacity = '0';
            
            setTimeout(() => {
                // ÁßªÈô§Êó∂Èó¥ÊòæÁ§∫
                animationContainer.removeChild(timeDisplay);
                
                // ÂàõÂª∫night6.pngÂõæÁâá
                const night6Image = document.createElement('img');
                night6Image.src = '/FNAE-HTML5-1.1.5/assets/images/night6.png';
                night6Image.style.width = '100%';
                night6Image.style.height = '100%';
                night6Image.style.objectFit = 'contain';
                night6Image.style.opacity = '0';
                night6Image.style.transition = 'opacity 1s';
                
                animationContainer.appendChild(night6Image);
                
                // Êí≠Êîægoldenstephenscare.oggÈü≥‰πê
                this.assets.playSound('goldenstephenscare', false, 1.0);
                
                // Ê∑°ÂÖ•ÂõæÁâá
                setTimeout(() => {
                    night6Image.style.opacity = '1';
                }, 50);
                
                // 5ÁßíÂêéÊ∑°Âá∫Âπ∂ËøîÂõû‰∏ªËèúÂçï
                setTimeout(() => {
                    animationContainer.style.opacity = '0';
                    
                    setTimeout(() => {
                        document.body.removeChild(animationContainer);
                        
                        // ËøîÂõû‰∏ªËèúÂçï
                        this.showMainMenu();
                    }, 500);
                }, 5000);
            }, 500);
        }, 3000);
    }
    
    // Night end animation: 5:59AM -> 6:00AM -> Days until rescue
    playNightEndAnimation() {
        // Create fullscreen animation container
        const animationContainer = document.createElement('div');
        animationContainer.style.position = 'fixed';
        animationContainer.style.top = '0';
        animationContainer.style.left = '0';
        animationContainer.style.width = '100%';
        animationContainer.style.height = '100%';
        animationContainer.style.backgroundColor = '#000';
        animationContainer.style.display = 'flex';
        animationContainer.style.alignItems = 'center';
        animationContainer.style.justifyContent = 'center';
        animationContainer.style.zIndex = '10000';
        animationContainer.style.opacity = '0';
        animationContainer.style.transition = 'opacity 0.5s';
        
        // ÂàõÂª∫Êó∂Èó¥ÊòæÁ§∫
        const timeDisplay = document.createElement('div');
        timeDisplay.style.fontSize = '10vw';
        timeDisplay.style.fontWeight = 'bold';
        timeDisplay.style.color = '#fff';
        timeDisplay.style.fontFamily = 'Arial, sans-serif';
        timeDisplay.textContent = '5:59 AM';
        
        animationContainer.appendChild(timeDisplay);
        document.body.appendChild(animationContainer);
        
        // Fade in
        setTimeout(() => {
            animationContainer.style.opacity = '1';
        }, 50);
        
        // After 1s change to 6:00AM and play sound effect
        setTimeout(() => {
            timeDisplay.textContent = '6:00 AM';
            this.assets.playSound('chimes', false, 1.0);
        }, 1000);
        
        // After 2s more, show message
        setTimeout(() => {
            // Ê∑°Âá∫Êó∂Èó¥Ôºà‰∏çÊîπÂèòÂÆπÂô®ÈÄèÊòéÂ∫¶Ôºå‰øùÊåÅÈªëËâ≤ËÉåÊôØÔºâ
            timeDisplay.style.transition = 'opacity 0.5s';
            timeDisplay.style.opacity = '0';
            
            setTimeout(() => {
                // Â¶ÇÊûúËøòÊúâ‰∏ã‰∏ÄÂÖ≥ÔºåÊòæÁ§∫Ââ©‰ΩôÂ§©Êï∞ÔºàÊïÖ‰∫ãËÆæÂÆöÊòØ5ÊôöÔºåÊâÄ‰ª•ÊÄªÊòØÊòæÁ§∫5-ÂΩìÂâçÂÖ≥Âç°Ôºâ
                if (this.state.currentNight < this.state.maxNights) {
                    const daysRemaining = 5 - this.state.currentNight; // Âõ∫ÂÆöÊåâ5ÊôöËÆ°ÁÆó
                    timeDisplay.textContent = `${daysRemaining} ${daysRemaining === 1 ? 'day' : 'days'} until rescue`;
                    timeDisplay.style.fontSize = '5vw';
                    timeDisplay.style.color = '#fff';
                } else {
                    // ÊâÄÊúâÂÖ≥Âç°ÂÆåÊàêÔºåÊòæÁ§∫TO BE CONTINUED
                    timeDisplay.innerHTML = 'TO BE CONTINUED...<br><span style="font-size: 3vw; color: #f00;">Web version port in progress</span>';
                    timeDisplay.style.fontSize = '5vw';
                    timeDisplay.style.color = '#fff';
                }
                timeDisplay.style.opacity = '1';
            }, 500);
            
            // ÂÜçËøá3ÁßíÂêéÊ∑°Âá∫
            setTimeout(() => {
                animationContainer.style.opacity = '0';
                
                setTimeout(() => {
                    document.body.removeChild(animationContainer);
                    
                    // Â¶ÇÊûúËøòÊúâ‰∏ã‰∏ÄÂÖ≥ÔºåÁõ¥Êé•ËøõÂÖ•‰∏ã‰∏ÄÂÖ≥
                    if (this.state.currentNight < this.state.maxNights) {
                        this.state.currentNight++;
                        this.continueToNextNight();
                    } else {
                        // ÊâÄÊúâÂÖ≥Âç°ÂÆåÊàêÔºåÊ∏ÖÈô§ËøõÂ∫¶Âπ∂ËøîÂõû‰∏ªËèúÂçï
                        this.clearProgress();
                        this.showMainMenu();
                    }
                }, 500);
            }, 3000); // Êîπ‰∏∫3ÁßíÔºåËÆ©Áé©ÂÆ∂ÊúâÊó∂Èó¥ÁúãTO BE CONTINUED
        }, 3000);
    }

    gameOverScreen(message, win = false) {
        this.gameOverText.textContent = message;
        const subtitle = document.getElementById('game-over-subtitle');
        const gameOverStatic = document.getElementById('game-over-static');
        const restartBtn = document.getElementById('restart');
        const mainMenuBtn = document.getElementById('main-menu-btn');
        
        // ÈöêËóèÊåâÈíÆ
        if (restartBtn) restartBtn.style.display = 'none';
        if (mainMenuBtn) mainMenuBtn.style.display = 'none';
        
        // Play static video
        if (gameOverStatic) {
            gameOverStatic.currentTime = 0;
            gameOverStatic.play().catch(e => console.log('Failed to play game over static:', e));
        }
        
        if (win) {
            // Only increase night number if not at max level
            if (this.state.currentNight < this.state.maxNights) {
                this.state.currentNight++;
                // Hide subtitle, will continue to next night
                subtitle.classList.add('hidden');
                
                // Show game over screen
                this.gameOverElement.classList.remove('hidden');
                
                // Auto continue to next night after 3 seconds
                setTimeout(() => {
                    // ÈöêËóèÊ∏∏ÊàèÁªìÊùüÁîªÈù¢
                    this.gameOverElement.classList.add('hidden');
                    this.gameScreen.classList.remove('active');
                    
                    // ÂÅúÊ≠¢ÈùôÊÄÅËßÜÈ¢ë
                    if (gameOverStatic) {
                        gameOverStatic.pause();
                        gameOverStatic.currentTime = 0;
                    }
                    
                    this.continueToNextNight();
                }, 3000);
            } else {
                // All available levels completed, show "to be continued" message
                subtitle.textContent = 'TO BE CONTINUED... (Web version port in progress)';
                subtitle.classList.remove('hidden');
                this.gameOverElement.classList.remove('hidden');
                
                // 3ÁßíÂêéËá™Âä®ËøîÂõû‰∏ªËèúÂçï
                setTimeout(() => {
                    this.gameOverElement.classList.add('hidden');
                    this.showMainMenu();
                }, 3000);
            }
        } else {
            // On failure hide subtitle
            subtitle.classList.add('hidden');
            this.gameOverElement.classList.remove('hidden');
            
            // ‰øùÂ≠òËøõÂ∫¶ÔºàÂ¶ÇÊûúÂú®Night 2ÊàñÊõ¥È´òÂÖ≥Âç°Ê≠ª‰∫°Ôºâ
            this.saveProgress();
            
            // 3ÁßíÂêéËá™Âä®ËøîÂõû‰∏ªËèúÂçï
            setTimeout(() => {
                this.gameOverElement.classList.add('hidden');
                this.showMainMenu();
            }, 3000);
        }
    }
    
    // Continue to next night (without cutscene)
    async continueToNextNight() {
        if (!this.assets.loaded) {
            await this.assets.loadAssets();
        }
        
        this.state.reset();
        this.enemyAI.reset(); // ÈáçÁΩÆÊïå‰∫∫AIÁä∂ÊÄÅ
        
        // ÈáçÁΩÆÊëÑÂÉèÂ§¥Á≥ªÁªüÁöÑsoundÊåâÈíÆËÆ°Êï∞
        this.camera.resetSoundButtonCount();
        
        // ÊÅ¢Â§çÊëÑÂÉèÂ§¥Èù¢ÊùøÁöÑdisplayÔºà‰πãÂâçË¢´Âº∫Âà∂ÈöêËóèÔºâ
        const cameraPanel = document.getElementById('camera-panel');
        if (cameraPanel) {
            cameraPanel.style.display = ''; // ÊÅ¢Â§çÈªòËÆ§
        }
        
        // ÊòæÁ§∫ÊØèÊôöÂºÄÂßãÂú∫ÊôØ
        await this.showNightIntro();
        
        // ËøõÂú∫Âä®ÁîªÁªìÊùüÂêéÊâçÊòæÁ§∫Ê∏∏ÊàèÁîªÈù¢
        this.gameScreen.classList.add('active');
        
        this.ui.currentSceneImg.src = this.assets.images.office.src;
        this.ui.currentSceneImg.style.display = 'block';
        this.viewPosition = 0.25;
        this.ui.updateViewPosition(this.viewPosition);
        
        this.ui.update();
        this.ui.createHotspots();
        
        // ÂàùÂßãÂåñÈ£éÊâáÁä∂ÊÄÅ
        this.initVentFanAnimation();
        
        this.startGameLoop();
        this.startViewRotation();
        
        // Start enemy AI
        this.enemyAI.start();
        
        this.assets.playSound('vents', true);
        
        // Show tutorial for specific nights
        if (this.state.currentNight === 2) {
            this.showTutorial('night2');
        } else if (this.state.currentNight === 3) {
            this.showTutorial('night3');
        }
        
        // Night 5: ÂøÖÂÆöËß¶Âèë Golden ÈúçÈáëÂΩ©Ëõã
        if (this.state.currentNight === 5) {
            console.log('üåü Night 5 detected (continueToNextNight), triggering Golden Stephen...');
            setTimeout(() => {
                this.showGoldenStephen();
            }, 1000);
        }
    }

    stopGame() {
        this.state.isGameRunning = false;
        clearInterval(this.timeInterval);
        clearInterval(this.powerInterval);
        this.enemyAI.stop();
    }

    restartGame() {
        this.gameOverElement.classList.add('hidden');
        // Hide game screen, prepare to restart
        this.gameScreen.classList.remove('active');
        this.startGame();
    }

    showMainMenu() {
        this.gameOverElement.classList.add('hidden');
        this.gameScreen.classList.remove('active');
        
        // ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥Èù¢Êùø
        if (this.state.cameraOpen) {
            this.camera.close();
        }
        
        // ÈöêËóèÊëÑÂÉèÂ§¥Èù¢Êùø
        const cameraPanel = document.getElementById('camera-panel');
        if (cameraPanel) {
            cameraPanel.classList.add('hidden');
            cameraPanel.classList.remove('show');
        }
        
        // Ê∏ÖÁêÜËßíËâ≤ÂõæÂ±Ç
        const characterOverlay = document.getElementById('character-overlay');
        if (characterOverlay) {
            characterOverlay.innerHTML = '';
        }
        
        // ÈöêËóèÊéßÂà∂Èù¢Êùø
        const controlPanel = document.getElementById('control-panel');
        if (controlPanel) {
            controlPanel.classList.add('hidden');
        }
        
        this.mainMenu.classList.remove('hidden');
        this.stopGame();
        
        // Êõ¥Êñ∞ContinueÊåâÈíÆÊòæÁ§∫
        this.updateContinueButton();
        
        this.assets.stopSound('vents');
        this.assets.stopSound('static');
        this.assets.stopSound('staticLoop');
        this.assets.stopSound('ventCrawling');
        
        const menuMusic = document.getElementById('menu-music');
        if (menuMusic) {
            menuMusic.loop = true;
            menuMusic.currentTime = 0;
            menuMusic.play().catch(e => console.log('Menu music playback failed:', e));
        }
    }
}


// Ê∏∏ÊàèÁä∂ÊÄÅÁÆ°ÁêÜ
class GameState {
    constructor() {
        this.currentNight = 1;
        this.maxNights = 5; // ÂΩìÂâçÁâàÊú¨Êúâ5ÊôöÔºàNight 1-5ÔºâÔºåNight 6 ÊòØÁâπÊÆäÂÖ≥Âç°
        this.currentTime = 0; // 0-6 (12AM-6AM)
        this.oxygen = 100; // Ê∞ßÊ∞îÊõø‰ª£ÁîµÈáè
        this.isGameRunning = false;
        this.tutorialActive = false; // ÊïôÁ®ãÊòØÂê¶ÊøÄÊ¥ª
        this.currentScene = 'office';
        this.cameraOpen = false;
        this.ventsClosed = false; // ÈÄöÈ£éÂè£Áä∂ÊÄÅ
        this.ventsToggling = false; // ÈÄöÈ£éÂè£ÊòØÂê¶Ê≠£Âú®ÂàáÊç¢
        this.currentCam = 'cam11'; // ÂΩìÂâçÊëÑÂÉèÂ§¥
        this.cameraFailed = false; // ÊëÑÂÉèÂ§¥ÊòØÂê¶ÊïÖÈöú
        this.cameraRestarting = false; // ÊëÑÂÉèÂ§¥ÊòØÂê¶Ê≠£Âú®ÈáçÂêØ
        this.controlPanelBusy = false; // ÊéßÂà∂Èù¢ÊùøÊòØÂê¶Ê≠£Âú®Â§ÑÁêÜÊìç‰Ωú
    }

    reset() {
        this.currentTime = 0;
        this.oxygen = 100;
        this.isGameRunning = true;
        this.tutorialActive = false;
        this.currentScene = 'office';
        this.cameraOpen = false;
        this.ventsClosed = false;
        this.ventsToggling = false;
        this.currentCam = 'cam11';
        this.cameraFailed = false;
        this.cameraRestarting = false;
        this.controlPanelBusy = false;
    }
}


// Input handler
class InputHandler {
    constructor(game) {
        this.game = game;
        this.touchStartX = 0;
        this.touchStartY = 0;
        this.isTouching = false;
        this.bindEvents();
    }

    bindEvents() {
        // Keyboard controls
        document.addEventListener('keydown', (e) => this.handleKeyPress(e));
        
        // Mouse movement view control - edge trigger
        const gameScreen = document.getElementById('game-screen');
        gameScreen.addEventListener('mousemove', (e) => this.handleMouseMove(e));
        
        // Touch controls for mobile
        gameScreen.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: false });
        gameScreen.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
        gameScreen.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: false });
    }

    handleKeyPress(e) {
        // ==================== ‰ΩúÂºäÈîÆÔºàÁîü‰∫ßÁéØÂ¢ÉËØ∑Ê≥®ÈáäÊéâÔºâ ====================
        
        // F9 ‰ΩúÂºäÈîÆÔºöË∑≥ËøáÂΩìÂâçÂ§úÊôöÔºàË∞ÉËØïÁî®Ôºâ
        if (e.key === 'F9') {
            e.preventDefault();
            if (this.game.state.isGameRunning) {
                console.log('üéÆ CHEAT: Skipping current night...');
                
                // ÊòæÁ§∫‰ΩúÂºäÊèêÁ§∫
                this.showCheatNotification('Skipping Night ' + this.game.state.currentNight);
                
                // Âª∂ËøüÊâßË°åÔºåËÆ©Áé©ÂÆ∂ÁúãÂà∞ÊèêÁ§∫
                setTimeout(() => {
                    this.game.winNight();
                }, 500);
            }
            return;
        }
        
        // F10 ‰ΩúÂºäÈîÆÔºöËß£ÈîÅÁâπÊÆäÂ§úÊôöÔºàË∞ÉËØïÁî®Ôºâ
        if (e.key === 'F10') {
            e.preventDefault();
            console.log('üéÆ CHEAT: Unlocking Special Night...');
            localStorage.setItem('night6Unlocked', 'true');
            this.showCheatNotification('Special Night Unlocked!');
            
            // Â¶ÇÊûúÂú®‰∏ªËèúÂçïÔºåÁ´ãÂç≥Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫
            if (this.game.mainMenu && !this.game.mainMenu.classList.contains('hidden')) {
                this.game.updateContinueButton();
            }
            return;
        }
        
        /*
        // F7 ‰ΩúÂºäÈîÆÔºöÊó∂Èó¥Âä†ÈÄüÔºàÊµãËØïÁî®Ôºâ
        if (e.key === 'F7') {
            e.preventDefault();
            if (this.game.state.isGameRunning) {
                this.game.state.currentTime += 1;
                this.game.ui.update();
                this.showCheatNotification(`Time: ${this.game.state.currentTime} AM`);
                
                if (this.game.state.currentTime >= 6) {
                    this.game.winNight();
                }
            }
            return;
        }
        
        // Êï∞Â≠óÈîÆ1-6ÔºöÂø´ÈÄüË∑≥Âà∞ÂØπÂ∫îÂÖ≥Âç°ÔºàÊµãËØïÁî®Ôºå‰ªÖÂú®‰∏ªËèúÂçïÊúâÊïàÔºâ
        if (e.key >= '1' && e.key <= '6') {
            if (this.game.mainMenu && !this.game.mainMenu.classList.contains('hidden')) {
                e.preventDefault();
                const night = parseInt(e.key);
                console.log(`üéÆ CHEAT: Jumping to Night ${night}...`);
                this.game.state.currentNight = night;
                this.showCheatNotification(`Starting Night ${night}`);
                
                // Â¶ÇÊûúÊòØNight 6ÔºåÈúÄË¶ÅÂÖàËß£ÈîÅ
                if (night === 6) {
                    localStorage.setItem('night6Unlocked', 'true');
                    setTimeout(() => this.game.startSpecialNight(), 500);
                } else {
                    setTimeout(() => this.game.initGame(), 500);
                }
                
                this.game.mainMenu.classList.add('hidden');
                const menuMusic = document.getElementById('menu-music');
                if (menuMusic) {
                    menuMusic.pause();
                    menuMusic.currentTime = 0;
                }
            }
            return;
        }
        */
        // ==================== ‰ΩúÂºäÈîÆÁªìÊùü ====================
        
        if (!this.game.state.isGameRunning) return;
        
        switch(e.key.toLowerCase()) {
            case 'v': 
                this.game.toggleVents(); 
                break;
            case ' ': 
                e.preventDefault();
                this.game.toggleCamera();
                break;
        }
    }
    
    // ‰ΩúÂºäÈÄöÁü•
    showCheatNotification(message) {
        // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
        const notification = document.createElement('div');
        notification.style.position = 'fixed';
        notification.style.top = '10px';
        notification.style.left = '50%';
        notification.style.transform = 'translateX(-50%)';
        notification.style.background = 'rgba(255, 215, 0, 0.9)';
        notification.style.color = '#000';
        notification.style.padding = '10px 20px';
        notification.style.fontSize = '20px';
        notification.style.fontWeight = 'bold';
        notification.style.fontFamily = 'Arial, sans-serif';
        notification.style.borderRadius = '5px';
        notification.style.zIndex = '99999';
        notification.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.8)';
        notification.textContent = 'üéÆ CHEAT: ' + message;
        
        document.body.appendChild(notification);
        
        // 1ÁßíÂêéÁßªÈô§
        setTimeout(() => {
            notification.remove();
        }, 1000);
    }

    handleMouseMove(e) {
        if (!this.game.state.isGameRunning || this.game.state.cameraOpen) return;
        
        const edgeThreshold = 100;
        const mouseX = e.clientX;
        const screenWidth = window.innerWidth;
        
        // Check if at left edge
        if (mouseX < edgeThreshold) {
            this.game.isRotatingLeft = true;
            this.game.isRotatingRight = false;
        }
        // Check if at right edge
        else if (mouseX > screenWidth - edgeThreshold) {
            this.game.isRotatingRight = true;
            this.game.isRotatingLeft = false;
        }
        // In middle area, stop rotation
        else {
            this.game.isRotatingLeft = false;
            this.game.isRotatingRight = false;
        }
    }
    
    handleTouchStart(e) {
        if (!this.game.state.isGameRunning || this.game.state.cameraOpen) return;
        
        // Don't prevent default if touching UI elements
        const target = e.target;
        if (target.closest('.hotspot') || target.closest('.control-panel-button') || 
            target.closest('.camera-button') || target.closest('#control-panel-popup')) {
            return;
        }
        
        e.preventDefault();
        
        const touch = e.touches[0];
        this.touchStartX = touch.clientX;
        this.touchStartY = touch.clientY;
        this.isTouching = true;
    }
    
    handleTouchMove(e) {
        if (!this.game.state.isGameRunning || this.game.state.cameraOpen || !this.isTouching) return;
        
        // Don't prevent default if touching UI elements
        const target = e.target;
        if (target.closest('.hotspot') || target.closest('.control-panel-button') || 
            target.closest('.camera-button') || target.closest('#control-panel-popup')) {
            return;
        }
        
        e.preventDefault();
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - this.touchStartX;
        const deltaY = Math.abs(touch.clientY - this.touchStartY);
        
        // Only rotate if horizontal swipe (not vertical)
        if (deltaY < 50) {
            const sensitivity = 0.002;
            // Reverse the direction: swipe right = view right, swipe left = view left
            const movement = -deltaX * sensitivity;
            
            // Update view position directly
            this.game.viewPosition += movement;
            this.game.viewPosition = Math.max(0, Math.min(1, this.game.viewPosition));
            this.game.ui.updateViewPosition(this.game.viewPosition);
            
            // Update touch start position for smooth continuous movement
            this.touchStartX = touch.clientX;
            this.touchStartY = touch.clientY;
        }
    }
    
    handleTouchEnd(e) {
        if (!this.game.state.isGameRunning) return;
        
        this.isTouching = false;
        this.game.isRotatingLeft = false;
        this.game.isRotatingRight = false;
    }
}


// Ê∏∏ÊàèÂÖ•Âè£ - ÂàùÂßãÂåñÊâÄÊúâÊ®°Âùó
let game;
let staticNoise;

// È¢ÑÂä†ËΩΩËøõÂ∫¶Ë∑üË∏™
let loadedAssets = 0;
let totalAssets = 0;

// Á¶ÅÁî®ÊµèËßàÂô®ÈªòËÆ§Ë°å‰∏∫ÔºåÊèêÂçáÊ∏∏Êàè‰ΩìÈ™å
function disableBrowserDefaults() {
    // Á¶ÅÁî®Âè≥ÈîÆËèúÂçï
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        return false;
    }, { capture: true });
    
    // Á¶ÅÁî®ÊãñÊãΩ
    document.addEventListener('dragstart', (e) => {
        e.preventDefault();
        return false;
    }, { capture: true });
    
    // Á¶ÅÁî®ÈÄâÊã©ÊñáÊú¨ÔºàÂèåÂáª„ÄÅÈïøÊåâÁ≠âÔºâ
    document.addEventListener('selectstart', (e) => {
        e.preventDefault();
        return false;
    }, { capture: true });
    
    // Á¶ÅÁî®Â§çÂà∂
    document.addEventListener('copy', (e) => {
        e.preventDefault();
        return false;
    }, { capture: true });
    
    // Á¶ÅÁî®Ââ™Âàá
    document.addEventListener('cut', (e) => {
        e.preventDefault();
        return false;
    }, { capture: true });
    
    // Á¶ÅÁî®Êüê‰∫õÂø´Êç∑ÈîÆ
    document.addEventListener('keydown', (e) => {
        // Á¶ÅÁî® Ctrl+A (ÂÖ®ÈÄâ)
        if (e.ctrlKey && e.key === 'a') {
            e.preventDefault();
            return false;
        }
        // Á¶ÅÁî® Ctrl+C (Â§çÂà∂)
        if (e.ctrlKey && e.key === 'c') {
            e.preventDefault();
            return false;
        }
        // Á¶ÅÁî® Ctrl+X (Ââ™Âàá)
        if (e.ctrlKey && e.key === 'x') {
            e.preventDefault();
            return false;
        }
        // Á¶ÅÁî® Ctrl+S (‰øùÂ≠ò)
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            return false;
        }
        // Á¶ÅÁî® Ctrl+P (ÊâìÂç∞)
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            return false;
        }
        // Á¶ÅÁî® Ctrl+U (Êü•ÁúãÊ∫ê‰ª£Á†Å)
        if (e.ctrlKey && e.key === 'u') {
            e.preventDefault();
            return false;
        }
    }, { capture: true });
    
    // Á¶ÅÁî®Ëß¶Êë∏ËÆæÂ§áÁöÑÈïøÊåâËèúÂçï
    document.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) {
            e.preventDefault();
        }
    }, { passive: false, capture: true });
    
    // Á¶ÅÁî®ÂèåÊåáÁº©Êîæ
    document.addEventListener('touchmove', (e) => {
        if (e.touches.length > 1) {
            e.preventDefault();
        }
    }, { passive: false, capture: true });
    
    // ÈòªÊ≠¢Èº†Ê†áÈÄâÊã©ÊñáÊú¨
    document.addEventListener('mousedown', (e) => {
        // ÂÖÅËÆ∏ÊåâÈíÆÁÇπÂáª
        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
            return true;
        }
        // ÈòªÊ≠¢ÂÖ∂‰ªñÂÖÉÁ¥†ÁöÑÈº†Ê†áÊåâ‰∏ãÔºàÈò≤Ê≠¢ÊãñÊãΩÈÄâÊã©Ôºâ
        if (e.detail > 1) { // ÂèåÂáªÊàñÂ§öÂáª
            e.preventDefault();
            return false;
        }
    }, { capture: true });
    
    // console.log('Browser defaults disabled for better game experience');
}

// Êõ¥Êñ∞È¢ÑÂä†ËΩΩËøõÂ∫¶
function updatePreloadProgress(progress) {
    const progressBar = document.getElementById('progress-bar');
    const percentage = document.getElementById('preloader-percentage');
    
    if (progressBar && percentage) {
        progressBar.style.width = progress + '%';
        percentage.textContent = Math.round(progress) + '%';
    }
}

// È¢ÑÂä†ËΩΩÊâÄÊúâÊ∏∏ÊàèËµÑÊ∫ê
async function preloadGameAssets() {
    const basePath = window.location.pathname.includes('/FNAE-HTML5-1.1.5/') 
        ? '/FNAE-HTML5-1.1.5/' 
        : './';
    
    // ÂÆö‰πâÊâÄÊúâÈúÄË¶ÅÈ¢ÑÂä†ËΩΩÁöÑËµÑÊ∫ê
    const imagePaths = [
        'assets/images/original.png',
        'assets/images/Cam1.png',
        'assets/images/Cam2.png',
        'assets/images/Cam3.png',
        'assets/images/Cam4.png',
        'assets/images/Cam5.png',
        'assets/images/Cam6.png',
        'assets/images/Cam7.png',
        'assets/images/Cam8.png',
        'assets/images/Cam9.png',
        'assets/images/Cam10.png',
        'assets/images/Cam11.png',
        'assets/images/jump.png',
        'assets/images/menubackground.png',
        'assets/images/cutscene.png',
        'assets/images/fa3.png',
        'assets/images/FNAE-Map-layout.png',
        'assets/images/enemyep1.png',
        'assets/images/ep1.png',
        'assets/images/ep4.png',
        'assets/images/enemyep4.png',
        'assets/images/scaryhawk.png',
        'assets/images/scaryep.png',
        'assets/images/scarytrump.png',
        'assets/images/winscreen.png',  // Night 5 ËÉúÂà©ÁîªÈù¢
        'assets/images/goldenstephen.png'  // Golden ÈúçÈáë
    ];
    
    const soundPaths = [
        'assets/sounds/music.ogg',
        'assets/sounds/music3.ogg',
        'assets/sounds/Static_sound.ogg',
        'assets/sounds/vents.ogg',
        'assets/sounds/jumpcare.ogg',
        'assets/sounds/Blip.ogg',
        'assets/sounds/winmusic.ogg',
        'assets/sounds/chimes.ogg',
        'assets/sounds/Crank1.ogg',
        'assets/sounds/Crank2.ogg',
        'assets/sounds/goldenstephenscare.ogg'  // Golden ÈúçÈáëÈü≥Êïà
    ];
    
    totalAssets = imagePaths.length + soundPaths.length;
    loadedAssets = 0;
    
    // È¢ÑÂä†ËΩΩÂõæÁâá
    const imagePromises = imagePaths.map(path => {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                loadedAssets++;
                updatePreloadProgress((loadedAssets / totalAssets) * 100);
                resolve();
            };
            img.onerror = () => {
                console.warn(`Failed to load image: ${path}`);
                loadedAssets++;
                updatePreloadProgress((loadedAssets / totalAssets) * 100);
                resolve();
            };
            img.src = basePath + path;
        });
    });
    
    // È¢ÑÂä†ËΩΩÈü≥È¢ëÔºà‰∏çÈòªÂ°ûÔºåÂø´ÈÄüÂä†ËΩΩÔºâ
    const audioPromises = soundPaths.map(path => {
        return new Promise((resolve) => {
            const audio = new Audio();
            audio.addEventListener('canplaythrough', () => {
                loadedAssets++;
                updatePreloadProgress((loadedAssets / totalAssets) * 100);
                resolve();
            }, { once: true });
            audio.addEventListener('error', () => {
                console.warn(`Failed to load audio: ${path}`);
                loadedAssets++;
                updatePreloadProgress((loadedAssets / totalAssets) * 100);
                resolve();
            }, { once: true });
            audio.src = basePath + path;
            audio.load();
        });
    });
    
    // Á≠âÂæÖÊâÄÊúâËµÑÊ∫êÂä†ËΩΩÂÆåÊàê
    await Promise.all([...imagePromises, ...audioPromises]);
    
    // Á°Æ‰øùËøõÂ∫¶Êù°ÊòæÁ§∫100%
    updatePreloadProgress(100);
    
    // Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊó∂Èó¥ËÆ©Áé©ÂÆ∂ÁúãÂà∞100%
    await new Promise(resolve => setTimeout(resolve, 500));
}

// ÈöêËóèÈ¢ÑÂä†ËΩΩÂä®Áîª
function hidePreloader() {
    const preloader = document.getElementById('preloader');
    if (preloader) {
        preloader.classList.add('fade-out');
        setTimeout(() => {
            preloader.style.display = 'none';
        }, 500);
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂêØÂä®
window.addEventListener('DOMContentLoaded', async () => {
    // Á¶ÅÁî®ÊµèËßàÂô®ÈªòËÆ§Ë°å‰∏∫
    disableBrowserDefaults();
    
    // ÂÖàÈ¢ÑÂä†ËΩΩÊâÄÊúâËµÑÊ∫ê
    await preloadGameAssets();
    
    // È¢ÑÂä†ËΩΩËÉåÊôØÂõæÁâáÔºàÁî®‰∫éÊÅêÊÄñËÑ∏ÊïàÊûúÔºâ
    preloadBackgrounds();
    
    // ÈöêËóèÈ¢ÑÂä†ËΩΩÂä®Áîª
    hidePreloader();
    
    // ÂàùÂßãÂåñÊ∏∏Êàè
    game = new Game();
    staticNoise = new StaticNoise();
    
    // Êõ¥Êñ∞ContinueÊåâÈíÆÊòæÁ§∫
    game.updateContinueButton();
    
    const mainMenu = document.getElementById('main-menu');
    
    // Ê£ÄÊü•ÊòØÂê¶‰ªéÂ§ñÈÉ®È°µÈù¢ÂêØÂä®ÔºàÂ∏¶autostartÂèÇÊï∞Ôºâ
    const urlParams = new URLSearchParams(window.location.search);
    const autostart = urlParams.get('autostart');
    
    // ÂêØÂä®ËèúÂçïÈü≥‰πê
    const menuMusic = document.getElementById('menu-music');
    if (menuMusic) {
        menuMusic.volume = 0.5;
        
        // Â¶ÇÊûúÊòØautostartÔºåÁ´ãÂç≥Â∞ùËØïÊí≠Êîæ
        if (autostart === '1') {
            // console.log('Ê£ÄÊµãÂà∞autostartÂèÇÊï∞ÔºåÂ∞ùËØïËá™Âä®Êí≠ÊîæÈü≥‰πê...');
            menuMusic.play().then(() => {
                // console.log('‚úÖ Èü≥‰πêËá™Âä®Êí≠ÊîæÊàêÂäüÔºÅ');
            }).catch(e => {
                // console.log('‚ùå Ëá™Âä®Êí≠ÊîæÂ§±Ë¥•ÔºåÁ≠âÂæÖÁî®Êà∑‰∫§‰∫í:', e);
                // Â§±Ë¥•ÂàôÁ≠âÂæÖÁî®Êà∑ÁÇπÂáª
                setupManualPlayback();
            });
        } else {
            // Ê≠£Â∏∏ÊµÅÁ®ãÔºöÁ≠âÂæÖÁî®Êà∑ÁÇπÂáª
            setupManualPlayback();
        }
        
        function setupManualPlayback() {
            const playMusic = () => {
                if (mainMenu && !mainMenu.classList.contains('hidden')) {
                    menuMusic.play().catch(e => {/* console.log('Èü≥‰πêÊí≠ÊîæÈúÄË¶ÅÁî®Êà∑‰∫§‰∫í') */});
                }
                document.removeEventListener('click', playMusic);
                document.removeEventListener('keydown', playMusic);
            };
            
            document.addEventListener('click', playMusic);
            document.addEventListener('keydown', playMusic);
        }
    }
    
    // ÁõëÂê¨‰∏ªËèúÂçïÊòæÁ§∫/ÈöêËóèÔºåÊéßÂà∂Èõ™Ëä±ÂíåÈ¨ºËÑ∏ÊïàÊûú
    const observer = new MutationObserver(() => {
        if (mainMenu && !mainMenu.classList.contains('hidden')) {
            startScaryFaceFlicker();
            staticNoise.start();
        } else {
            stopScaryFaceFlicker();
            staticNoise.stop();
        }
    });
    
    if (mainMenu) {
        observer.observe(mainMenu, { attributes: true, attributeFilter: ['class'] });
        
        if (!mainMenu.classList.contains('hidden')) {
            startScaryFaceFlicker();
            staticNoise.start();
        }
    }
});

// ÁõëÂê¨Êù•Ëá™Áà∂È°µÈù¢ÁöÑÊ∂àÊÅØÔºàiframe ÈÄö‰ø°Ôºâ
window.addEventListener('message', (event) => {
    if (event.data.type === 'USER_CLICKED_PLAY') {
        // console.log('Êî∂Âà∞Áà∂È°µÈù¢ÁöÑÁî®Êà∑ÁÇπÂáª‰∫ã‰ª∂');
        const menuMusic = document.getElementById('menu-music');
        if (menuMusic) {
            // Á´ãÂç≥Â∞ùËØïÊí≠ÊîæÈü≥‰πê
            menuMusic.volume = 0.5;
            menuMusic.play().then(() => {
                // console.log('‚úÖ Èü≥‰πêËá™Âä®Êí≠ÊîæÊàêÂäüÔºÅ');
            }).catch(e => {
                // console.log('‚ùå Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•:', e);
                // Â¶ÇÊûúÂ§±Ë¥•ÔºåÁ≠âÂæÖÁî®Êà∑Âú®Ê∏∏ÊàèÂÜÖÁÇπÂáª
            });
        }
    }
});


// ÊÅêÊÄñËÑ∏Èó™ÁÉÅÊïàÊûú
const getBasePath = () => {
    const currentPath = window.location.pathname;
    if (currentPath.includes('/FNAE-HTML5-1.1.5/')) {
        return '/FNAE-HTML5-1.1.5/';
    }
    return './';
};

const basePath = getBasePath();
const normalBackground = `${basePath}assets/images/menubackground.png`;
const scaryBackgrounds = [
    `${basePath}assets/images/scaryhawk.png`,
    `${basePath}assets/images/scaryep.png`,
    `${basePath}assets/images/scarytrump.png`
];

let scaryFaceInterval = null;
const preloadedImages = {};

// È¢ÑÂä†ËΩΩÊâÄÊúâËÉåÊôØÂõæÁâá
function preloadBackgrounds() {
    const normalImg = new Image();
    normalImg.src = normalBackground;
    preloadedImages['normal'] = normalImg;
    
    scaryBackgrounds.forEach((bg, index) => {
        const img = new Image();
        img.src = bg;
        preloadedImages[`scary-${index}`] = img;
    });
}

function startScaryFaceFlicker() {
    if (scaryFaceInterval) {
        stopScaryFaceFlicker();
    }
    
    const mainMenu = document.getElementById('main-menu');
    if (!mainMenu) return;
    
    scaryFaceInterval = setInterval(() => {
        if (Math.random() < 0.1) {
            const bgIndex = Math.floor(Math.random() * 3);
            const scaryBg = scaryBackgrounds[bgIndex];
            
            mainMenu.style.backgroundImage = `url('${scaryBg}')`;
            
            const hideDelay = 50 + Math.random() * 150;
            setTimeout(() => {
                mainMenu.style.backgroundImage = `url('${normalBackground}')`;
            }, hideDelay);
        }
    }, 100);
}

function stopScaryFaceFlicker() {
    if (scaryFaceInterval) {
        clearInterval(scaryFaceInterval);
        scaryFaceInterval = null;
        
        const mainMenu = document.getElementById('main-menu');
        if (mainMenu) {
            mainMenu.style.backgroundImage = `url('${normalBackground}')`;
        }
    }
}


// ÈùôÊÄÅÂô™ÁÇπÊïàÊûú
class StaticNoise {
    constructor() {
        this.canvas = document.getElementById('static-canvas');
        if (!this.canvas) {
            console.error('Static canvas not found');
            return;
        }
        
        this.ctx = this.canvas.getContext('2d');
        this.isRunning = false;
        this.animationId = null;
        this.resize();
        window.addEventListener('resize', () => this.resize());
    }

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }

    start() {
        if (this.isRunning) return;
        this.isRunning = true;
        this.canvas.style.display = 'block';
        this.animate();
    }

    stop() {
        this.isRunning = false;
        this.canvas.style.display = 'none';
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
            this.animationId = null;
        }
    }

    animate() {
        if (!this.ctx || !this.isRunning) return;
        
        const width = this.canvas.width;
        const height = this.canvas.height;
        const imageData = this.ctx.createImageData(width, height);
        const data = imageData.data;

        // ÁîüÊàêÊõ¥Âº∫ÁÉàÁöÑÈöèÊú∫Âô™ÁÇπÔºàÁîµËßÜÈõ™Ëä±ÊïàÊûúÔºâ
        for (let i = 0; i < data.length; i += 4) {
            const value = Math.random() > 0.5 ? 255 : 0;
            data[i] = value;
            data[i + 1] = value;
            data[i + 2] = value;
            data[i + 3] = Math.random() * 255;
        }

        this.ctx.putImageData(imageData, 0, 0);
        this.animationId = requestAnimationFrame(() => this.animate());
    }
}


// UI Manager
class UIManager {
    constructor(game) {
        this.game = game;
        this.initElements();
    }

    initElements() {
        this.powerValue = document.getElementById('power-value');
        this.timeValue = document.getElementById('time-value');
        this.nightValue = document.getElementById('night-value');
        this.currentSceneImg = document.getElementById('current-scene');
    }

    update() {
        this.powerValue.textContent = Math.floor(this.game.state.oxygen);
        this.timeValue.textContent = `${this.game.state.currentTime === 0 ? 12 : this.game.state.currentTime} AM`;
        this.nightValue.textContent = this.game.state.currentNight;
        
        // Only update scene image when camera is not open
        if (!this.game.state.cameraOpen) {
            const sceneKey = 'office';
            if (this.game.assets.images[sceneKey]) {
                this.currentSceneImg.src = this.game.assets.images[sceneKey].src;
                this.currentSceneImg.style.display = 'block';
            }
        }
        
        // Flash warning when oxygen below 40%
        if (this.game.state.oxygen <= 40 && this.game.state.ventsClosed) {
            this.powerValue.classList.add('flicker');
        } else {
            this.powerValue.classList.remove('flicker');
        }
        
        // Update camera status
        this.updateCameraStatus();
    }

    createHotspots() {
        const hotspotsContainer = document.getElementById('hotspots');
        hotspotsContainer.innerHTML = '';
        
        // Create control panel button (special style)
        this.createControlPanelButton();
        
        // Create camera button (special style)
        this.createCameraButton();
        
        // Bind close camera button event
        this.bindCloseCameraButton();
    }

    createControlPanelButton() {
        const hotspotsContainer = document.getElementById('hotspots');
        
        const controlBtn = document.createElement('div');
        controlBtn.id = 'vents-btn';
        controlBtn.className = 'control-panel-button';
        controlBtn.style.position = 'absolute';
        controlBtn.style.left = '0';
        controlBtn.style.bottom = '0';
        controlBtn.style.width = '25vw';
        controlBtn.style.height = '10vh';
        controlBtn.style.background = 'rgba(0, 0, 0, 0.7)';
        controlBtn.style.border = '2px solid rgba(255, 255, 255, 0.3)';
        controlBtn.style.borderLeft = 'none';
        controlBtn.style.borderBottom = 'none';
        controlBtn.style.display = 'flex';
        controlBtn.style.flexDirection = 'row';
        controlBtn.style.alignItems = 'center';
        controlBtn.style.justifyContent = 'space-between';
        controlBtn.style.cursor = 'pointer';
        controlBtn.style.opacity = '0';
        controlBtn.style.transition = 'opacity 0.3s, background 0.3s';
        controlBtn.style.padding = '0 1.5vw';
        controlBtn.style.pointerEvents = 'none';
        
        // Left arrows container
        const leftArrows = document.createElement('div');
        leftArrows.style.display = 'flex';
        leftArrows.style.gap = '0.8vw';
        leftArrows.className = 'control-arrows';
        leftArrows.style.flexShrink = '0';
        
        const arrowLeft1 = document.createElement('div');
        arrowLeft1.innerHTML = '‚ñ≤';
        arrowLeft1.style.color = '#fff';
        arrowLeft1.style.fontSize = '2vw';
        arrowLeft1.style.lineHeight = '1';
        leftArrows.appendChild(arrowLeft1);
        
        const arrowLeft2 = document.createElement('div');
        arrowLeft2.innerHTML = '‚ñ≤';
        arrowLeft2.style.color = '#fff';
        arrowLeft2.style.fontSize = '2vw';
        arrowLeft2.style.lineHeight = '1';
        leftArrows.appendChild(arrowLeft2);
        
        controlBtn.appendChild(leftArrows);
        
        // CONTROL PANEL text
        const text = document.createElement('div');
        text.textContent = 'CONTROL PANEL';
        text.style.color = '#fff';
        text.style.fontSize = '1.8vw';
        text.style.fontWeight = 'bold';
        text.style.fontFamily = 'Arial, sans-serif';
        text.style.letterSpacing = '0.15vw';
        text.style.whiteSpace = 'nowrap';
        text.style.flex = '1';
        text.style.textAlign = 'center';
        controlBtn.appendChild(text);
        
        // Right arrows container
        const rightArrows = document.createElement('div');
        rightArrows.style.display = 'flex';
        rightArrows.style.gap = '0.8vw';
        rightArrows.className = 'control-arrows';
        rightArrows.style.flexShrink = '0';
        
        const arrowRight1 = document.createElement('div');
        arrowRight1.innerHTML = '‚ñ≤';
        arrowRight1.style.color = '#fff';
        arrowRight1.style.fontSize = '2vw';
        arrowRight1.style.lineHeight = '1';
        rightArrows.appendChild(arrowRight1);
        
        const arrowRight2 = document.createElement('div');
        arrowRight2.innerHTML = '‚ñ≤';
        arrowRight2.style.color = '#fff';
        arrowRight2.style.fontSize = '2vw';
        arrowRight2.style.lineHeight = '1';
        rightArrows.appendChild(arrowRight2);
        
        controlBtn.appendChild(rightArrows);
        
        // Hover effect
        controlBtn.addEventListener('mouseenter', () => {
            controlBtn.style.background = 'rgba(0, 0, 0, 0.9)';
        });
        
        controlBtn.addEventListener('mouseleave', () => {
            controlBtn.style.background = 'rgba(0, 0, 0, 0.7)';
        });
        
        // Click event - open control panel popup
        controlBtn.addEventListener('click', () => {
            this.toggleControlPanel();
            setTimeout(() => this.updateControlPanelArrows(), 50);
        });
        
        hotspotsContainer.appendChild(controlBtn);
    }

    updateControlPanelArrows() {
        const controlBtn = document.getElementById('vents-btn');
        if (!controlBtn) return;
        
        const arrows = controlBtn.querySelectorAll('.control-arrows div');
        const isOpen = document.getElementById('control-panel-popup') && 
                      !document.getElementById('control-panel-popup').classList.contains('hidden');
        
        // Before panel opens: arrows point up ‚ñ≤
        // Before panel closes: arrows point down ‚ñº
        arrows.forEach((arrow) => {
            arrow.innerHTML = isOpen ? '‚ñº' : '‚ñ≤';
        });
    }

    toggleControlPanel() {
        const panel = document.getElementById('control-panel-popup');
        if (panel) {
            const wasHidden = panel.classList.contains('hidden');
            
            // Â¶ÇÊûúË¶ÅÂÖ≥Èó≠Èù¢ÊùøÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÊìç‰ΩúÊ≠£Âú®ËøõË°å
            if (!wasHidden && this.game.state.controlPanelBusy) {
                // console.log('Cannot close control panel: operation in progress');
                return; // ÈòªÊ≠¢ÂÖ≥Èó≠Ôºå‰∏çÊòæÁ§∫‰ªª‰ΩïÊ∂àÊÅØ
            }
            
            panel.classList.toggle('hidden');
            
            // Control view rotation
            if (wasHidden) {
                // Open panel, stop rotation
                this.game.isRotatingLeft = false;
                this.game.isRotatingRight = false;
                this.game.state.controlPanelOpen = true;
            } else {
                // Close panel
                this.game.state.controlPanelOpen = false;
            }
        } else {
            this.createControlPanelPopup();
            this.game.isRotatingLeft = false;
            this.game.isRotatingRight = false;
            this.game.state.controlPanelOpen = true;
        }
    }

    createControlPanelPopup() {
        const popup = document.createElement('div');
        popup.id = 'control-panel-popup';
        popup.style.position = 'fixed';
        popup.style.top = '10vh';
        popup.style.left = '10vw';
        popup.style.width = '70vw';
        popup.style.minHeight = '60vh';
        popup.style.background = '#000';
        popup.style.border = '4px solid #0f0';
        popup.style.padding = '4vh 4vw';
        popup.style.zIndex = '100';
        popup.style.fontFamily = "'Courier New', monospace";
        popup.style.color = '#0f0';
        
        // Title
        const title = document.createElement('div');
        title.textContent = '/// Control Panel';
        title.style.fontSize = '2.5vw';
        title.style.fontWeight = 'bold';
        title.style.marginBottom = '5vh';
        popup.appendChild(title);
        
        // Options container
        const optionsContainer = document.createElement('div');
        optionsContainer.id = 'control-options';
        
        // Option 1: Air Vents
        const option1 = document.createElement('div');
        option1.id = 'option-vents';
        option1.style.fontSize = '2.5vw';
        option1.style.marginBottom = '4vh';
        option1.style.cursor = 'pointer';
        option1.style.padding = '1.5vh 0';
        option1.style.display = 'flex';
        option1.style.alignItems = 'center';
        option1.style.direction = 'ltr'; // Âº∫Âà∂‰ªéÂ∑¶Âà∞Âè≥
        option1.innerHTML = this.game.state.ventsClosed ? 
            '<span class="option-arrow" style="color: #0f0; margin-right: 1.5vw; width: 2vw;">&gt;</span><span>Open Air Vents</span><span id="vents-dots" style="margin-left: 1vw; direction: ltr; font-family: \'Courier New\', monospace;"></span>' :
            '<span class="option-arrow" style="color: #0f0; margin-right: 1.5vw; width: 2vw;">&gt;</span><span>Close Air Vents</span><span id="vents-dots" style="margin-left: 1vw; direction: ltr; font-family: \'Courier New\', monospace;"></span>';
        option1.addEventListener('click', () => {
            this.game.toggleVents();
            // ‰∏çÂú®ËøôÈáåÁ´ãÂç≥Êõ¥Êñ∞ÔºåÁ≠âtoggleVentsÂÆåÊàêÂêé‰ºöËá™Âä®Ë∞ÉÁî®updateControlPanelOptions
        });
        optionsContainer.appendChild(option1);
        
        // Option 2: Restart Cameras
        const option2 = document.createElement('div');
        option2.id = 'option-cameras';
        option2.style.fontSize = '2.5vw';
        option2.style.cursor = 'pointer';
        option2.style.padding = '1.5vh 0';
        option2.style.display = 'flex';
        option2.style.alignItems = 'center';
        option2.style.direction = 'ltr'; // Âº∫Âà∂‰ªéÂ∑¶Âà∞Âè≥
        option2.innerHTML = '<span class="option-arrow" style="color: transparent; margin-right: 1.5vw; width: 2vw;">&gt;</span><span>Restart Cameras</span><span id="camera-dots" style="margin-left: 1vw; direction: ltr; font-family: \'Courier New\', monospace;"></span><span id="camera-status" style="margin-left: auto; padding-right: 2vw; direction: ltr;"></span>';
        option2.addEventListener('click', () => {
            this.selectControlOption('cameras');
            this.handleRestartCamera();
        });
        optionsContainer.appendChild(option2);
        
        popup.appendChild(optionsContainer);
        
        // Click outside to close (only if no operation in progress)
        document.addEventListener('click', (e) => {
            if (!popup.contains(e.target) && e.target.id !== 'vents-btn' && !e.target.closest('#vents-btn')) {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊìç‰ΩúÊ≠£Âú®ËøõË°å
                if (this.game.state.controlPanelBusy) {
                    // console.log('Cannot close control panel: operation in progress');
                    return; // ÈòªÊ≠¢ÂÖ≥Èó≠Ôºå‰∏çÊòæÁ§∫‰ªª‰ΩïÊ∂àÊÅØ
                }
                
                popup.classList.add('hidden');
                this.game.state.controlPanelOpen = false;
                this.updateControlPanelArrows();
            }
        });
        
        document.body.appendChild(popup);
    }

    selectControlOption(option) {
        const option1 = document.getElementById('option-vents');
        const option2 = document.getElementById('option-cameras');
        
        if (option === 'vents') {
            const arrow1 = option1.querySelector('.option-arrow');
            const arrow2 = option2.querySelector('.option-arrow');
            if (arrow1) arrow1.style.color = '#0f0';
            if (arrow2) arrow2.style.color = 'transparent';
            
            // Êõ¥Êñ∞ÈÄöÈ£éÂè£ÊñáÊú¨Ôºà‰∏çÂåÖÊã¨dots spanÔºâ
            const text1 = option1.querySelector('span:nth-child(2)');
            if (text1) {
                text1.textContent = this.game.state.ventsClosed ? 'Open Air Vents' : 'Close Air Vents';
            }
        } else {
            const arrow1 = option1.querySelector('.option-arrow');
            const arrow2 = option2.querySelector('.option-arrow');
            if (arrow1) arrow1.style.color = 'transparent';
            if (arrow2) arrow2.style.color = '#0f0';
        }
    }

    updateControlPanelOptions() {
        this.selectControlOption('vents');
        this.updateCameraStatus();
        this.updateVentsStatus(); // Ê∑ªÂä†ÈÄöÈ£éÂè£Áä∂ÊÄÅÊõ¥Êñ∞
    }
    
    // Update vents status display (dots animation)
    updateVentsStatus() {
        const dotsSpan = document.getElementById('vents-dots');
        if (!dotsSpan) return;
        
        if (this.game.state.ventsToggling) {
            // Ê≠£Âú®ÂàáÊç¢ÔºåÊòæÁ§∫ÁÇπÂä®Áîª
            dotsSpan.style.color = '#0f0'; // Green dots
            if (!dotsSpan.dataset.animating) {
                dotsSpan.dataset.animating = 'true';
                this.animateLoadingDots(dotsSpan);
            }
        } else {
            // ‰∏çÂú®ÂàáÊç¢‰∏≠ÔºåÊ∏ÖÁ©∫ÁÇπ
            dotsSpan.textContent = '';
            delete dotsSpan.dataset.animating;
        }
    }
    
    // Update camera status display
    updateCameraStatus() {
        const statusSpan = document.getElementById('camera-status');
        const dotsSpan = document.getElementById('camera-dots');
        if (!statusSpan) return;
        
        if (this.game.state.cameraRestarting) {
            // Restarting, show dots after button
            if (dotsSpan) {
                dotsSpan.style.color = '#0f0'; // Green dots
                if (!dotsSpan.dataset.animating) {
                    dotsSpan.dataset.animating = 'true';
                    this.animateLoadingDots(dotsSpan);
                }
            }
            // Âè™ÊúâÂú®ÊëÑÂÉèÂ§¥Á°ÆÂÆûÊïÖÈöúÊó∂ÊâçÊòæÁ§∫ERR
            if (this.game.state.cameraFailed) {
                statusSpan.style.color = '#f00';
                statusSpan.textContent = 'ERR';
            } else {
                // Ê≤°ÊúâÊïÖÈöúÊó∂ÔºåÈáçÂêØÊúüÈó¥‰∏çÊòæÁ§∫ERR
                statusSpan.textContent = '';
            }
        } else if (this.game.state.cameraFailed) {
            // Failed, show ERR on right, no dots
            if (dotsSpan) {
                dotsSpan.textContent = '';
                delete dotsSpan.dataset.animating;
            }
            statusSpan.style.color = '#f00';
            statusSpan.textContent = 'ERR';
        } else {
            // Normal, don't show anything
            if (dotsSpan) {
                dotsSpan.textContent = '';
                delete dotsSpan.dataset.animating;
            }
            statusSpan.textContent = '';
        }
    }
    
    // Animate loading dots (green dots after button)
    animateLoadingDots(element) {
        const states = ['.', '..', '...'];
        let index = 0;
        
        const animate = () => {
            if (!element.dataset.animating) return;
            
            element.textContent = states[index];
            // console.log('Dots animation:', states[index]); // Ë∞ÉËØïËæìÂá∫
            index = (index + 1) % states.length;
            
            setTimeout(animate, 500); // Switch every 0.5s
        };
        
        animate();
    }
    
    // Animate display (dots after button, ERR on right) - ‰∏çÂÜç‰ΩøÁî®
    animateLoadingDotsWithERR(element) {
        // Â∑≤Â∫üÂºÉÔºå‰ΩøÁî® animateLoadingDots ‰ª£Êõø
    }
    
    // Handle restart camera
    handleRestartCamera() {
        // ÂÖÅËÆ∏Âú®ÊëÑÂÉèÂ§¥Ê≤°ÊúâÊïÖÈöúÊó∂‰πüËÉΩÈáçÂêØÔºà‰Ωú‰∏∫Á≠ñÁï•‰ΩøÁî®Ôºâ
        if (!this.game.state.cameraRestarting && !this.game.state.controlPanelBusy) {
            // console.log('Restarting cameras...');
            this.game.camera.restartCamera();
            
            // Immediately update status display (show loading animation, but ERR doesn't disappear)
            this.updateCameraStatus();
            
            // Update status display every 100ms
            const updateInterval = setInterval(() => {
                this.updateCameraStatus();
                if (!this.game.state.cameraRestarting) {
                    clearInterval(updateInterval);
                }
            }, 100);
        }
    }

    createCameraButton() {
        const hotspotsContainer = document.getElementById('hotspots');
        
        const cameraBtn = document.createElement('div');
        cameraBtn.id = 'camera-btn';
        cameraBtn.className = 'camera-button';
        cameraBtn.style.position = 'absolute';
        cameraBtn.style.right = '0';
        cameraBtn.style.top = '25%';
        cameraBtn.style.width = '6vw';
        cameraBtn.style.height = '45vh';
        cameraBtn.style.background = 'rgba(0, 0, 0, 0.7)';
        cameraBtn.style.border = '2px solid rgba(255, 255, 255, 0.3)';
        cameraBtn.style.borderRight = 'none';
        cameraBtn.style.display = 'flex';
        cameraBtn.style.flexDirection = 'column';
        cameraBtn.style.alignItems = 'center';
        cameraBtn.style.justifyContent = 'space-between';
        cameraBtn.style.cursor = 'pointer';
        cameraBtn.style.opacity = '0';
        cameraBtn.style.transition = 'opacity 0.3s, background 0.3s';
        cameraBtn.style.padding = '2vh 0';
        cameraBtn.style.pointerEvents = 'none';
        
        // Top arrows container
        const topArrows = document.createElement('div');
        topArrows.style.display = 'flex';
        topArrows.style.flexDirection = 'column';
        topArrows.style.gap = '0.5vh';
        
        // Top arrow (points left when closed)
        const arrowTop = document.createElement('div');
        arrowTop.innerHTML = '‚óÑ';
        arrowTop.className = 'camera-arrow';
        arrowTop.style.color = '#fff';
        arrowTop.style.fontSize = '1.8vw';
        arrowTop.style.transform = 'rotate(0deg)';
        arrowTop.style.lineHeight = '1';
        topArrows.appendChild(arrowTop);
        
        // Second arrow
        const arrowTop2 = document.createElement('div');
        arrowTop2.innerHTML = '‚óÑ';
        arrowTop2.className = 'camera-arrow';
        arrowTop2.style.color = '#fff';
        arrowTop2.style.fontSize = '1.8vw';
        arrowTop2.style.transform = 'rotate(0deg)';
        arrowTop2.style.lineHeight = '1';
        topArrows.appendChild(arrowTop2);
        
        cameraBtn.appendChild(topArrows);
        
        // CAMERA text (horizontal text rotated 90 degrees counterclockwise)
        const text = document.createElement('div');
        text.textContent = 'CAMERA';
        text.style.color = '#fff';
        text.style.fontSize = '1.3vw';
        text.style.fontWeight = 'bold';
        text.style.fontFamily = 'Arial, sans-serif';
        text.style.transform = 'rotate(-90deg)';
        text.style.letterSpacing = '0.2vw';
        text.style.whiteSpace = 'nowrap';
        cameraBtn.appendChild(text);
        
        // Bottom arrows container
        const bottomArrows = document.createElement('div');
        bottomArrows.style.display = 'flex';
        bottomArrows.style.flexDirection = 'column';
        bottomArrows.style.gap = '0.5vh';
        
        // Bottom arrow
        const arrowBottom = document.createElement('div');
        arrowBottom.innerHTML = '‚óÑ';
        arrowBottom.className = 'camera-arrow';
        arrowBottom.style.color = '#fff';
        arrowBottom.style.fontSize = '1.8vw';
        arrowBottom.style.transform = 'rotate(0deg)';
        arrowBottom.style.lineHeight = '1';
        bottomArrows.appendChild(arrowBottom);
        
        // Second bottom arrow
        const arrowBottom2 = document.createElement('div');
        arrowBottom2.innerHTML = '‚óÑ';
        arrowBottom2.className = 'camera-arrow';
        arrowBottom2.style.color = '#fff';
        arrowBottom2.style.fontSize = '1.8vw';
        arrowBottom2.style.transform = 'rotate(0deg)';
        arrowBottom2.style.lineHeight = '1';
        bottomArrows.appendChild(arrowBottom2);
        
        cameraBtn.appendChild(bottomArrows);
        
        // Hover effect
        cameraBtn.addEventListener('mouseenter', () => {
            cameraBtn.style.background = 'rgba(0, 0, 0, 0.9)';
        });
        
        cameraBtn.addEventListener('mouseleave', () => {
            cameraBtn.style.background = 'rgba(0, 0, 0, 0.7)';
        });
        
        // Click event
        cameraBtn.addEventListener('click', () => {
            // console.log('üì∑ Camera button clicked!');
            this.game.toggleCamera();
            // Delay arrow update, wait for state change
            setTimeout(() => this.updateCameraButtonArrows(), 50);
        });
        
        hotspotsContainer.appendChild(cameraBtn);
    }

    bindCloseCameraButton() {
        // Close button removed - camera button is now always accessible
    }

    updateCameraButtonArrows() {
        const cameraBtn = document.getElementById('camera-btn');
        if (!cameraBtn) return;
        
        const arrows = cameraBtn.querySelectorAll('.camera-arrow');
        const isOpen = this.game.state.cameraOpen;
        
        // Update arrow direction
        // Before opening (closed state): arrows point left (0deg)
        // Before closing (open state): arrows point right (180deg)
        arrows.forEach((arrow) => {
            arrow.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        });
    }

    updateHotspotVisibility(viewPosition) {
        const ventsBtn = document.getElementById('vents-btn');
        const cameraBtn = document.getElementById('camera-btn');
        
        // console.log('üîç updateHotspotVisibility - viewPosition:', viewPosition);
        
        // Show control panel when view is at far left (viewPosition = 0)
        if (ventsBtn) {
            ventsBtn.style.opacity = viewPosition < 0.15 ? '1' : '0';
            ventsBtn.style.pointerEvents = viewPosition < 0.15 ? 'auto' : 'none';
        }
        
        // Show camera button when view is at far right (viewPosition = 1)
        if (cameraBtn) {
            const isVisible = viewPosition > 0.85;
            cameraBtn.style.opacity = isVisible ? '1' : '0';
            cameraBtn.style.pointerEvents = isVisible ? 'auto' : 'none';
            // console.log('üì∑ Camera button - opacity:', cameraBtn.style.opacity, 'pointerEvents:', cameraBtn.style.pointerEvents);
        }
    }

    showTooltip(event, text) {
        let tooltip = document.getElementById('game-tooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'game-tooltip';
            tooltip.style.position = 'fixed';
            tooltip.style.background = 'rgba(0, 0, 0, 0.8)';
            tooltip.style.color = 'white';
            tooltip.style.padding = '8px 12px';
            tooltip.style.borderRadius = '4px';
            tooltip.style.fontSize = '14px';
            tooltip.style.pointerEvents = 'none';
            tooltip.style.zIndex = '10000';
            tooltip.style.whiteSpace = 'nowrap';
            document.body.appendChild(tooltip);
        }
        
        tooltip.textContent = text;
        tooltip.style.display = 'block';
        tooltip.style.left = event.clientX + 10 + 'px';
        tooltip.style.top = event.clientY + 10 + 'px';
    }

    hideTooltip() {
        const tooltip = document.getElementById('game-tooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }

    updateViewPosition(viewPosition) {
        const offset = -viewPosition * 50;
        this.currentSceneImg.style.left = `${offset}%`;
        this.updateHotspotVisibility(viewPosition);
    }
}

</script>
</body>
</html>
